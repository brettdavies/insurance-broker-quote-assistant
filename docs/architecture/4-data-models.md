# 4. Data Models

**Type Definition Strategy:**

- **All types defined as Zod schemas** in `packages/shared/src/schemas/`
- **TypeScript types inferred** via `z.infer<typeof schema>`
- **Naming conventions:**
  - TypeScript/JavaScript: `camelCase` (e.g., `productType`, `cleanRecord3Yr`)
  - API/JSON boundaries: `snake_case` (e.g., `product_type`, `clean_record_3yr`)
  - Automatic transformation at API boundaries (see Section 17.2: Naming Conventions)

**Cross-Reference:** See Section 17.2 for complete naming standards and transformation rules.

---

## 4.1 Core Data Models Overview

**Directory Structure:**

- **Zod schemas** → `packages/shared/src/schemas/` (runtime validation + TypeScript inference)
- **TypeScript types and error codes** → `packages/shared/src/types/` (type definitions, error enums)

**Why This Separation:**

- **Schemas** are runtime validators that also generate TypeScript types via `z.infer<typeof schema>`
- **Types** are compile-time only (error codes, utility types, constants)
- Keeps schema files focused on data validation, type files focused on type definitions

| Model                    | Location                       | Purpose                                             | Storage                                    |
| ------------------------ | ------------------------------ | --------------------------------------------------- | ------------------------------------------ |
| **UserProfile**          | `packages/shared/src/schemas/` | Insurance shopper information from intake or policy | API response, in-memory during flow        |
| **Carrier**              | `knowledge_pack/carriers/`     | Carrier rules, eligibility, discounts, compensation | JSON files (loaded at startup by RAG)      |
| **Opportunity**          | `packages/shared/src/schemas/` | Savings opportunity with citation                   | API response, generated by Discount Engine |
| **IntakeRequest**         | `packages/shared/src/schemas/` | Conversational intake request with known/suppressed fields | API request                               |
| **IntakeResult**         | `packages/shared/src/schemas/` | Complete conversational intake output               | API response                               |
| **PolicyAnalysisResult** | `packages/shared/src/schemas/` | Complete policy analysis output                     | API response                               |
| **PrefillPacket**        | `packages/shared/src/schemas/` | IQuote Pro pre-fill data for broker                 | API response, part of IntakeResult         |
| **DecisionTrace**        | `packages/shared/src/schemas/` | Audit trail for compliance logging                  | Compliance log file                        |
| **InferenceRule**        | `packages/shared/src/schemas/` | Field-to-field inference rule definition            | In-memory config, part of unified-field-metadata |
| **TextPatternInference** | `packages/shared/src/config/` | Text pattern-based inference rule definition        | In-memory config, loaded at startup        |
| **SuppressionManager**   | `apps/web/src/lib/`            | Session-scoped suppression list manager (frontend)  | In-memory state (session-scoped)           |

---

## 4.2 UserProfile

**Purpose:** Represents insurance shopper information collected during conversational intake or extracted from existing policy.

**Schema Location:** `packages/shared/src/schemas/user-profile.ts`

**Key Fields:**

- `state` - US state code (required for routing)
- `productType` - Insurance product type (`'auto' | 'home' | 'renters' | 'umbrella'`)
- `age` - Optional, used for age-based eligibility and discounts
- `householdSize` - Optional, affects bundle discounts
- `vehicles` - Optional, required for auto insurance routing
- `ownsHome` - Optional, determines bundle eligibility
- `cleanRecord3Yr` - Optional, qualifies for safe driver discounts
- `currentCarrier` - Optional, used in policy analysis flow
- `premiums` - Optional, current premiums object with `annual`, `monthly`, `semiAnnual` fields (used for savings calculations)
- `existingPolicies` - **Required for bundle discount analysis**, optional otherwise. Array of other products user currently has for multi-carrier consolidation analysis (e.g., `[{ product: 'home', carrier: 'State Farm', premium: 800 }, { product: 'auto', carrier: 'GEICO', premium: 1200 }]`). Carrier IDs must match knowledge pack carrier names.

**Design Decisions:**

- **Progressive disclosure:** Most fields optional to support conversational intake (extract what's mentioned, flag missing fields)
- **Flat structure for core fields:** Single-level fields for easier LLM extraction with structured outputs
- **existingPolicies array for bundle analysis:** Tracks multi-carrier household coverage to identify consolidation opportunities (e.g., auto with GEICO + home with State Farm → both to GEICO for 15% multi-policy discount). Without this data, Discount Engine cannot identify multi-carrier consolidation savings. See Section 17.3 for implementation guidance.

---

## 4.3 Carrier

**Purpose:** Insurance carrier data including operating states, products, eligibility rules, discounts, and broker compensation.

**Schema Location:** `knowledge_pack/carriers/{carrier-name}.json` (e.g., `geico.json`)

**Key Fields:**

- `name` - Carrier name ("GEICO", "Progressive", "State Farm")
- `operatesIn` - Array of state codes where carrier operates
- `products` - Available product lines (auto, home, renters, umbrella)
- `eligibility` - Product-specific eligibility criteria (age limits, license requirements, vehicle limits)
- `discounts` - Available discounts with requirements and percentages
- `compensation` - Optional broker commission percentage and notes

**Design Decisions:**

- **Compensation field included:** Helps broker prioritize carriers with better commission rates (business reality)
- **Eligibility by product:** Different products have different underwriting rules
- **cuid2-based IDs:** All entities use globally unique cuid2 IDs for citation tracking (see `docs/knowledge-pack/id-conventions.md`)

---

## 4.4 Opportunity

**Purpose:** Savings opportunity identified by Discount Engine with mandatory citation for regulatory compliance.

**Schema Location:** `packages/shared/src/schemas/opportunity.ts`

**Key Fields:**

- `discount` - Discount name
- `percentage` - Savings percentage
- `annualSavings` - Dollar amount saved per year
- `requires` - Array of qualification requirements
- `citation` - Object with cuid2 ID, entity type, parent carrier ID, and source file from knowledge pack

**Design Decisions:**

- **Citation required:** Insurance regulations mandate traceability of all recommendations to source material
- **Dollar savings calculated:** Converts percentage to dollars using current premium for clarity

---

## 4.5 IntakeRequest

**Purpose:** Request schema for conversational intake flow, includes user message, known fields from pills, and suppressed fields list.

**Schema Location:** `packages/shared/src/schemas/intake-result.ts`

**Key Fields:**

- `message` (string, required) - User's conversational input text
- `pills` (Partial<UserProfile>, optional) - Known fields extracted from lexical editor pills (broker-curated, read-only for LLM)
- `suppressedFields` (string[], optional) - Fields broker has explicitly dismissed (never re-infer)

**Design Decisions:**

- **Known vs inferred separation:** `pills` represent broker-curated known fields (high confidence, read-only)
- **Suppression list:** Prevents re-inferring dismissed fields (broker has final say)
- **Progressive enhancement:** Both `pills` and `suppressedFields` optional for backward compatibility (first request has no pills)

**Known vs Inferred Architecture:**

The intake flow distinguishes between:
- **Known fields:** Explicitly extracted from user input (deterministic patterns or high-confidence LLM extraction ≥85%)
- **Inferred fields:** Derived from known fields or text patterns via InferenceEngine (lower confidence <85%, broker can dismiss)

This separation improves extraction accuracy from ~60% to ~85%+ by:
1. **Transparency:** Broker sees what's explicit vs inferred
2. **Control:** Broker can dismiss incorrect inferences
3. **Accuracy:** LLM receives more context (inferred fields guide extraction)
4. **Efficiency:** Deterministic rules are instant and free (no LLM tokens)

---

## 4.6 IntakeResult

**Purpose:** Complete output from conversational intake flow, ready for broker to finalize quote.

**Schema Location:** `packages/shared/src/schemas/intake-result.ts`

**Key Fields:**

- `profile` - Extracted UserProfile (DEPRECATED: Use `extraction.known` + `extraction.inferred` instead, kept for backward compatibility)
- `extraction` - ExtractionResult object with known/inferred field separation (Epic 4)
- `missingFields` - Array of field names still needed for complete quote
- `route` - RouteDecision with primary carrier and alternatives
- `opportunities` - Array of Opportunity objects with savings
- `prefill` - PrefillPacket for IQuote Pro handoff
- `pitch` - Agent-ready savings pitch (string with markdown)
- `complianceValidated` - Boolean indicating compliance filter passed
- `trace` - DecisionTrace for audit logging

**Extraction Object Structure (Epic 4):**

```typescript
extraction: {
  method: 'key-value' | 'llm',           // Extraction method used
  known: Partial<UserProfile>,            // Known fields (high confidence ≥85% or broker-set)
  inferred: Partial<UserProfile>,        // Inferred fields (confidence <85%)
  suppressedFields: string[],            // Fields broker dismissed
  inferenceReasons: Record<string, string>, // Reasoning for each inferred field
  confidence: Record<string, number>     // Field-level confidence scores (0-1)
}
```

**Design Decisions:**

- **Known vs inferred separation:** Enables broker curation workflow (dismiss or convert inferred → known)
- **Missing fields explicit:** Enables progressive disclosure UI (collect more info as needed)
- **Trace included:** Every interaction logged for PEAK6 evaluation harness
- **Backward compatibility:** `profile` field retained for existing clients, new clients use `extraction` object

---

## 4.7 PolicyAnalysisResult

**Purpose:** Complete output from policy analysis flow, identifying savings opportunities from existing policy.

**Schema Location:** `packages/shared/src/schemas/policy-analysis-result.ts`

**Key Fields:**

- `currentPolicy` - PolicySummary (parsed from uploaded policy)
- `opportunities` - Array of missing discounts customer qualifies for
- `bundleOptions` - Additional products that provide bundle discounts
- `deductibleOptimizations` - Suggested deductible changes with premium impact
- `pitch` - Agent-ready talking points with "because" rationales
- `complianceValidated` - Boolean indicating compliance filter passed
- `trace` - DecisionTrace for audit logging

**Design Decisions:**

- **Three opportunity types:** Missing discounts, bundles, and deductible trade-offs (comprehensive savings analysis)
- **Premium impact calculated:** Shows actual dollar impact of deductible changes for informed decisions

---

## 4.7 PrefillPacket

**Purpose:** IQuote Pro pre-fill data structure for broker handoff, contains all information needed to start quote in IQuote Pro system.

**Schema Location:** `packages/shared/src/schemas/prefill-packet.ts`

**Key Field Categories:**

**Contact Information:**

- `fullName`, `email`, `phone`, `address` - Customer contact details

**Quote Essentials:**

- `state` - Required for rating
- `productType` - Insurance type
- `carrier` - Primary recommendation from routing

**Product-Specific Data:**

- Auto: `vehicles`, `drivers`, `primaryUse`, `annualMileage`
- Home: `homeValue`, `yearBuilt`, `constructionType`, `squareFeet`
- Renters: `personalProperty`, `liability`

**Routing & Agent Notes:**

- `routingDecision` - String explanation of why this carrier was chosen
- `agentNotes` - Array of talking points and observations
- `missingFields` - Fields broker needs to collect
- `eligibleCarriers` - Alternative carriers if primary doesn't work out

**Compliance:**

- `disclaimers` - Array of required disclaimer text
- `reviewedByLicensedAgent` - Always `false` (requires broker review)
- `generatedAt` - Timestamp for record-keeping

**Design Decisions:**

- **Documented stub approach:** ~50 fields covering common scenarios, extensible for additional products
- **Broker-centric:** Includes context (routing rationale, alternatives) not just data
- **Compliance built-in:** Disclaimers and review flag ensure regulatory requirements met

---

## 4.8 DecisionTrace

**Purpose:** Complete audit trail of decision-making process for compliance logging and PEAK6 evaluation.

**Schema Location:** `packages/shared/src/schemas/decision-trace.ts`

**Key Fields:**

- `timestamp` - ISO 8601 timestamp
- `flow` - Flow type (`'conversational' | 'policy'`)
- `inputs` - Raw inputs received (message, policy text, etc.)
- `extraction` - LLM extraction result
- `routingDecision` - Routing Engine output with eligible carriers and citations
- `discountCalculations` - Discount Engine results with citations
- `complianceCheck` - Compliance Filter results (violations caught, disclaimers added)
- `llmCalls` - Array of LLM API calls with agent name, model, and token counts
- `rulesConsulted` - Knowledge pack files queried with cuid2 IDs referenced
- `outputs` - Final outputs sent to user

**Design Decisions:**

- **Written to compliance log only:** Sensitive decision rationale not exposed in program logs
- **Complete traceability:** Every decision traceable to specific knowledge pack rules and LLM calls for regulatory audit

---

## 4.9 InferenceRule

**Purpose:** Defines field-to-field inference rules that deterministically derive one field's value from another field's value.

**Schema Location:** `packages/shared/src/schemas/unified-field-metadata.ts`

**Key Fields:**

- `targetField` (string) - Field name to infer (e.g., "ownsHome", "householdSize")
- `inferValue` (function) - Function to compute inferred value from source field value
- `confidence` ('high' | 'medium' | 'low') - Confidence level for this inference
- `reasoning` (string) - Human-readable explanation shown in UI tooltip

**Usage Example:**

```typescript
{
  targetField: 'ownsHome',
  inferValue: (productType) => {
    if (productType === 'renters') return false  // Renters don't own
    if (productType === 'home') return true        // Home insurance requires ownership
    return undefined                              // No inference for other products
  },
  confidence: 'high',
  reasoning: 'Renters insurance implies tenant status; home insurance implies ownership'
}
```

**Design Decisions:**

- **Deterministic inference:** Pure functions, no LLM tokens required (instant, free)
- **Higher confidence than text patterns:** Field-to-field inferences run first (structured data more reliable)
- **Part of unified field metadata:** Inference rules defined alongside field definitions (single source of truth)

**Architecture Context:**

Part of the "known vs inferred pills" architecture (Epic 4: Field Extraction Bulletproofing). Field-to-field inferences complement text pattern inferences to improve extraction accuracy from ~60% to ~85%+.

---

## 4.10 TextPatternInference

**Purpose:** Defines pattern-based inference rules that derive field values from natural language text patterns in user input.

**Schema Location:** `packages/shared/src/config/text-pattern-inferences.ts`

**Key Fields:**

- `pattern` (RegExp) - Regular expression pattern to match in user input text
- `infers` (array) - Array of field inferences to apply when pattern matches
  - `field` (string) - Target field name to infer
  - `value` (any) - Value to infer (literal or capture group reference "$N")
  - `confidence` ('high' | 'medium' | 'low') - Confidence level
  - `reasoning` (string) - Human-readable explanation

**Usage Example:**

```typescript
{
  pattern: /\blives?\s+alone\b/i,
  infers: [
    {
      field: 'householdSize',
      value: 1,
      confidence: 'medium',
      reasoning: "Pattern 'lives alone' strongly suggests single-person household"
    }
  ]
}
```

**Capture Group References:**

Use "$N" syntax to reference regex capture groups:

```typescript
{
  pattern: /\bfamily\s+of\s+(\d+)\b/i,
  infers: [{
    field: 'householdSize',
    value: "$1",  // Resolved to capture group 1 value
    confidence: 'high',
    reasoning: "Pattern 'family of N' explicitly states household size"
  }]
}
```

**Design Decisions:**

- **Lower confidence than field-to-field:** Text patterns run second (natural language less reliable)
- **Pattern matching:** Uses regex for flexible text matching (case-insensitive)
- **Capture groups:** Supports dynamic value extraction from text (e.g., numbers, names)

**Architecture Context:**

Part of the "known vs inferred pills" architecture (Epic 4: Field Extraction Bulletproofing). Text pattern inferences complement field-to-field inferences to improve extraction accuracy.

---

## 4.11 SuppressionManager

**Purpose:** Session-scoped suppression list manager for tracking broker-dismissed inferred fields.

**Location:** `apps/web/src/lib/suppression-manager.ts`

**Key Methods:**

- `addSuppression(fieldName: string)` - Add field to suppression list
- `removeSuppression(fieldName: string)` - Remove field from suppression list
- `isSuppressed(fieldName: string)` - Check if field is suppressed
- `getAll()` - Get all suppressed fields (copy)
- `clear()` - Clear all suppressed fields

**Lifecycle:**

- **Created:** Empty array on session start
- **Updated:** When broker clicks [✕] or [Delete] on inferred field
- **Cleared:** On `/reset` command or page refresh
- **Override:** Converting inferred → known removes field from suppression list

**Design Decisions:**

- **Session-scoped only:** No localStorage, no database persistence (resets on refresh)
- **Prevents re-inference:** Suppressed fields never re-inferred in subsequent API calls
- **Broker control:** Broker has final say on which inferences to accept
- **Frontend-only:** Suppression list sent to backend in API request, not stored server-side

**Architecture Context:**

Part of the "known vs inferred pills" architecture (Epic 4: Field Extraction Bulletproofing). Enables broker curation workflow where broker can dismiss incorrect inferences, preventing them from reappearing.

---
