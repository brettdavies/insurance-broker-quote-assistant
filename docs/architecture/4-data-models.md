# 4. Data Models

**Type Definition Strategy:**
- **All types defined as Zod schemas** in `packages/shared/src/schemas/`
- **TypeScript types inferred** via `z.infer<typeof schema>`
- **Naming conventions:**
  - TypeScript/JavaScript: `camelCase` (e.g., `productLine`, `cleanRecord3Yr`)
  - API/JSON boundaries: `snake_case` (e.g., `product_line`, `clean_record_3yr`)
  - Automatic transformation at API boundaries (see Section 17.2: Naming Conventions)

**Cross-Reference:** See Section 17.2 for complete naming standards and transformation rules.

---

## 4.1 Core Data Models Overview

**Directory Structure:**
- **Zod schemas** → `packages/shared/src/schemas/` (runtime validation + TypeScript inference)
- **TypeScript types and error codes** → `packages/shared/src/types/` (type definitions, error enums)

**Why This Separation:**
- **Schemas** are runtime validators that also generate TypeScript types via `z.infer<typeof schema>`
- **Types** are compile-time only (error codes, utility types, constants)
- Keeps schema files focused on data validation, type files focused on type definitions

| Model | Location | Purpose | Storage |
|-------|----------|---------|---------|
| **UserProfile** | `packages/shared/src/schemas/` | Insurance shopper information from intake or policy | API response, in-memory during flow |
| **Carrier** | `knowledge_pack/carriers/` | Carrier rules, eligibility, discounts, compensation | JSON files (loaded at startup by RAG) |
| **Opportunity** | `packages/shared/src/schemas/` | Savings opportunity with citation | API response, generated by Discount Engine |
| **IntakeResult** | `packages/shared/src/schemas/` | Complete conversational intake output | API response |
| **PolicyAnalysisResult** | `packages/shared/src/schemas/` | Complete policy analysis output | API response |
| **PrefillPacket** | `packages/shared/src/schemas/` | IQuote Pro pre-fill data for broker | API response, part of IntakeResult |
| **DecisionTrace** | `packages/shared/src/schemas/` | Audit trail for compliance logging | Compliance log file |

---

## 4.2 UserProfile

**Purpose:** Represents insurance shopper information collected during conversational intake or extracted from existing policy.

**Schema Location:** `packages/shared/src/schemas/user-profile.ts`

**Key Fields:**
- `state` - US state code (required for routing)
- `productLine` - Insurance product type (`'auto' | 'home' | 'renters' | 'umbrella'`)
- `age` - Optional, used for age-based eligibility and discounts
- `householdSize` - Optional, affects bundle discounts
- `vehicles` - Optional, required for auto insurance routing
- `ownsHome` - Optional, determines bundle eligibility
- `cleanRecord3Yr` - Optional, qualifies for safe driver discounts
- `currentCarrier` - Optional, used in policy analysis flow
- `currentPremium` - Optional, calculates savings in policy analysis
- `existingPolicies` - **Required for bundle discount analysis**, optional otherwise. Array of other products user currently has for multi-carrier consolidation analysis (e.g., `[{ product: 'home', carrier: 'State Farm', premium: 800 }, { product: 'auto', carrier: 'GEICO', premium: 1200 }]`). Carrier IDs must match knowledge pack carrier names.

**Design Decisions:**
- **Progressive disclosure:** Most fields optional to support conversational intake (extract what's mentioned, flag missing fields)
- **Flat structure for core fields:** Single-level fields for easier LLM extraction with structured outputs
- **existingPolicies array for bundle analysis:** Tracks multi-carrier household coverage to identify consolidation opportunities (e.g., auto with GEICO + home with State Farm → both to GEICO for 15% multi-policy discount). Without this data, Discount Engine cannot identify multi-carrier consolidation savings. See Section 17.3 for implementation guidance.

---

## 4.3 Carrier

**Purpose:** Insurance carrier data including operating states, products, eligibility rules, discounts, and broker compensation.

**Schema Location:** `knowledge_pack/carriers/{carrier-name}.json` (e.g., `geico.json`)

**Key Fields:**
- `name` - Carrier name ("GEICO", "Progressive", "State Farm")
- `operatesIn` - Array of state codes where carrier operates
- `products` - Available product lines (auto, home, renters, umbrella)
- `eligibility` - Product-specific eligibility criteria (age limits, license requirements, vehicle limits)
- `discounts` - Available discounts with requirements and percentages
- `compensation` - Optional broker commission percentage and notes

**Design Decisions:**
- **Compensation field included:** Helps broker prioritize carriers with better commission rates (business reality)
- **Eligibility by product:** Different products have different underwriting rules
- **cuid2-based IDs:** All entities use globally unique cuid2 IDs for citation tracking (see `docs/knowledge-pack/id-conventions.md`)

---

## 4.4 Opportunity

**Purpose:** Savings opportunity identified by Discount Engine with mandatory citation for regulatory compliance.

**Schema Location:** `packages/shared/src/schemas/opportunity.ts`

**Key Fields:**
- `discount` - Discount name
- `percentage` - Savings percentage
- `annualSavings` - Dollar amount saved per year
- `requires` - Array of qualification requirements
- `citation` - Object with cuid2 ID, entity type, parent carrier ID, and source file from knowledge pack

**Design Decisions:**
- **Citation required:** Insurance regulations mandate traceability of all recommendations to source material
- **Dollar savings calculated:** Converts percentage to dollars using current premium for clarity

---

## 4.5 IntakeResult

**Purpose:** Complete output from conversational intake flow, ready for broker to finalize quote.

**Schema Location:** `packages/shared/src/schemas/intake-result.ts`

**Key Fields:**
- `profile` - Extracted UserProfile
- `missingFields` - Array of field names still needed for complete quote
- `route` - RouteDecision with primary carrier and alternatives
- `opportunities` - Array of Opportunity objects with savings
- `prefill` - PrefillPacket for IQuote Pro handoff
- `pitch` - Agent-ready savings pitch (string with markdown)
- `complianceValidated` - Boolean indicating compliance filter passed
- `trace` - DecisionTrace for audit logging

**Design Decisions:**
- **Missing fields explicit:** Enables progressive disclosure UI (collect more info as needed)
- **Trace included:** Every interaction logged for PEAK6 evaluation harness

---

## 4.6 PolicyAnalysisResult

**Purpose:** Complete output from policy analysis flow, identifying savings opportunities from existing policy.

**Schema Location:** `packages/shared/src/schemas/policy-analysis-result.ts`

**Key Fields:**
- `currentPolicy` - PolicySummary (parsed from uploaded policy)
- `opportunities` - Array of missing discounts customer qualifies for
- `bundleOptions` - Additional products that provide bundle discounts
- `deductibleOptimizations` - Suggested deductible changes with premium impact
- `pitch` - Agent-ready talking points with "because" rationales
- `complianceValidated` - Boolean indicating compliance filter passed
- `trace` - DecisionTrace for audit logging

**Design Decisions:**
- **Three opportunity types:** Missing discounts, bundles, and deductible trade-offs (comprehensive savings analysis)
- **Premium impact calculated:** Shows actual dollar impact of deductible changes for informed decisions

---

## 4.7 PrefillPacket

**Purpose:** IQuote Pro pre-fill data structure for broker handoff, contains all information needed to start quote in IQuote Pro system.

**Schema Location:** `packages/shared/src/schemas/prefill-packet.ts`

**Key Field Categories:**

**Contact Information:**
- `fullName`, `email`, `phone`, `address` - Customer contact details

**Quote Essentials:**
- `state` - Required for rating
- `productLine` - Insurance type
- `carrier` - Primary recommendation from routing

**Product-Specific Data:**
- Auto: `vehicles`, `drivers`, `primaryUse`, `annualMileage`
- Home: `homeValue`, `yearBuilt`, `constructionType`, `squareFeet`
- Renters: `personalProperty`, `liability`

**Routing & Agent Notes:**
- `routingDecision` - String explanation of why this carrier was chosen
- `agentNotes` - Array of talking points and observations
- `missingFields` - Fields broker needs to collect
- `eligibleCarriers` - Alternative carriers if primary doesn't work out

**Compliance:**
- `disclaimers` - Array of required disclaimer text
- `reviewedByLicensedAgent` - Always `false` (requires broker review)
- `generatedAt` - Timestamp for record-keeping

**Design Decisions:**
- **Documented stub approach:** ~50 fields covering common scenarios, extensible for additional products
- **Broker-centric:** Includes context (routing rationale, alternatives) not just data
- **Compliance built-in:** Disclaimers and review flag ensure regulatory requirements met

---

## 4.8 DecisionTrace

**Purpose:** Complete audit trail of decision-making process for compliance logging and PEAK6 evaluation.

**Schema Location:** `packages/shared/src/schemas/decision-trace.ts`

**Key Fields:**
- `timestamp` - ISO 8601 timestamp
- `flow` - Flow type (`'conversational' | 'policy'`)
- `inputs` - Raw inputs received (message, policy text, etc.)
- `extraction` - LLM extraction result
- `routingDecision` - Routing Engine output with eligible carriers and citations
- `discountCalculations` - Discount Engine results with citations
- `complianceCheck` - Compliance Filter results (violations caught, disclaimers added)
- `llmCalls` - Array of LLM API calls with agent name, model, and token counts
- `rulesConsulted` - Knowledge pack files queried with cuid2 IDs referenced
- `outputs` - Final outputs sent to user

**Design Decisions:**
- **Written to compliance log only:** Sensitive decision rationale not exposed in program logs
- **Complete traceability:** Every decision traceable to specific knowledge pack rules and LLM calls for regulatory audit

---
