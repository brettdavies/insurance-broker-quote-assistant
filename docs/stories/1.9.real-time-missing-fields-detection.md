# Story 1.9: Real-Time Missing Fields Detection & Visual Indicators

## Status
Ready to Implement

## Story
**As a** broker,  
**I want** to see exactly which fields are still needed at any moment,  
**so that** I can efficiently gather missing information from the client without system prompts.

## Acceptance Criteria

1. System maintains checklist of required fields per product type (Auto: drivers/vehicles/vin, Home: property details/construction, Renters: unit info/belongings, Umbrella: existing policies)
2. Missing fields calculated in real-time on frontend when pills are added, removed, or edited in the notes textbox (no API call required)
3. Missing fields displayed in sidebar with visual priority: Critical (red), Important (yellow), Optional (gray)
4. Completeness percentage displayed with progress bar (e.g., "8/12 fields - 67% complete")
5. No auto-generated questions or prompts - system only shows what's missing, trusts broker to ask appropriate questions
6. Field requirements adapt based on discovered state and carrier (different carriers require different data) - backend reconciliation after debounced API call
7. If intake session ends with missing critical fields, pre-fill packet flags these with high priority for licensed agent
8. Real-time updates happen instantly via React state updates when pills change (no SSE/WebSocket needed)
9. Intake completeness â‰¥95% validated in evaluation harness

## Tasks / Subtasks

- [ ] **Task 1: Enhance Frontend Missing Fields Calculation** (AC: 1, 2, 6)
  - [ ] Update `calculateMissingFields()` function in `apps/web/src/lib/missing-fields.ts` to accept `productLine`, `state`, and `carrier` parameters
  - [ ] Add carrier-specific field requirements (if carrier is known) - query knowledge pack or use hardcoded rules
  - [ ] Add state-specific field requirements (if state is known) - query knowledge pack or use hardcoded rules
  - [ ] Return missing fields with priority indicators: `{ fieldKey: string, priority: 'critical' | 'important' | 'optional' }[]`
  - [ ] Update function signature: `calculateMissingFields(profile: UserProfile, productLine?: string, state?: string, carrier?: string): MissingFieldInfo[]`
  - [ ] Handle edge cases: unknown product/state/carrier falls back to product-level defaults
  - [ ] Ensure function runs synchronously (no async) for real-time updates

- [ ] **Task 2: Update Backend Missing Fields Detection** (AC: 6)
  - [ ] Update `getMissingFields()` function in `apps/api/src/services/prefill-generator.ts` to accept `productLine`, `state`, and `carrier` parameters
  - [ ] Query knowledge pack for carrier-specific field requirements (if carrier is known)
  - [ ] Query knowledge pack for state-specific field requirements (if state is known)
  - [ ] Return missing fields with priority indicators: `{ field: string, priority: 'critical' | 'important' | 'optional' }[]`
  - [ ] Update function signature: `getMissingFields(profile: UserProfile, productLine?: string, state?: string, carrier?: string): MissingField[]`
  - [ ] Handle edge cases: unknown product/state/carrier falls back to product-level defaults
  - [ ] Backend missing fields reconcile with frontend after debounced API call (backend takes precedence)

- [ ] **Task 3: Enhance Missing Fields Sidebar Component** (AC: 3, 4)
  - [ ] Verify `apps/web/src/components/sidebar/MissingFields.tsx` component exists and displays missing fields grouped by priority: Critical (red ðŸ”´), Important (yellow ðŸŸ¡), Optional (gray âšª)
  - [ ] Ensure completeness percentage displays: "X/Y fields - Z% complete" format
  - [ ] Verify progress bar uses smooth animations (400ms ease-out transition)
  - [ ] Ensure progress bar uses shadcn/ui Progress component
  - [ ] Verify completeness calculation: `(totalFields - missingFields.length) / totalFields * 100`
  - [ ] Handle edge cases: 0% complete (no fields captured), 100% complete (all fields captured)
  - [ ] Component should update reactively when `missingFields` array changes (React state updates)

- [ ] **Task 4: Integrate Real-Time Missing Fields Calculation** (AC: 2, 8)
  - [ ] Verify `apps/web/src/components/intake/UnifiedChatInterface.tsx` calculates missing fields in real-time
  - [ ] Ensure `useEffect` hook recalculates missing fields when `profile` state changes (when pills are added/removed)
  - [ ] Verify `calculateMissingFields()` is called synchronously on frontend (no API call needed)
  - [ ] Ensure missing fields update instantly when pills are added/removed/edited via `PillFieldExtractionPlugin` and `PillInteractionPlugin`
  - [ ] Verify frontend missing fields are shown immediately, backend reconciliation happens after debounced API call
  - [ ] Ensure `hasBackendMissingFields` ref prevents frontend calculation from overriding backend results after API call

- [ ] **Task 6: Verify Visual Priority Indicators** (AC: 3)
  - [ ] Verify MissingFields component displays priority indicators:
    - [ ] ðŸ”´ Red circle (12px) for Critical fields
    - [ ] ðŸŸ¡ Yellow circle (12px) for Important fields
    - [ ] âšª Gray circle (12px) for Optional fields
  - [ ] Verify Unicode circles are used (not icon library) per front-end-spec.md
  - [ ] Verify priority indicators styled with Tailwind colors: `text-red-500`, `text-yellow-500`, `text-gray-500`
  - [ ] Verify indicators positioned to left of field name
  - [ ] Ensure accessibility: Add `aria-label` with priority level if missing

- [ ] **Task 7: Update Prefill Packet Generation** (AC: 7)
  - [ ] Update `generatePrefillPacket()` function in `apps/api/src/services/prefill-generator.ts` to include missing critical fields in `missingFields` array with `[CRITICAL]` prefix
  - [ ] Ensure prefill packet `missingFields` array flags critical fields with high priority indicators
  - [ ] Test that prefill packet includes all missing critical fields when session ends

- [ ] **Task 8: Add Unit Tests** (AC: 1, 2, 6)
  - [ ] Create `apps/api/src/services/__tests__/prefill-generator-missing-fields.test.ts`
  - [ ] Test `getMissingFields()` with product-specific requirements:
    - [ ] Auto product: drivers, vehicles, vins detected correctly
    - [ ] Home product: propertyType, constructionYear, squareFeet detected correctly
    - [ ] Renters product: propertyType, personalProperty detected correctly
    - [ ] Umbrella product: existingPolicies detected correctly
  - [ ] Test priority assignment: critical/important/optional priorities assigned correctly
  - [ ] Test carrier-specific requirements: different carriers require different fields
  - [ ] Test state-specific requirements: different states require different fields
  - [ ] Test edge cases: unknown product/state/carrier falls back to defaults
  - [ ] Use Bun test framework with Jest-compatible API

- [ ] **Task 9: Add Integration Tests** (AC: 2, 6)
  - [ ] Create `apps/api/src/routes/__tests__/missing-fields-priority.test.ts`
  - [ ] Test IntakeResult includes `missingFields` array with priority indicators
  - [ ] Test missing fields update after POST `/api/intake` message with carrier/state-specific requirements
  - [ ] Test backend missing fields reconcile with frontend calculation (backend takes precedence)
  - [ ] Use Hono test utilities (no server required)

- [ ] **Task 10: Add Frontend Component Tests** (AC: 2, 3, 4)
  - [ ] Create `apps/web/src/lib/__tests__/missing-fields.test.ts`
  - [ ] Test `calculateMissingFields()` function with product-specific requirements
  - [ ] Test priority assignment: critical/important/optional priorities assigned correctly
  - [ ] Test carrier-specific requirements: different carriers require different fields
  - [ ] Test state-specific requirements: different states require different fields
  - [ ] Test edge cases: unknown product/state/carrier falls back to defaults
  - [ ] Create `apps/web/src/components/sidebar/__tests__/MissingFields.test.tsx`
  - [ ] Test MissingFields component displays fields grouped by priority
  - [ ] Test completeness percentage calculation: "8/12 fields - 67% complete"
  - [ ] Test progress bar updates when missingFields array changes
  - [ ] Test visual priority indicators render correctly (red/yellow/gray circles)
  - [ ] Test real-time updates when profile state changes (pills added/removed)
  - [ ] Use @testing-library/react with Bun test

## Dev Notes

### Previous Story Insights
- Story 1.8 completed: Prefill packet generation implemented, `getMissingFields()` function exists in `apps/api/src/services/prefill-generator.ts`, returns `string[]` with priority prefixes `[CRITICAL]`, `[IMPORTANT]`, `[OPTIONAL]` [Source: apps/api/src/services/prefill-generator.ts:21-71]
- Story 1.7 completed: Compliance filter implemented, disclaimers available for embedding in prefill packets
- Story 1.6 completed: Routing engine implemented, RouteDecision includes `primaryCarrier` field needed for carrier-specific field requirements
- Story 1.5 completed: Conversational Extractor extracts UserProfile with all fields needed for missing fields detection
- Story 1.4 completed: Frontend chat interface exists, NotesPanel with Lexical editor and pill system implemented, MissingFields component exists in Sidebar
- **Frontend missing fields calculation**: `calculateMissingFields()` function exists in `apps/web/src/lib/missing-fields.ts` - calculates missing fields synchronously from UserProfile [Source: apps/web/src/lib/missing-fields.ts:23-72]
- **Real-time pill detection**: `PillFieldExtractionPlugin` detects pill creation/removal via Lexical mutation listeners, triggers `onFieldExtracted` callback [Source: apps/web/src/components/notes/NotesPanel.tsx:151-204]
- **Real-time missing fields updates**: `UnifiedChatInterface` recalculates missing fields in `useEffect` hook when `profile` state changes (triggered by pill add/remove) [Source: apps/web/src/components/intake/UnifiedChatInterface.tsx:79-98]
- **Backend reconciliation**: After 500ms debounce, frontend calls intake API and reconciles with backend missing fields (backend takes precedence via `hasBackendMissingFields` ref) [Source: apps/web/src/components/intake/UnifiedChatInterface.tsx:158-224]
- **IntakeResult schema**: Currently includes `missingFields: string[]` field with priority prefixes - backend returns string array, frontend parses to MissingField objects [Source: apps/web/src/components/intake/UnifiedChatInterface.tsx:181-212]
- **Backend missing fields detection**: `getMissingFields()` function exists but only accepts `UserProfile` parameter - needs enhancement to accept `productLine`, `state`, `carrier` for adaptive requirements [Source: apps/api/src/services/prefill-generator.ts:21-71]

### Required Dependencies
- **Existing**: `zod` ^3.23 (already installed), prefill generator service (Story 1.8), routing engine service (Story 1.6), conversational extractor (Story 1.5), Lexical editor (Story 1.4), React 18.2
- **No new packages required**: Real-time calculation uses synchronous frontend function, React state updates for instant UI feedback

### Data Models
- **MissingField**: New type to be created in `packages/shared/src/types/missing-field.ts` with `field: string` and `priority: 'critical' | 'important' | 'optional'` [Source: epic requirements AC3]
- **IntakeResult**: Schema includes `missingFields: string[]` field, needs to be updated to `missingFields: MissingField[]` [Source: packages/shared/src/schemas/intake-result.ts]
- **UserProfile**: Schema includes all fields needed for missing fields detection (state, productLine, vehicles, drivers, etc.) [Source: packages/shared/src/schemas/user-profile.ts]
- **RouteDecision**: Schema includes `primaryCarrier` field needed for carrier-specific field requirements [Source: packages/shared/src/schemas/intake-result.ts]

### API Specifications
- **Intake Endpoint**: POST `/api/intake` already returns `missingFields: string[]` in IntakeResult with priority prefixes `[CRITICAL]`, `[IMPORTANT]`, `[OPTIONAL]` - frontend parses these to MissingField objects [Source: apps/api/src/routes/intake.ts:170]
- **Real-Time Updates**: No SSE/WebSocket needed - missing fields calculated synchronously on frontend when pills change, backend reconciliation happens after debounced API call [Source: apps/web/src/components/intake/UnifiedChatInterface.tsx:79-98]
- **Request/Response Format**: JSON with snake_case keys (auto-transformed from camelCase TypeScript types) [Source: architecture/5-api-specification.md]
- **Error Handling**: Standard error response format with `error.code`, `error.message`, `error.details` [Source: architecture/5-api-specification.md#54-error-handling]
- **Debounced API Call**: Frontend calls intake API after 500ms debounce when editor content changes - backend missing fields reconcile with frontend calculation [Source: apps/web/src/components/intake/UnifiedChatInterface.tsx:158-224]

### Component Specifications
- **MissingFields Component**: Displays missing fields grouped by priority (Critical/Important/Optional), shows completeness percentage with progress bar, updates reactively when missingFields array changes [Source: front-end-spec.md#enhanced-missing-fields-component-specification]
- **Progress Bar**: Uses shadcn/ui Progress component with smooth animations (400ms ease-out transition), displays completion percentage [Source: front-end-spec.md#component-library-design-system]
- **Priority Indicators**: Visual Unicode circles (ðŸ”´ red, ðŸŸ¡ yellow, âšª gray) positioned to left of field name [Source: front-end-spec.md#enhanced-missing-fields-component-specification]
- **Real-Time Calculation**: `calculateMissingFields()` function runs synchronously on frontend when pills are added/removed/edited, updates React state immediately [Source: apps/web/src/lib/missing-fields.ts:23-72]
- **Pill Detection**: `PillFieldExtractionPlugin` detects pill creation via Lexical mutation listeners, triggers `onFieldExtracted` callback which updates profile state [Source: apps/web/src/components/notes/NotesPanel.tsx:151-204]
- **Profile State Updates**: `UnifiedChatInterface` maintains `profile` state, recalculates missing fields in `useEffect` hook when profile changes [Source: apps/web/src/components/intake/UnifiedChatInterface.tsx:79-98]

### UI/UX Specifications
- **Visual Priority System**: Critical (red ðŸ”´), Important (yellow ðŸŸ¡), Optional (gray âšª) [Source: front-end-spec.md#enhanced-missing-fields-component-specification]
- **Typography**: Field names: 16px, semi-bold, primary text color; Priority labels: 14px, light weight, muted text [Source: front-end-spec.md#enhanced-missing-fields-component-specification]
- **Spacing**: 8px padding between rows, 16px padding inside card, 4px gap between field name and priority indicator [Source: front-end-spec.md#enhanced-missing-fields-component-specification]
- **Progress Bar**: Smooth animations (400ms ease-out transition), color gradient based on completion percentage [Source: front-end-spec.md#animation-micro-interactions]
- **Real-Time Updates**: Missing fields calculated synchronously on frontend when pills change (no API call needed), updates React state immediately for instant UI feedback [Source: apps/web/src/components/intake/UnifiedChatInterface.tsx:79-98]
- **No Auto-Prompts**: System only shows what's missing, trusts broker to ask appropriate questions [Source: epic requirements AC5]

### File Locations
- **Service files**: `apps/api/src/services/` directory [Source: architecture/11-backend-architecture.md#111-service-layer-architecture]
- **Route files**: `apps/api/src/routes/` directory [Source: architecture/11-backend-architecture.md#111-service-layer-architecture]
- **Shared types**: `packages/shared/src/types/` directory [Source: architecture/4-data-models.md#41-core-data-models-overview]
- **Shared schemas**: `packages/shared/src/schemas/` directory [Source: architecture/4-data-models.md#41-core-data-models-overview]
- **Frontend components**: `apps/web/src/components/sidebar/` directory [Source: architecture/10-frontend-architecture.md#101-component-architecture]
- **Frontend utilities**: `apps/web/src/lib/` directory [Source: architecture/10-frontend-architecture.md#102-state-management]

### Testing Requirements
- **Testing Framework**: Use Bun test (built-in, Jest-compatible API) [Source: architecture/16-testing-strategy.md#162-testing-tools]
- **Unit Tests**: Test missing fields detection with product/state/carrier-specific requirements, priority assignment, edge cases [Source: architecture/16-testing-strategy.md#163-testing-focus-areas]
- **Integration Tests**: Test IntakeResult includes missingFields with priority indicators, backend missing fields reconcile with frontend after debounced API call [Source: architecture/16-testing-strategy.md#162-testing-tools]
- **Component Tests**: Test MissingFields component displays fields grouped by priority, completeness percentage calculation, progress bar updates [Source: architecture/16-testing-strategy.md#163-testing-focus-areas]
- **Test Coverage**: Unit tests validate missing fields detection across all product types, priority indicators, carrier/state-specific requirements [Source: epic requirements]

### Technical Constraints
- **Backend Framework**: Hono 4.0 with TypeScript 5.6 [Source: architecture/3-tech-stack.md#31-technology-stack-table]
- **Validation**: Zod ^3.23 for runtime type validation [Source: architecture/3-tech-stack.md#31-technology-stack-table]
- **Error handling**: All API routes must use the global error handler middleware, never catch errors and return 200 with error in body [Source: architecture/17-coding-standards.md#171-critical-architectural-rules]
- **Frontend**: React 18.2 with TanStack Query for API calls, Lexical editor for pill system [Source: architecture/3-tech-stack.md#31-technology-stack-table]
- **Real-Time Calculation**: Use synchronous frontend calculation via `calculateMissingFields()` function, React state updates for instant UI feedback [Source: apps/web/src/lib/missing-fields.ts:23-72]

### Project Structure Notes
- **Service layer architecture**: Routes (thin layer) â†’ Services (business logic) â†’ Data layer (knowledge pack RAG) [Source: architecture/11-backend-architecture.md#111-service-layer-architecture]
- **Three-layer pattern**: Routes layer (HTTP concerns), Service layer (business logic), Data layer (knowledge pack RAG, in-memory Maps) [Source: architecture/11-backend-architecture.md#111-service-layer-architecture]
- **Middleware stack**: Error handler (global) â†’ Logger middleware â†’ Zod validator â†’ Route handler [Source: architecture/11-backend-architecture.md#112-middleware-stack]
- **Missing fields detection runs in real-time**: Frontend calculates missing fields synchronously when pills change, backend reconciliation happens after debounced API call [Source: apps/web/src/components/intake/UnifiedChatInterface.tsx:79-98]

### Critical Implementation Notes
- **Priority assignment**: Assign priority indicators based on product requirements - critical fields block quote completion, important fields affect accuracy, optional fields nice-to-have [Source: epic requirements AC3]
- **Adaptive requirements**: Field requirements adapt based on discovered state and carrier - different carriers require different data, different states have different requirements [Source: epic requirements AC6]
- **Real-time updates**: Missing fields calculated synchronously on frontend when pills are added/removed/edited - no API call needed, React state updates provide instant UI feedback [Source: apps/web/src/components/intake/UnifiedChatInterface.tsx:79-98]
- **Completeness calculation**: Calculate completeness percentage: `(totalFields - missingFields.length) / totalFields * 100` - handle edge cases (0%, 100%) [Source: epic requirements AC4]
- **Progress bar animations**: Use smooth animations (400ms ease-out transition) for progress bar updates [Source: front-end-spec.md#animation-micro-interactions]
- **No auto-prompts**: System only shows what's missing, trusts broker to ask appropriate questions - no AI-generated prompts [Source: epic requirements AC5]
- **Prefill packet integration**: Missing critical fields flagged in prefill packet with high priority indicators for licensed agent [Source: epic requirements AC7]
- **Backend reconciliation**: After 500ms debounce, frontend calls intake API and reconciles with backend missing fields - backend takes precedence via `hasBackendMissingFields` ref [Source: apps/web/src/components/intake/UnifiedChatInterface.tsx:158-224]
- **Knowledge pack integration**: Query knowledge pack for carrier-specific and state-specific field requirements - fall back to product-level defaults if unknown [Source: epic requirements AC1, AC6]

## Testing

### Test File Location
- Unit tests: `apps/api/src/services/__tests__/prefill-generator-missing-fields.test.ts`
- Integration tests: `apps/api/src/routes/__tests__/missing-fields-stream.test.ts`
- Component tests: `apps/web/src/components/sidebar/__tests__/MissingFields.test.tsx`

### Test Standards
- Use Bun test framework (Jest-compatible API: `describe`, `it`, `expect`) [Source: architecture/16-testing-strategy.md#162-testing-tools]
- Use Hono test utilities for API route testing (no server required) [Source: architecture/16-testing-strategy.md#162-testing-tools]
- Use @testing-library/react for component testing [Source: architecture/16-testing-strategy.md#162-testing-tools]

### Testing Focus Areas
- Frontend missing fields calculation: Test `calculateMissingFields()` with product/state/carrier-specific requirements, priority assignment, edge cases
- Real-time updates: Test missing fields update instantly when pills are added/removed/edited, React state updates correctly
- Backend reconciliation: Test backend missing fields reconcile with frontend after debounced API call, backend takes precedence
- Frontend components: Test MissingFields component displays fields grouped by priority, completeness percentage calculation, progress bar updates
- Integration: Test IntakeResult includes missingFields with priority indicators, missing fields update after POST `/api/intake` message with carrier/state-specific requirements

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-11-10 | 1.0 | Initial story creation | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used
(To be filled by Dev Agent)

### Debug Log References
(To be filled by Dev Agent)

### Completion Notes
(To be filled by Dev Agent)

### File List
(To be filled by Dev Agent)

## QA Results

(To be filled by QA Agent)

