# Story 2.1: Policy Upload & PDF Parsing

## Status

Ready for Review

## Story

**As a** broker,
**I want** to drag-and-drop a PDF declarations page or manually enter policy data,
**so that** I can quickly analyze existing policies during competitive positioning conversations.

## Acceptance Criteria

1. Policy upload panel (right sidebar from Epic 1) accepts PDF drag-and-drop or file picker
2. POST `/api/policy/upload` endpoint receives PDF and extracts policy data using OCR/text extraction
3. Extracted fields include: carrier, state, product type, coverage limits, deductibles, premiums, effective dates
4. Manual entry form available as fallback if PDF parsing fails or broker prefers typing
5. Key-value syntax supported in manual entry (e.g., `carrier:StateFarm`, `premium:$1200/yr`, `deductible:$500`)
6. Emacs shortcut `Ctrl+X P` focuses policy upload panel
7. Parsing results displayed in sidebar with confidence scores
8. Broker can edit/correct extracted fields before analysis
9. Decision trace logged for PDF parsing and field extraction

## Tasks / Subtasks

- [ ] **Task 1: Create Policy Upload Panel Component** (AC: 1, 4, 5)
  - [ ] Create `apps/web/src/components/policy/PolicyUploadPanel.tsx` component
  - [ ] Implement drag-and-drop zone with dashed border styling
  - [ ] Add file picker button as fallback (click-to-browse)
  - [ ] Support PDF, DOCX, TXT file types (validate MIME type and extension)
  - [ ] Enforce 5MB file size limit with client-side validation
  - [ ] Display file name and size after selection
  - [ ] Show loading spinner during upload
  - [ ] Position in right sidebar (30% width, resizable) per front-end-spec.md layout
  - [ ] Use shadcn/ui components (Card, Button, Input) for consistent styling
  - [ ] Add manual entry text box as fallback (contentEditable with key-value pill support)
  - [ ] Manual entry supports key-value syntax: `carrier:StateFarm`, `premium:$1200/yr`, `deductible:$500`
  - [ ] Manual entry uses same inline pill system as conversational intake (green/red/yellow pills)
  - [ ] Component adapts to policy mode (purple badge, policy-specific placeholders)

- [ ] **Task 2: Implement File Upload API Endpoint** (AC: 2, 3)
  - [ ] Create `apps/api/src/routes/policy.ts` route file
  - [ ] Implement POST `/api/policy/upload` endpoint using Hono
  - [ ] Accept multipart/form-data with file field
  - [ ] Use shared file upload constants from `@repo/shared` for validation (single source of truth)
  - [ ] Validate file type (PDF, DOCX, TXT only) via MIME type and extension using shared constants
  - [ ] Validate file size (max 5MB) before processing using shared constants
  - [ ] Upload file to Gemini File API first (best practice: upload before processing)
  - [ ] Pass file reference to Conversational Extractor Agent for structured extraction
  - [ ] Return PolicySummary with extracted fields: carrier, state, productType, coverageLimits, deductibles, premiums, effectiveDates
  - [ ] Include confidence scores for each extracted field
  - [ ] Use Zod schema validation for request/response types
  - [ ] Error handling: Return structured error if file invalid or upload fails

- [ ] **Task 3: Integrate Conversational Extractor for Policy Parsing** (AC: 2, 3, 7)
  - [ ] Update `apps/api/src/services/conversational-extractor.ts` to support policy document extraction
  - [ ] Add `extractPolicyDataFromFile(file: File)` function
  - [ ] Use Gemini 2.5 Flash-Lite with structured outputs (JSON Schema) for policy extraction
  - [ ] Upload file to Gemini File API first, then reference file URI in extraction call
  - [ ] Use enhanced prompt with insurance agent context: "You are an insurance agent extracting policy information..."
  - [ ] Extract fields: carrier, state, productType, coverageLimits, deductibles, premiums, effectiveDates
  - [ ] Return PolicySummary schema with confidence scores per field
  - [ ] Log token usage for each extraction call
  - [ ] Handle extraction failures gracefully (return partial results with low confidence)
  - [ ] Use existing GeminiProvider pattern from conversational intake flow

- [ ] **Task 4: Create PolicySummary Schema** (AC: 3)
  - [ ] Create `packages/shared/src/schemas/policy-summary.ts` Zod schema
  - [ ] Define fields: carrier (string), state (string), productType (string), coverageLimits (object), deductibles (object), premiums (object), effectiveDates (object)
  - [ ] Add confidence scores: `confidence?: number` for each field (0-1 scale)
  - [ ] Export TypeScript type via `z.infer<typeof policySummarySchema>`
  - [ ] Add to `packages/shared/src/index.ts` exports
  - [ ] Use snake_case for API boundaries, camelCase for TypeScript types

- [ ] **Task 5: Implement Frontend File Upload Integration** (AC: 1, 7, 8)
  - [ ] Update `apps/web/src/components/policy/PolicyUploadPanel.tsx` to handle file upload
  - [ ] Use Hono RPC client for type-safe API calls: `api.api.policy.upload.$post()`
  - [ ] Send file as FormData with multipart/form-data encoding
  - [ ] Display parsing results in sidebar with confidence scores
  - [ ] Show extracted fields in "Captured Fields" accordion section
  - [ ] Display confidence scores as percentage (e.g., "Carrier: GEICO (85%)")
  - [ ] Make all extracted fields editable (click to open modal with pre-filled value)
  - [ ] Update sidebar when broker edits extracted fields
  - [ ] Use TanStack Query for API call with loading/error states
  - [ ] Show toast notification on successful extraction: "Policy parsed: 8 fields extracted"

- [ ] **Task 6: Implement Manual Entry Fallback** (AC: 4, 5)
  - [ ] Add manual entry text box in PolicyUploadPanel component
  - [ ] Use same contentEditable component as conversational intake (NotesPanel)
  - [ ] Support key-value syntax: `carrier:StateFarm`, `premium:$1200/yr`, `deductible:$500`
  - [ ] Transform key-value pairs into inline pills (green/red/yellow validation)
  - [ ] Valid policy keys: carrier, state, productType, premium, deductible, coverageLimit, effectiveDate
  - [ ] Parse manual entry and extract PolicySummary on blur or submit
  - [ ] Display extracted fields in sidebar same as PDF upload
  - [ ] Allow broker to mix PDF upload + manual entry corrections

- [ ] **Task 7: Add Keyboard Shortcut for Policy Upload Panel** (AC: 6)
  - [ ] Update keyboard shortcuts handler in `apps/web/src/hooks/useKeyboardShortcuts.ts`
  - [ ] Add `Ctrl+X P` shortcut to focus policy upload panel
  - [ ] Shortcut works globally (from anywhere in app)
  - [ ] Focuses file picker input or manual entry text box
  - [ ] Update shortcuts modal (`/help`) to include new shortcut
  - [ ] Note: Epic 1 mentions "Emacs shortcut" but front-end-spec.md uses slash commands - verify with PO if `Ctrl+X P` is correct or should be `/policy`

- [ ] **Task 8: Implement Decision Trace Logging** (AC: 9)
  - [ ] Update `apps/api/src/services/orchestrator.ts` to log policy upload decisions
  - [ ] Create DecisionTrace entry for policy upload flow
  - [ ] Log inputs: file name, file size, file type, extracted text (first 500 chars)
  - [ ] Log extraction results: PolicySummary with confidence scores
  - [ ] Log LLM call details: model, tokens used, extraction time
  - [ ] Write to compliance log file (`logs/compliance.log`)
  - [ ] Use existing DecisionTrace schema from `packages/shared/src/schemas/decision-trace.ts`
  - [ ] Include flow type: `'policy'` for policy analysis flow

- [ ] **Task 9: Add Error Handling and Edge Cases** (AC: 2, 4)
  - [ ] Handle invalid file types: Show toast "Invalid file type. Supported: PDF, DOCX, TXT"
  - [ ] Handle file size exceeded: Show toast "File too large. Maximum 5MB"
  - [ ] Handle PDF parsing failure: Show PDF viewer in side panel + manual entry text box
  - [ ] Handle LLM extraction failure: Return partial results with low confidence, allow manual correction
  - [ ] Handle network errors: Show toast "Upload failed. Please retry"
  - [ ] Graceful degradation: If PDF parsing fails, show PDF viewer + manual entry (no blocking error)
  - [ ] All errors use structured error response format per API specification

- [ ] **Task 10: Add Unit Tests** (AC: 2, 3)
  - [ ] Create `apps/api/src/routes/__tests__/policy-upload.test.ts`
  - [ ] Test file type validation (PDF, DOCX, TXT accepted, others rejected)
  - [ ] Test file size validation (5MB limit enforced)
  - [ ] Test PolicySummary extraction with mock LLM response
  - [ ] Test error handling for invalid files
  - [ ] Use Bun test framework with Hono test utilities
  - [ ] Mock Conversational Extractor service for unit tests

- [ ] **Task 11: Add Integration Tests** (AC: 2, 3, 9)
  - [ ] Create `apps/api/src/services/__tests__/policy-extraction.test.ts`
  - [ ] Test full policy upload flow: file upload → text extraction → LLM extraction → PolicySummary
  - [ ] Test decision trace logging includes all required fields
  - [ ] Test confidence scores are included in response
  - [ ] Use Bun test with mocked OpenAI API responses

- [x] **Task 12: Add Frontend Component Tests** (AC: 1, 4, 5, 7, 8)
  - [x] Create `apps/web/src/components/policy/__tests__/UploadPanel.test.tsx`
  - [x] Test drag-and-drop file upload
  - [x] Test file picker button opens file dialog
  - [x] Test manual entry key-value syntax parsing
  - [x] Test pill transformation for policy fields
  - [x] Test extracted fields display in sidebar with confidence scores
  - [x] Test field editing (click to open modal, update value)
  - [x] Use @testing-library/react with Bun test

## Dev Notes

### Previous Story Insights

- Story 1.9 completed: Missing fields detection implemented, sidebar component exists with accordion structure, real-time field updates via React state [Source: docs/stories/1.9.real-time-missing-fields-detection.md]
- Story 1.4 completed: Unified chat interface with Lexical editor and inline pill system implemented, NotesPanel component exists [Source: docs/stories/1.4.real-time-chat-interface.md]
- Story 1.5 completed: Conversational Extractor Agent implemented, uses GPT-4o-mini with structured outputs, extracts UserProfile from natural language [Source: docs/architecture/6-components.md#61-conversational-extractor-agent-llm]
- **Lexical editor with pills**: `PillFieldExtractionPlugin` detects key-value pairs and transforms into styled pills [Source: apps/web/src/components/notes/NotesPanel.tsx:151-204]
- **Sidebar component**: `Sidebar.tsx` with accordion sections for captured fields, missing fields, routing status [Source: apps/web/src/components/sidebar/Sidebar.tsx]
- **Manual entry pattern**: Key-value syntax (`k:2`, `v:3`) supported in conversational intake, same pattern applies to policy data entry [Source: front-end-spec.md#inline-pill-input-component-specification]

### Data Models

- **PolicySummary**: New schema needed in `packages/shared/src/schemas/policy-summary.ts` with fields: carrier, state, productType, coverageLimits, deductibles, premiums, effectiveDates, confidence scores [Source: epic requirements AC3]
- **DecisionTrace**: Existing schema in `packages/shared/src/schemas/decision-trace.ts` - includes flow type, inputs, extraction results, LLM calls, outputs [Source: docs/architecture/4-data-models.md#48-decisiontrace]
- **File upload format**: Multipart/form-data with file field, max 5MB, PDF/DOCX/TXT only [Source: docs/architecture/5-api-specification.md#post-apipolicyanalyze]
- **API response format**: JSON with snake_case keys (auto-transformed from camelCase TypeScript types) [Source: docs/architecture/5-api-specification.md#51-core-endpoints]

### API Specifications

- **Policy Upload Endpoint**: POST `/api/policy/upload` accepts multipart/form-data with file field [Source: epic requirements AC2]
- **File validation**: Backend validates MIME type and file extension before processing, max 5MB [Source: docs/architecture/5-api-specification.md#post-apipolicyanalyze]
- **Response format**: PolicySummary with extracted fields and confidence scores [Source: epic requirements AC3, AC7]
- **Error handling**: Standard error response format with `error.code`, `error.message`, `error.details` [Source: docs/architecture/5-api-specification.md#54-error-handling]
- **Hono RPC client**: Frontend uses `api.api.policy.upload.$post()` for type-safe API calls [Source: docs/architecture/5-api-specification.md#53-type-safe-api-client-hono-rpc]

### Component Specifications

- **PolicyUploadPanel**: New component in `apps/web/src/components/policy/PolicyUploadPanel.tsx` - drag-and-drop zone, file picker, manual entry text box [Source: epic requirements AC1, AC4]
- **Sidebar integration**: Extracted fields displayed in existing "Captured Fields" accordion section [Source: front-end-spec.md#sidebar-component-adaptive-fields]
- **Manual entry**: Uses same contentEditable component as conversational intake (NotesPanel) with inline pill system [Source: front-end-spec.md#unified-notes-component]
- **PDF viewer**: Conditional render when PDF parsing fails - shows PDF in side panel for reference [Source: front-end-spec.md#screen-3-policy-analysis-with-pdf-viewer-parse-failure-mode]
- **Confidence scores**: Displayed as percentage next to field value (e.g., "Carrier: GEICO (85%)") [Source: epic requirements AC7]

### UI/UX Specifications

- **Policy upload panel**: Positioned in right sidebar (30% width, resizable), purple badge for policy mode [Source: front-end-spec.md#screen-2-unified-notes-interface-active-state-both-flows]
- **Drag-and-drop zone**: Dashed border, large target area, clear instructions, click-to-browse fallback [Source: front-end-spec.md#screen-1-homeworkspace-initial-state]
- **File validation feedback**: Toast notifications for invalid file type or size exceeded [Source: front-end-spec.md#toast-notification-component]
- **Manual entry**: Key-value syntax supported: `carrier:StateFarm`, `premium:$1200/yr`, `deductible:$500` [Source: epic requirements AC5]
- **Inline pills**: Green for valid key-value pairs, red for unknown keys, yellow for invalid value types [Source: front-end-spec.md#inline-pill-input-component-specification]
- **Confidence scores**: Displayed as percentage with info icon tooltip explaining confidence level [Source: epic requirements AC7]
- **Field editing**: Click any extracted field to open modal with pre-filled value for editing [Source: front-end-spec.md#enhanced-missing-fields-component-specification]
- **Keyboard shortcut**: `Ctrl+X P` focuses policy upload panel (verify with PO - front-end-spec.md uses slash commands) [Source: epic requirements AC6]
- **Panel resizing**: Horizontal drag handles between panels, 300ms ease-out transitions [Source: front-end-spec.md#animation-micro-interactions]

### File Locations

- **Service files**: `apps/api/src/services/` directory [Source: docs/architecture/11-backend-architecture.md#111-service-layer-architecture]
- **Route files**: `apps/api/src/routes/policy.ts` - new file for policy upload endpoint [Source: docs/architecture/11-backend-architecture.md#111-service-layer-architecture]
- **Shared schemas**: `packages/shared/src/schemas/policy-summary.ts` - new PolicySummary Zod schema [Source: docs/architecture/4-data-models.md#41-core-data-models-overview]
- **Frontend components**: `apps/web/src/components/policy/PolicyUploadPanel.tsx` - new component [Source: docs/architecture/10-frontend-architecture.md#101-component-architecture]
- **Frontend utilities**: `apps/web/src/lib/` directory for file upload helpers if needed [Source: docs/architecture/10-frontend-architecture.md#102-state-management]

### Testing Requirements

- **Testing Framework**: Use Bun test (built-in, Jest-compatible API) [Source: docs/architecture/16-testing-strategy.md#162-testing-tools]
- **Unit Tests**: Test file validation, PolicySummary extraction, error handling [Source: docs/architecture/16-testing-strategy.md#163-testing-focus-areas]
- **Integration Tests**: Test full policy upload flow with mocked LLM responses [Source: docs/architecture/16-testing-strategy.md#162-testing-tools]
- **Component Tests**: Test drag-and-drop, file picker, manual entry, pill transformation [Source: docs/architecture/16-testing-strategy.md#163-testing-focus-areas]
- **Test Coverage**: Unit tests validate file validation, extraction logic, error handling [Source: epic requirements]

### Technical Constraints

- **Backend Framework**: Hono 4.0 with TypeScript 5.6 [Source: docs/architecture/3-tech-stack.md#31-technology-stack-table]
- **Validation**: Zod ^3.23 for runtime type validation [Source: docs/architecture/3-tech-stack.md#31-technology-stack-table]
- **Error handling**: All API routes must use the global error handler middleware, never catch errors and return 200 with error in body [Source: docs/architecture/17-coding-standards.md#171-critical-architectural-rules]
- **Frontend**: React 18.2 with TanStack Query for API calls, Lexical editor for pill system [Source: docs/architecture/3-tech-stack.md#31-technology-stack-table]
- **File parsing**: PDF parsing library (pdf-parse or similar), DOCX parsing library for text extraction [Source: epic requirements AC2]
- **LLM integration**: GPT-4o-mini with structured outputs (JSON mode) for policy extraction [Source: docs/architecture/7-external-apis.md#71-openai-api]
- **Token logging**: Every LLM call must log token usage for cost tracking [Source: docs/architecture/7-external-apis.md#71-openai-api]

### Project Structure Notes

- **Service layer architecture**: Routes (thin layer) → Services (business logic) → Data layer (knowledge pack RAG) [Source: docs/architecture/11-backend-architecture.md#111-service-layer-architecture]
- **Three-layer pattern**: Routes layer (HTTP concerns), Service layer (business logic), Data layer (knowledge pack RAG, in-memory Maps) [Source: docs/architecture/11-backend-architecture.md#111-service-layer-architecture]
- **Middleware stack**: Error handler (global) → Logger middleware → Zod validator → Route handler [Source: docs/architecture/11-backend-architecture.md#112-middleware-stack]
- **Policy upload flow**: File upload → Text extraction → LLM extraction → PolicySummary → Sidebar display [Source: epic requirements AC2, AC3]

### Critical Implementation Notes

- **PDF parsing**: Extract text from PDF first, then pass to LLM for structured extraction (two-step process) [Source: epic requirements AC2]
- **Manual entry fallback**: If PDF parsing fails, show PDF viewer + manual entry text box (graceful degradation) [Source: epic requirements AC4]
- **Key-value syntax**: Same pattern as conversational intake - `carrier:StateFarm`, `premium:$1200/yr` transform into pills [Source: epic requirements AC5]
- **Confidence scores**: LLM extraction returns confidence per field (0-1 scale), display as percentage in UI [Source: epic requirements AC7]
- **Field editing**: All extracted fields editable via click → modal with pre-filled value [Source: epic requirements AC8]
- **Decision trace**: Log file upload, text extraction, LLM call, extraction results to compliance log [Source: epic requirements AC9]
- **File size limit**: 5MB maximum enforced on both client and server [Source: docs/architecture/5-api-specification.md#post-apipolicyanalyze]
- **Supported formats**: PDF, DOCX, TXT only - validate MIME type and extension [Source: docs/architecture/5-api-specification.md#post-apipolicyanalyze]

## Testing

### Test File Location

- Unit tests: `apps/api/src/routes/__tests__/policy-upload.test.ts`
- Integration tests: `apps/api/src/services/__tests__/policy-extraction.test.ts`
- Component tests: `apps/web/src/components/policy/__tests__/PolicyUploadPanel.test.tsx`

### Test Standards

- Use Bun test framework (Jest-compatible API: `describe`, `it`, `expect`) [Source: docs/architecture/16-testing-strategy.md#162-testing-tools]
- Use Hono test utilities for API route testing (no server required) [Source: docs/architecture/16-testing-strategy.md#162-testing-tools]
- Use @testing-library/react for component testing [Source: docs/architecture/16-testing-strategy.md#162-testing-tools]

### Testing Focus Areas

- File validation: Test PDF/DOCX/TXT accepted, other types rejected, 5MB limit enforced
- Policy extraction: Test LLM extraction returns PolicySummary with all required fields and confidence scores
- Manual entry: Test key-value syntax parsing, pill transformation, field extraction
- Error handling: Test invalid file types, size exceeded, parsing failures, network errors
- Decision trace: Test logging includes file info, extraction results, LLM call details

## Change Log

| Date       | Version | Description                                                              | Author             |
| ---------- | ------- | ------------------------------------------------------------------------ | ------------------ |
| 2025-11-11 | 1.0     | Initial story creation                                                   | Bob (Scrum Master) |
| 2025-11-11 | 1.1     | Applied QA fixes: Added comprehensive frontend component tests (Task 12) | James (Dev)        |

## Dev Agent Record

### Agent Model Used

Claude Sonnet 4.5 (via Cursor)

### Debug Log References

- Test execution: `bun test apps/web/src/components/policy/__tests__/UploadPanel.test.tsx` - 25 tests passing
- Lint check: `bun run lint` - no errors in test file

### Completion Notes

- **QA Fix Applied**: Expanded frontend component tests per QA findings (Task 12 incomplete)
- **Test Coverage**: Added comprehensive tests for:
  - Drag-and-drop file upload (drag enter, drop, file validation)
  - File picker (label connection, file selection, validation)
  - Manual entry (KeyValueEditor integration, clear functionality)
  - Policy extraction callbacks
  - File display after selection
- **Integration Test Added**: Full upload flow integration test (6 tests) verifying:
  - File upload triggers API call with correct parameters
  - API response processing (PolicySummary structure validation)
  - Confidence scores included in response
  - Complete and partial PolicySummary handling
  - Error handling
- **Test Results**: All 25 component tests + 6 integration tests passing (31 total)
- **Test Approach**: Used @testing-library/react with fireEvent for user interactions, focused on testable behavior rather than implementation details
- **Note**: Some drag-and-drop edge cases (dragLeave on child elements) are better tested via integration tests

### File List

**Added:**

- `apps/web/src/components/policy/__tests__/UploadPanel.test.tsx` - Comprehensive component tests (25 tests)
- `apps/web/src/components/policy/__tests__/PolicyUploadFlow.integration.test.tsx` - Integration test for full upload flow (6 tests)

**Modified:**

- `apps/web/src/components/policy/__tests__/UploadPanel.test.tsx` - Expanded from basic rendering tests to comprehensive functionality tests

## QA Results

### Review Date: 2025-11-11 (Initial Review)

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

**Overall Assessment:** Strong implementation with comprehensive backend testing and solid architecture. Frontend component tests are missing, which is the primary concern.

---

### Review Date: 2025-01-11 (Follow-up Review)

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

**Overall Assessment:** ✅ **Production-ready implementation** with comprehensive test coverage across all layers. Frontend component tests have been added (25 tests passing), addressing the primary concern from initial review.

**Strengths:**

- ✅ **Frontend component tests added** - Comprehensive test coverage: [apps/web/src/components/policy/**tests**/UploadPanel.test.tsx](apps/web/src/components/policy/__tests__/UploadPanel.test.tsx) (25 tests passing, covering all AC requirements)
- ✅ **Integration test for full upload flow** - Complete end-to-end test: [apps/web/src/components/policy/**tests**/PolicyUploadFlow.integration.test.tsx](apps/web/src/components/policy/__tests__/PolicyUploadFlow.integration.test.tsx) (6 tests passing, verifies file → API → response processing)
- Excellent use of shared constants for file validation: [packages/shared/src/constants/file-upload.ts:11-25](packages/shared/src/constants/file-upload.ts#L11-L25) ensures consistency between frontend and backend
- Robust error handling with structured error responses: [apps/api/src/routes/policy.ts:133-196](apps/api/src/routes/policy.ts#L133-L196)
- Comprehensive unit and integration test coverage: [apps/api/src/routes/**tests**/policy-upload.test.ts](apps/api/src/routes/__tests__/policy-upload.test.ts) (11 tests passing)
- Proper decision trace logging implementation: [apps/api/src/routes/policy.ts:266-290](apps/api/src/routes/policy.ts#L266-L290)
- Clean separation of concerns with ConversationalExtractor service: [apps/api/src/services/conversational-extractor.ts:178-240](apps/api/src/services/conversational-extractor.ts#L178-L240)
- Type-safe API integration using Hono RPC: [apps/web/src/components/policy/UploadPanel.tsx:79-83](apps/web/src/components/policy/UploadPanel.tsx#L79-L83)

**Architecture Compliance:**

- ✅ Type sharing follows [17-coding-standards.md:9-10](docs/architecture/17-coding-standards.md#L9-L10) - PolicySummary schema in shared package: [packages/shared/src/schemas/policy-summary.ts](packages/shared/src/schemas/policy-summary.ts)
- ✅ API calls use Hono RPC client per [17-coding-standards.md:12-13](docs/architecture/17-coding-standards.md#L12-L13): [apps/web/src/components/policy/UploadPanel.tsx:79](apps/web/src/components/policy/UploadPanel.tsx#L79)
- ✅ Error handling uses global error handler per [17-coding-standards.md:18-19](docs/architecture/17-coding-standards.md#L18-L19): [apps/api/src/routes/policy.ts:302-316](apps/api/src/routes/policy.ts#L302-L316)
- ✅ LLM calls include token usage logging per [17-coding-standards.md:21-22](docs/architecture/17-coding-standards.md#L21-L22): [apps/api/src/routes/policy.ts:205-206](apps/api/src/routes/policy.ts#L205-L206)
- ✅ File upload constants in shared package per [17-coding-standards.md:9-10](docs/architecture/17-coding-standards.md#L9-L10): [packages/shared/src/constants/file-upload.ts](packages/shared/src/constants/file-upload.ts)

### Refactoring Performed

No refactoring performed during this review. Code quality is high and follows established patterns.

### Compliance Check

- **Coding Standards:** ✅ Verified via [apps/api/src/routes/policy.ts](apps/api/src/routes/policy.ts) and [apps/web/src/components/policy/UploadPanel.tsx](apps/web/src/components/policy/UploadPanel.tsx)
- **Project Structure:** ✅ Verified - routes in `apps/api/src/routes/`, services in `apps/api/src/services/`, components in `apps/web/src/components/policy/`
- **Testing Strategy:** ✅ Complete - Backend tests comprehensive per [16-testing-strategy.md:16-20](docs/architecture/16-testing-strategy.md#L16-L20) (11 unit tests + integration tests), frontend component tests complete (25 tests) per [apps/web/src/components/policy/**tests**/UploadPanel.test.tsx](apps/web/src/components/policy/__tests__/UploadPanel.test.tsx), integration test for full flow (6 tests) per [apps/web/src/components/policy/**tests**/PolicyUploadFlow.integration.test.tsx](apps/web/src/components/policy/__tests__/PolicyUploadFlow.integration.test.tsx) - **Total: 51 tests passing**
- **All ACs Met:** ✅ Verified with linked evidence below

### Requirements Traceability (Given-When-Then)

**AC1: Policy upload panel accepts PDF drag-and-drop or file picker**

- **Given** broker is in policy mode
- **When** broker drags a PDF file onto the upload panel or clicks to browse
- **Then** file is accepted and upload begins
- **Validation:** ✅ Verified via [apps/web/src/components/policy/UploadPanel.tsx:228-262](apps/web/src/components/policy/UploadPanel.tsx#L228-L262) drag-and-drop handler and [apps/web/src/components/policy/UploadPanel.tsx:184-224](apps/web/src/components/policy/UploadPanel.tsx#L184-L224) file picker handler

**AC2: POST `/api/policy/upload` endpoint receives PDF and extracts policy data**

- **Given** a valid PDF file is uploaded
- **When** POST request is made to `/api/policy/upload` with multipart/form-data
- **Then** file is validated, uploaded to Gemini, and PolicySummary is extracted
- **Validation:** ✅ Verified via [apps/api/src/routes/policy.ts:125-260](apps/api/src/routes/policy.ts#L125-L260) route handler and [apps/api/src/routes/**tests**/policy-upload.test.ts:136-159](apps/api/src/routes/__tests__/policy-upload.test.ts#L136-L159) test

**AC3: Extracted fields include carrier, state, product type, coverage limits, deductibles, premiums, effective dates**

- **Given** a policy document is uploaded
- **When** extraction completes successfully
- **Then** PolicySummary contains all required fields with confidence scores
- **Validation:** ✅ Verified via [packages/shared/src/schemas/policy-summary.ts:87-98](packages/shared/src/schemas/policy-summary.ts#L87-L98) schema and [apps/api/src/services/**tests**/policy-extraction.test.ts:88-102](apps/api/src/services/__tests__/policy-extraction.test.ts#L88-L102) integration test

**AC4: Manual entry form available as fallback**

- **Given** broker prefers typing or PDF parsing fails
- **When** broker types in manual entry text box
- **Then** key-value syntax is parsed and displayed as pills
- **Validation:** ✅ Verified via [apps/web/src/components/policy/UploadPanel.tsx:360-371](apps/web/src/components/policy/UploadPanel.tsx#L360-L371) KeyValueEditor component integration

**AC5: Key-value syntax supported in manual entry**

- **Given** broker types key-value pairs like `carrier:StateFarm`, `premium:$1200/yr`
- **When** text is entered in manual entry editor
- **Then** pairs are transformed into inline pills with validation
- **Validation:** ✅ Verified via [apps/web/src/components/shared/KeyValueEditor.tsx](apps/web/src/components/shared/KeyValueEditor.tsx) component using same pill system as conversational intake

**AC6: Emacs shortcut `Ctrl+X P` focuses policy upload panel**

- **Given** broker is anywhere in the app
- **When** broker presses `Ctrl+X` followed by `P` (or `Cmd+X P` on Mac)
- **Then** policy upload panel file input or editor receives focus
- **Validation:** ✅ Verified via [apps/web/src/hooks/useKeyboardShortcuts.ts:26-68](apps/web/src/hooks/useKeyboardShortcuts.ts#L26-L68) implementation and [apps/web/src/components/intake/UnifiedChatInterface.tsx:84-93](apps/web/src/components/intake/UnifiedChatInterface.tsx#L84-L93) integration

**AC7: Parsing results displayed in sidebar with confidence scores**

- **Given** policy data is extracted from uploaded file
- **When** extraction completes
- **Then** fields are displayed in sidebar with confidence percentages (e.g., "Carrier: GEICO (85%)")
- **Validation:** ✅ Verified via [apps/web/src/components/shared/FieldItem.tsx:35-39](apps/web/src/components/shared/FieldItem.tsx#L35-L39) confidence display and [apps/web/src/lib/field-extraction.ts:95-148](apps/web/src/lib/field-extraction.ts#L95-L148) field extraction utility

**AC8: Broker can edit/correct extracted fields before analysis**

- **Given** extracted fields are displayed in sidebar
- **When** broker clicks on any field
- **Then** modal opens with pre-filled value for editing
- **Validation:** ✅ Verified via [apps/web/src/components/shared/FieldItem.tsx:24-28](apps/web/src/components/shared/FieldItem.tsx#L24-L28) click handler and [apps/web/src/components/intake/UnifiedChatInterface.tsx:491-497](apps/web/src/components/intake/UnifiedChatInterface.tsx#L491-L497) FieldModal integration

**AC9: Decision trace logged for PDF parsing and field extraction**

- **Given** a policy file is uploaded and extracted
- **When** extraction completes
- **Then** DecisionTrace is logged to `logs/compliance.log` with file info, extraction results, and LLM call details
- **Validation:** ✅ Verified via [apps/api/src/routes/policy.ts:266-290](apps/api/src/routes/policy.ts#L266-L290) decision trace creation and [apps/api/src/utils/decision-trace.ts:75-94](apps/api/src/utils/decision-trace.ts#L75-L94) logging function

### Improvements Checklist

- [x] Verified all acceptance criteria are met with linked code references
- [x] Confirmed shared constants are used for file validation (single source of truth)
- [x] Validated error handling follows structured error response format
- [x] Verified decision trace logging includes all required fields
- [x] Confirmed confidence scores are displayed in sidebar
- [x] Verified keyboard shortcut implementation
- [x] **Frontend component tests added** - Task 12 complete: [apps/web/src/components/policy/**tests**/UploadPanel.test.tsx](apps/web/src/components/policy/__tests__/UploadPanel.test.tsx) - 25 tests passing, covering all AC requirements
- [x] **Integration test for full upload flow** - Added: [apps/web/src/components/policy/**tests**/PolicyUploadFlow.integration.test.tsx](apps/web/src/components/policy/__tests__/PolicyUploadFlow.integration.test.tsx) - 6 tests passing, verifies file → API → response processing flow (optional enhancement completed)

### Security Review

**Status:** PASS

- File type validation enforced on both client and server: [apps/web/src/components/policy/UploadPanel.tsx:189-201](apps/web/src/components/policy/UploadPanel.tsx#L189-L201) and [apps/api/src/routes/policy.ts:96-114](apps/api/src/routes/policy.ts#L96-L114)
- File size limit enforced (5MB): [packages/shared/src/constants/file-upload.ts:11](packages/shared/src/constants/file-upload.ts#L11)
- MIME type and extension validation: [packages/shared/src/constants/file-upload.ts:43-50](packages/shared/src/constants/file-upload.ts#L43-L50)
- No direct file system access - files processed through Gemini API: [apps/api/src/services/gemini-provider.ts:101-150](apps/api/src/services/gemini-provider.ts#L101-L150)

### Performance Considerations

**Status:** PASS

- File upload uses streaming via Gemini File API (no large file buffering in memory): [apps/api/src/services/gemini-provider.ts:131-137](apps/api/src/services/gemini-provider.ts#L131-L137)
- Token usage logged for cost tracking: [apps/api/src/routes/policy.ts:205-206](apps/api/src/routes/policy.ts#L205-L206)
- Extraction time tracked: [apps/api/src/routes/policy.ts:206](apps/api/src/routes/policy.ts#L206)
- Client-side validation prevents unnecessary API calls: [apps/web/src/components/policy/UploadPanel.tsx:188-218](apps/web/src/components/policy/UploadPanel.tsx#L188-L218)

### Files Modified During Review

No files were modified during this review.

### Gate Status

**Gate:** PASS → [docs/qa/gates/2.1-policy-upload-pdf-parsing.yml](docs/qa/gates/2.1-policy-upload-pdf-parsing.yml)

**Quality Score:** 100/100

**Score Breakdown:**

- Base: 100
- Deduction: 0 (all requirements met, including optional integration test enhancement)

**Rationale:** Implementation is production-ready with comprehensive test coverage across all layers. Frontend component tests (25 tests passing) and integration test for full upload flow (6 tests passing) have been added, covering all acceptance criteria requirements and the optional enhancement. All acceptance criteria are met with full test coverage. **Total: 51 tests passing** (11 backend unit + 9 backend integration + 25 frontend component + 6 frontend integration).

### Recommended Status

✅ **Ready for Done**

**Next Steps:**

1. ✅ Frontend component tests completed - [apps/web/src/components/policy/**tests**/UploadPanel.test.tsx](apps/web/src/components/policy/__tests__/UploadPanel.test.tsx) - 25 tests passing
2. ✅ Integration test for full upload flow completed - [apps/web/src/components/policy/**tests**/PolicyUploadFlow.integration.test.tsx](apps/web/src/components/policy/__tests__/PolicyUploadFlow.integration.test.tsx) - 6 tests passing

**Additional Notes:**

- Backend implementation is production-ready with comprehensive test coverage (11 unit tests + 9 integration tests)
- Frontend implementation is production-ready with comprehensive test coverage (25 component tests + 6 integration tests)
- **Total test coverage: 51 tests passing** across all layers
- Integration test for full upload flow (6 tests) - verifies file upload → API call → response processing (optional enhancement completed)
- All acceptance criteria are met with full test coverage
- Decision trace logging properly captures all required information for compliance
- Confidence scores are correctly displayed in sidebar via FieldItem component
- Test coverage exceeds story requirements - all tasks complete including optional enhancements
