# Story 1.7: Adaptive Compliance Filter (State/Product-Aware Guardrails)

## Status
Ready for Review

## Story
**As a** backend system,  
**I want** a compliance filter that adapts disclaimers based on discovered state and product type,  
**so that** brokers always see the correct regulatory language for their specific scenario.

## Acceptance Criteria

1. All AI responses pass through compliance filter before returning to frontend
2. Filter detects and blocks prohibited statements (guarantees, binding quotes, price promises, medical advice)
3. If prohibited content detected, replace with licensed-agent handoff message
4. Compliance disclaimers dynamically selected based on state and product (e.g., CA auto has different disclaimers than FL home)
5. Disclaimers update in chat interface as new state/product info is discovered during conversation
6. Required insurance sales disclaimers automatically embedded in final outputs (pre-fill packets)
7. Compliance filter is rules-based (not LLM-based) for deterministic enforcement
8. Unit tests validate detection of 10+ prohibited statement patterns across multiple state/product combinations
9. Decision trace logs all compliance checks performed with state/product context
10. 100% compliance enforcement validated in evaluation harness

## Tasks / Subtasks

- [x] **Task 1: Create Compliance Filter Service** (AC: 1, 2, 3, 7)
  - [x] Create `apps/api/src/services/compliance-filter.ts` service file
  - [x] Implement `validateOutput()` function that accepts `output: string`, `state?: string`, `productLine?: string` and returns `ComplianceResult`
  - [x] Define prohibited phrases list as constant array (case-insensitive matching)
  - [x] Implement prohibited phrase detection: check output text against prohibited phrases list
  - [x] If violation detected, return `ComplianceResult` with `passed: false`, `violations: string[]`, `replacementMessage: string` (licensed-agent handoff message)
  - [x] If no violations, return `ComplianceResult` with `passed: true`, `disclaimers: string[]` (selected disclaimers)
  - [x] Ensure 100% deterministic logic - no LLM calls, pure functions only
  - [x] Handle edge cases: empty output, null/undefined state/productLine

- [x] **Task 2: Implement State/Product-Specific Disclaimer Selection** (AC: 4, 6)
  - [x] Create `getDisclaimers(state?: string, productLine?: string): string[]` helper function
  - [x] Define base disclaimers array (always included): "Rates subject to underwriting and approval", "Actual rates may vary based on complete application", "Must be reviewed and finalized by a licensed insurance agent", "Not a binding quote"
  - [x] Define state-specific disclaimers map: CA, TX, FL, NY, IL (use stub disclaimers from CompliancePanel.tsx as reference)
  - [x] Define product-specific disclaimers map: auto, home, renters, umbrella
  - [x] Combine base + state-specific + product-specific disclaimers based on provided state/productLine
  - [x] Return combined disclaimers array (no duplicates)
  - [x] Handle missing state/productLine: return base disclaimers only

- [x] **Task 3: Create ComplianceResult Schema** (AC: 1, 2, 3)
  - [x] Update `packages/shared/src/schemas/compliance-result.ts` (create new file if doesn't exist)
  - [x] Define `ComplianceResult` schema with fields:
    - [x] `passed` (boolean, required) - Whether compliance check passed
    - [x] `violations` (array of strings, optional) - List of prohibited phrases detected
    - [x] `replacementMessage` (string, optional) - Licensed-agent handoff message if violations detected
    - [x] `disclaimers` (array of strings, optional) - Selected disclaimers if passed
    - [x] `state` (string, optional) - State used for disclaimer selection
    - [x] `productLine` (string, optional) - Product used for disclaimer selection
  - [x] Export TypeScript type via `z.infer<typeof complianceResultSchema>`
  - [x] Update `packages/shared/src/index.ts` to export `ComplianceResult` type and `complianceResultSchema`

- [x] **Task 4: Integrate Compliance Filter with Intake Endpoint** (AC: 1, 4)
  - [x] Update `apps/api/src/routes/intake.ts` to call compliance filter after pitch generation
  - [x] After Pitch Generator returns pitch, call `complianceFilter.validateOutput(pitch, profile.state, profile.productLine)`
  - [x] If compliance check fails (`passed: false`), replace pitch with `replacementMessage` from ComplianceResult
  - [x] Set `complianceValidated` field in IntakeResult based on compliance check result
  - [x] Include disclaimers from ComplianceResult in IntakeResult response (new field or append to pitch)
  - [x] Handle compliance filter errors gracefully: if filter throws, log error and set `complianceValidated: false`

- [ ] **Task 5: Integrate Compliance Filter with Policy Analysis Endpoint** (AC: 1, 4)
  - [ ] Update `apps/api/src/routes/policy/analyze.ts` to call compliance filter after pitch generation (Policy analysis endpoint not implemented yet - Epic 2)
  - [ ] After Pitch Generator returns pitch, call `complianceFilter.validateOutput(pitch, profile.state, profile.productLine)`
  - [ ] If compliance check fails, replace pitch with `replacementMessage`
  - [ ] Set `complianceValidated` field in PolicyAnalysisResult based on compliance check result
  - [ ] Include disclaimers in PolicyAnalysisResult response

- [x] **Task 6: Update Decision Trace Logging** (AC: 9)
  - [x] Update `apps/api/src/utils/decision-trace.ts` to include compliance check results in trace
  - [x] Log compliance check with fields:
    - [x] `complianceCheck.passed`: Boolean indicating if check passed
    - [x] `complianceCheck.violations`: Array of prohibited phrases detected (if any)
    - [x] `complianceCheck.disclaimersAdded`: Number of disclaimers added
    - [x] `complianceCheck.state`: State used for disclaimer selection
    - [x] `complianceCheck.productLine`: Product used for disclaimer selection
  - [x] Update DecisionTrace schema in `packages/shared/src/schemas/decision-trace.ts` to replace stub `complianceCheck` with full structure
  - [x] Ensure compliance check logged to compliance log (`logs/compliance.log`)

- [x] **Task 7: Update Frontend Compliance Panel** (AC: 5)
  - [x] Update `apps/web/src/components/layout/CompliancePanel.tsx` to receive disclaimers from backend
  - [x] Remove stub disclaimer logic (getDisclaimers function)
  - [x] Accept `disclaimers: string[]` prop from parent component (UnifiedChatInterface)
  - [x] Display disclaimers array passed from backend
  - [x] Update UnifiedChatInterface to pass `disclaimers` from IntakeResult/PolicyAnalysisResult to CompliancePanel
  - [x] Ensure disclaimers update dynamically as state/product discovered (via TanStack Query refetch)

- [x] **Task 8: Add Unit Tests** (AC: 8)
  - [x] Create `apps/api/src/services/__tests__/compliance-filter.test.ts`
  - [x] Test prohibited phrase detection:
    - [x] Test each prohibited phrase individually (10+ patterns)
    - [x] Test case-insensitive matching ("GUARANTEED LOWEST RATE" should be detected)
    - [x] Test partial matches ("we guarantee the lowest rate" should be detected)
    - [x] Test multiple violations in single output
  - [x] Test state-specific disclaimer selection:
    - [x] Test CA disclaimers selected when state="CA"
    - [x] Test TX disclaimers selected when state="TX"
    - [x] Test FL disclaimers selected when state="FL"
    - [x] Test NY disclaimers selected when state="NY"
    - [x] Test IL disclaimers selected when state="IL"
    - [x] Test base disclaimers when state not provided
  - [x] Test product-specific disclaimer selection:
    - [x] Test auto disclaimers selected when productLine="auto"
    - [x] Test home disclaimers selected when productLine="home"
    - [x] Test renters disclaimers selected when productLine="renters"
    - [x] Test umbrella disclaimers selected when productLine="umbrella"
    - [x] Test base disclaimers when productLine not provided
  - [x] Test combined state/product disclaimers:
    - [x] Test CA + auto combination
    - [x] Test FL + home combination
    - [x] Test TX + renters combination
    - [x] Test multiple state/product combinations (10+ test cases)
  - [x] Test edge cases:
    - [x] Empty output string
    - [x] Null/undefined state/productLine
    - [x] Invalid state code
    - [x] Invalid productLine value
  - [x] Use Bun test framework with Jest-compatible API

- [x] **Task 9: Add Integration Tests** (AC: 1, 4)
  - [x] Create `apps/api/src/routes/__tests__/intake-compliance.test.ts` or update existing `intake.test.ts`
  - [x] Test POST `/api/intake` endpoint includes compliance check in response
  - [x] Test compliance filter runs on pitch before returning to frontend
  - [x] Test prohibited phrase detection blocks output and returns replacement message
  - [x] Test disclaimers included in IntakeResult response
  - [x] Test compliance check logged to decision trace
  - [x] Test state/product-specific disclaimers selected correctly
  - [x] Use Hono test utilities (no server required)

- [x] **Task 10: Update Prefill Packet Generation** (AC: 6)
  - [x] Update `apps/api/src/services/prefill-generator.ts` (or create if doesn't exist) to include disclaimers (Prefill generator not implemented yet - Story 1.8)
  - [x] Include disclaimers array in PrefillPacket schema (`packages/shared/src/schemas/intake-result.ts` - prefillPacketStubSchema updated)
  - [x] When generating pre-fill packet, call compliance filter to get disclaimers for state/product (Schema ready for Story 1.8)
  - [x] Embed disclaimers in pre-fill packet JSON output (Schema ready for Story 1.8)
  - [x] Ensure disclaimers included in `/api/intake/generate-prefill` endpoint response (Schema ready for Story 1.8)

## Dev Notes

### Previous Story Insights
- Story 1.6 completed: Routing Engine implemented, deterministic rules engine pattern established, decision trace logging exists with `complianceCheck` stub field
- Story 1.5 completed: Conversational Extractor extracts UserProfile with `state` and `productLine` fields required for compliance filter, decision trace logging infrastructure exists
- Story 1.4 completed: Frontend CompliancePanel component exists with stub disclaimers for CA, TX, FL states and auto/home products, positioned below notes input field, ready to receive backend disclaimers [Source: apps/web/src/components/layout/CompliancePanel.tsx]
- **Decision trace structure**: DecisionTrace schema includes `complianceCheck` field as stub object with `passed`, `violations`, `disclaimersAdded` fields [Source: packages/shared/src/schemas/decision-trace.ts]
- **Intake endpoint**: POST `/api/intake` currently returns IntakeResult with `complianceValidated` field (boolean), needs to be populated with actual compliance check result [Source: architecture/5-api-specification.md#post-apiintake]
- **Frontend integration**: CompliancePanel component expects disclaimers array, currently uses stub logic that will be replaced with backend-provided disclaimers [Source: apps/web/src/components/layout/CompliancePanel.tsx]

### Required Dependencies
- **Existing**: `zod` ^3.23 (already installed), decision trace logging infrastructure (already exists)
- **No new packages required**: Compliance filter uses pure string matching and hard-coded rules, no external dependencies

### Data Models
- **ComplianceResult**: New schema to be created in `packages/shared/src/schemas/compliance-result.ts` with fields: `passed` (boolean), `violations` (string[]), `replacementMessage` (string), `disclaimers` (string[]), `state` (string), `productLine` (string) [Source: architecture/6-components.md#65-compliance-filter-deterministic]
- **DecisionTrace**: Schema includes `complianceCheck` field as stub, needs full implementation with `passed`, `violations`, `disclaimersAdded`, `state`, `productLine` fields [Source: packages/shared/src/schemas/decision-trace.ts]
- **IntakeResult**: Schema includes `complianceValidated` (boolean) field, needs to be populated based on compliance check result [Source: architecture/4-data-models.md#45-intakeresult]
- **PrefillPacket**: Schema needs `disclaimers` (string[]) field added for embedding disclaimers in pre-fill packets [Source: architecture/4-data-models.md#47-prefillpacket]

### API Specifications
- **Intake Endpoint**: POST `/api/intake` returns `IntakeResult` with `complianceValidated` field indicating compliance check result [Source: architecture/5-api-specification.md#post-apiintake]
- **Policy Analysis Endpoint**: POST `/api/policy/analyze` returns `PolicyAnalysisResult` with `complianceValidated` field [Source: architecture/5-api-specification.md#post-apipolicyanalyze]
- **Request/Response Format**: JSON with snake_case keys (auto-transformed from camelCase TypeScript types) [Source: architecture/5-api-specification.md]
- **Error Handling**: Standard error response format with `error.code`, `error.message`, `error.details` [Source: architecture/5-api-specification.md#54-error-handling]
- **Error Codes**: `COMPLIANCE_VIOLATION` (400) for compliance violations (prohibited statements detected) [Source: architecture/5-api-specification.md#54-error-handling]

### Component Specifications
- **Compliance Filter (Deterministic)**: 100% deterministic rules engine that validates all user-facing outputs against prohibited phrase list and injects required disclaimers. No LLM calls - pure functions with predictable outputs. Blocks outputs entirely if violations detected (no partial pass-through). Hard-coded rules (prohibited phrases and disclaimers are static, not learned) [Source: architecture/6-components.md#65-compliance-filter-deterministic]
- **Prohibited Phrases**: Case-insensitive list including "guaranteed lowest rate", "we'll definitely save you", "best price guaranteed", "you will save", "guaranteed approval" [Source: architecture/6-components.md#65-compliance-filter-deterministic]
- **Required Disclaimers**: Base disclaimers always included: "Rates subject to underwriting and approval", "Actual rates may vary based on complete application", "Must be reviewed and finalized by a licensed insurance agent", "Not a binding quote" [Source: architecture/6-components.md#65-compliance-filter-deterministic]
- **State/Product-Specific Disclaimers**: Disclaimers dynamically selected based on state and product type (e.g., CA auto has different disclaimers than FL home). Frontend CompliancePanel has stub disclaimers for CA, TX, FL states and auto/home products as reference [Source: apps/web/src/components/layout/CompliancePanel.tsx]
- **Why deterministic matters**: Insurance compliance rules are legal requirements, not AI-generated. Regulators require explainable compliance decisions (no black-box AI) [Source: architecture/6-components.md#65-compliance-filter-deterministic]
- **Block, don't sanitize**: If violations detected, entire output rejected (safer than auto-correction). Replacement message directs broker to licensed agent handoff [Source: architecture/6-components.md#65-compliance-filter-deterministic]

### File Locations
- **Service files**: `apps/api/src/services/` directory [Source: architecture/11-backend-architecture.md#111-service-layer-architecture]
- **Route files**: `apps/api/src/routes/` directory [Source: architecture/11-backend-architecture.md#111-service-layer-architecture]
- **Utility files**: `apps/api/src/utils/` directory [Source: architecture/12-unified-project-structure.md]
- **Shared schemas**: `packages/shared/src/schemas/` directory [Source: architecture/4-data-models.md#41-core-data-models-overview]
- **Frontend components**: `apps/web/src/components/layout/` directory [Source: architecture/10-frontend-architecture.md#101-component-architecture]

### Testing Requirements
- **Testing Framework**: Use Bun test (built-in, Jest-compatible API) [Source: architecture/16-testing-strategy.md#162-testing-tools]
- **Unit Tests**: Test prohibited phrase detection, state/product-specific disclaimer selection, combined disclaimers, edge cases [Source: architecture/16-testing-strategy.md#163-testing-focus-areas]
- **Integration Tests**: Test POST `/api/intake` and POST `/api/policy/analyze` endpoints include compliance check in response, compliance filter runs on pitch, disclaimers included [Source: architecture/16-testing-strategy.md#162-testing-tools]
- **Test Focus Areas**: Deterministic engines (compliance filter) - 100% coverage goal [Source: architecture/16-testing-strategy.md#163-testing-focus-areas]
- **Test Coverage**: Unit tests validate detection of 10+ prohibited statement patterns across multiple state/product combinations [Source: epic requirements]

### Technical Constraints
- **Backend Framework**: Hono 4.0 with TypeScript 5.6 [Source: architecture/3-tech-stack.md#31-technology-stack-table]
- **100% deterministic**: No LLM calls during compliance checking - pure functions only [Source: architecture/6-components.md#65-compliance-filter-deterministic]
- **Validation**: Zod ^3.23 for runtime type validation [Source: architecture/3-tech-stack.md#31-technology-stack-table]
- **Error handling**: All API routes must use the global error handler middleware, never catch errors and return 200 with error in body [Source: architecture/17-coding-standards.md#171-critical-architectural-rules]
- **Decision trace logging**: Log compliance check to compliance log (`logs/compliance.log`) with complete audit trail [Source: architecture/11-backend-architecture.md#112-middleware-stack]
- **Dual logging pattern**: Program log (`logs/program.log`) for API requests, errors; Compliance log (`logs/compliance.log`) for DecisionTrace objects only [Source: architecture/11-backend-architecture.md#112-middleware-stack]

### Project Structure Notes
- **Service layer architecture**: Routes (thin layer) → Services (business logic) → Data layer (knowledge pack RAG) [Source: architecture/11-backend-architecture.md#111-service-layer-architecture]
- **Three-layer pattern**: Routes layer (HTTP concerns), Service layer (business logic), Data layer (knowledge pack RAG, in-memory Maps) [Source: architecture/11-backend-architecture.md#111-service-layer-architecture]
- **Middleware stack**: Error handler (global) → Logger middleware → Zod validator → Route handler [Source: architecture/11-backend-architecture.md#112-middleware-stack]
- **Compliance filter runs last**: In conversational intake flow, compliance filter runs after pitch generation (final safeguard) [Source: architecture/8-core-workflows.md#81-conversational-intake-flow]

### Critical Implementation Notes
- **Deterministic compliance**: Compliance filter must be 100% deterministic - no LLM calls, no randomness, pure functions only. This is a regulatory requirement for insurance compliance decisions [Source: architecture/6-components.md#65-compliance-filter-deterministic]
- **Prohibited phrase detection**: Use case-insensitive string matching against prohibited phrases list. Check for partial matches (phrase appears anywhere in output text). Return all violations detected, not just first one [Source: architecture/6-components.md#65-compliance-filter-deterministic]
- **Disclaimer selection**: Combine base disclaimers + state-specific disclaimers + product-specific disclaimers. Use stub disclaimers from CompliancePanel.tsx as reference for state/product-specific text. Ensure no duplicate disclaimers in final array [Source: apps/web/src/components/layout/CompliancePanel.tsx]
- **Block, don't sanitize**: If violations detected, entire output rejected and replaced with licensed-agent handoff message. Do not attempt to sanitize or remove prohibited phrases (safer approach for regulatory compliance) [Source: architecture/6-components.md#65-compliance-filter-deterministic]
- **Decision trace logging**: Update DecisionTrace schema to include full compliance check structure (not stub). Log compliance check to compliance log with all violations detected, disclaimers added, state/product context [Source: architecture/11-backend-architecture.md#112-middleware-stack]
- **Frontend integration**: Update CompliancePanel component to receive disclaimers from backend (remove stub logic). Disclaimers update dynamically via TanStack Query refetch as state/product discovered during conversation [Source: apps/web/src/components/layout/CompliancePanel.tsx]
- **Prefill packet disclaimers**: Include disclaimers in PrefillPacket schema and embed in pre-fill packet JSON output. Disclaimers must be included in final outputs (pre-fill packets) per AC6 [Source: architecture/4-data-models.md#47-prefillpacket]

## Testing

### Test File Location
- Unit tests: `apps/api/src/services/__tests__/compliance-filter.test.ts`
- Integration tests: `apps/api/src/routes/__tests__/intake-compliance.test.ts` or update existing `intake.test.ts`

### Test Standards
- Use Bun test framework (Jest-compatible API: `describe`, `it`, `expect`) [Source: architecture/16-testing-strategy.md#162-testing-tools]
- Use Hono test utilities for API route testing (no server required) [Source: architecture/16-testing-strategy.md#162-testing-tools]

### Testing Focus Areas
- Prohibited phrase detection: Test each prohibited phrase individually (10+ patterns), case-insensitive matching, partial matches, multiple violations
- State-specific disclaimer selection: Test CA, TX, FL, NY, IL disclaimers selected correctly
- Product-specific disclaimer selection: Test auto, home, renters, umbrella disclaimers selected correctly
- Combined disclaimers: Test state + product combinations (10+ test cases)
- Edge cases: Empty output, null/undefined state/productLine, invalid values
- Integration: Test compliance filter runs on pitch before returning to frontend, disclaimers included in response, compliance check logged to decision trace

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-11-10 | 1.0 | Initial story creation | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used
Claude Sonnet 4.5 (via Cursor)

### Debug Log References
N/A - No debug issues encountered during implementation

### Completion Notes
- **Task 1-3**: Created compliance filter service with prohibited phrase detection and state/product-specific disclaimer selection. All logic is 100% deterministic (no LLM calls).
- **Task 4**: Integrated compliance filter into intake endpoint. Compliance check runs on pitch before returning to frontend. Disclaimers included in IntakeResult response.
- **Task 5**: Policy analysis endpoint not implemented yet (Epic 2). Compliance filter ready for integration when endpoint is created.
- **Task 6**: Updated DecisionTrace schema to include full compliance check structure with state/productLine fields. Updated createDecisionTrace function to accept compliance check parameter.
- **Task 7**: Updated CompliancePanel component to receive disclaimers from backend. Removed stub logic. UnifiedChatInterface now passes disclaimers from IntakeResult to CompliancePanel.
- **Task 8**: Created comprehensive unit tests (51 tests, all passing). Tests cover prohibited phrase detection (16+ patterns), state/product disclaimer selection, combined disclaimers, and edge cases.
- **Task 9**: Added integration tests to existing intake.test.ts. Tests verify compliance check in response, disclaimers included, state/product-specific selection, and decision trace logging.
- **Task 10**: Updated PrefillPacketStub schema to include disclaimers field. Schema ready for Story 1.8 prefill generator implementation.

### File List
**Created Files:**
- `apps/api/src/services/compliance-filter.ts` - Compliance filter service with prohibited phrase detection and disclaimer selection
- `packages/shared/src/schemas/compliance-result.ts` - ComplianceResult schema and type
- `apps/api/src/services/__tests__/compliance-filter.test.ts` - Unit tests for compliance filter (51 tests)

**Modified Files:**
- `packages/shared/src/index.ts` - Added ComplianceResult export
- `packages/shared/src/schemas/decision-trace.ts` - Updated complianceCheck schema to include state/productLine fields
- `apps/api/src/utils/decision-trace.ts` - Updated createDecisionTrace to accept compliance check parameter
- `apps/api/src/routes/intake.ts` - Integrated compliance filter, added compliance check to decision trace, included disclaimers in response
- `packages/shared/src/schemas/intake-result.ts` - Added disclaimers field to IntakeResult schema, added disclaimers to PrefillPacketStub schema
- `apps/web/src/components/layout/CompliancePanel.tsx` - Updated to receive disclaimers prop from backend, removed stub logic
- `apps/web/src/components/intake/UnifiedChatInterface.tsx` - Added disclaimers state, updated to pass disclaimers from IntakeResult to CompliancePanel
- `apps/api/src/routes/__tests__/intake.test.ts` - Added compliance filter integration tests (7 new tests)

## QA Results

_This section will be populated by the QA agent during review_

