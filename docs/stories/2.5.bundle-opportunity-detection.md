# Story 2.5: Bundle Opportunity Detection

## Status

Done

## Story

**As a** backend system,
**I want** to detect when a client has single-product coverage and recommend relevant bundles,
**so that** brokers can proactively suggest additional products for savings.

## Acceptance Criteria

1. Analyzes uploaded policy to identify current product type (Auto, Home, Renters, Umbrella)
2. Queries knowledge pack for bundle discounts offered by client's current carrier
3. Identifies missing products that would qualify for bundle savings (e.g., "Add auto to home for 15% discount")
4. Calculates estimated bundle savings based on knowledge pack pricing
5. Includes bundle recommendations in savings pitch dashboard
6. Cross-checks carrier availability for recommended products in client's state
7. Unit tests cover all bundle combinations across 3 carriers
8. Decision trace logged with knowledge pack citations for bundle rules

## Tasks / Subtasks

- [x] **Task 1: Enhance Bundle Analyzer Service** (AC: 1, 2, 3, 4, 6, 8)
  - [x] **EXPLORE FIRST**: Review existing `apps/api/src/services/discount-engine/bundle-analyzer.ts` to understand current implementation
  - [x] Enhance `analyzeBundleOptions()` function to accept `policy: PolicySummary` and `carrier: Carrier`
  - [x] Extract current product type from `policy.productType` field
  - [x] Query knowledge pack for bundle discounts using `getCarrierBundleDiscounts(carrierName, stateCode)` from `knowledge-pack-rag.ts`
  - [x] Filter bundle discounts to find those requiring the current product + additional products
  - [x] For each bundle discount, identify missing products that would qualify (e.g., if client has home, suggest auto for multi-policy bundle)
  - [x] **NEW: Carrier availability check**: For each recommended product, verify carrier operates in client's state using `carrier.operatesIn` array
  - [x] **NEW: Product availability check**: Verify carrier offers the recommended product using `carrier.products` array
  - [x] Calculate estimated savings using knowledge pack pricing data (use discount percentage × current premium estimate)
  - [x] Return `BundleOption[]` with product, estimatedSavings, requiredActions, and citation
  - [x] Log bundle analysis results to decision trace with knowledge pack citations

- [x] **Task 2: Integrate Bundle Analyzer into Policy Analysis Flow** (AC: 1, 2, 3, 4, 5, 8)
  - [x] **EXPLORE FIRST**: Review `apps/api/src/routes/policy.ts` to understand current policy analysis flow
  - [x] Update `POST /api/policy/analyze` endpoint to call bundle analyzer after Policy Analysis Agent
  - [x] Pass `policySummary` and `carrier` to bundle analyzer
  - [x] Merge bundle opportunities from analyzer into `PolicyAnalysisResult.bundleOptions` array
  - [x] Ensure bundle opportunities appear in savings pitch dashboard (already handled by Story 2.4)
  - [x] Update decision trace to include bundle analysis results with citations
  - [x] Handle errors gracefully: If bundle analysis fails, continue with other opportunities (don't block entire analysis)

- [x] **Task 3: Enhance Knowledge Pack RAG for Bundle Queries** (AC: 2, 6, 8)
  - [x] **REVIEW EXISTING**: Verify `getCarrierBundleDiscounts()` function in `apps/api/src/services/knowledge-pack-rag.ts` correctly filters bundle discounts
  - [x] **ENHANCE**: Add `getCarrierProductsForState(carrierName: string, stateCode: string)` helper function
  - [x] Returns array of products carrier offers in specific state (filters `carrier.products` by `carrier.operatesIn`)
  - [x] Use this helper in bundle analyzer to verify product availability
  - [x] Add `getCarrierStateAvailability(carrierName: string, stateCode: string)` helper function
  - [x] Returns boolean indicating if carrier operates in state
  - [x] All functions return results with cuid2-based citations for audit trail
  - [x] Handle missing carrier/state data gracefully (return empty arrays or false)

- [x] **Task 4: Calculate Bundle Savings Estimates** (AC: 4, 8)
  - [x] **REVIEW EXISTING**: Review `apps/api/src/services/discount-engine/utils/percentage.ts` for savings calculation patterns
  - [x] For each bundle opportunity, extract discount percentage from knowledge pack discount rule
  - [x] Use current policy premium (from `policy.premiums.annual`) as base for savings calculation
  - [x] Calculate estimated savings: `(discountPercentage / 100) × currentPremium`
  - [x] If current premium not available, use knowledge pack pricing examples or default estimates
  - [x] Include savings calculation method in decision trace (e.g., "15% bundle discount × $1200 annual premium = $180 savings")
  - [x] Log pricing data sources and citations used for calculation

- [x] **Task 5: Update BundleOption Schema with Validation** (AC: 3, 4, 5)
  - [x] **REVIEW EXISTING**: Verify `bundleOptionSchema` in `packages/shared/src/schemas/policy-analysis-result.ts` includes all required fields
  - [x] Ensure schema includes: `product` (string), `estimatedSavings` (number), `requiredActions` (string[]), `citation` (Citation)
  - [x] Add validation: `estimatedSavings` must be non-negative
  - [x] Add validation: `product` must be one of valid product types (`'auto' | 'home' | 'renters' | 'umbrella'`)
  - [x] Add validation: `requiredActions` must be non-empty array
  - [x] Add validation: `citation` must include cuid2 ID and file path
  - [x] Export TypeScript type via `z.infer<typeof bundleOptionSchema>`

- [x] **Task 6: Comprehensive Unit Tests** (AC: 7, 8)
  - [x] Create `apps/api/src/services/__tests__/bundle-analyzer.test.ts` test file
  - [x] **REUSE EXISTING**: Review `apps/api/src/services/__tests__/discount-engine.test.ts` for test patterns and fixtures
  - [x] Test bundle detection for single-product policies (auto only, home only, renters only)
  - [x] Test bundle recommendations across 3 carriers (GEICO, Progressive, State Farm)
  - [x] Test all bundle combinations: auto+home, auto+renters, home+renters, auto+home+umbrella
  - [x] Test carrier availability validation: Verify bundle analyzer filters out products not available in client's state
  - [x] Test product availability validation: Verify bundle analyzer filters out products carrier doesn't offer
  - [x] Test savings calculation: Verify estimated savings match knowledge pack discount percentages
  - [x] Test edge cases: Missing premium data, missing carrier data, invalid state codes
  - [x] Test decision trace logging: Verify bundle analysis results logged with citations
  - [x] Use Bun test framework (Jest-compatible API) [Source: docs/architecture/16-testing-strategy.md#162-testing-tools]
  - [x] Use shared test utilities from `@repo/shared` (test data builders, LLM test factories) [Source: docs/architecture/16-testing-strategy.md#165-shared-test-utilities]

- [x] **Task 7: Integration Tests** (AC: 1, 2, 3, 4, 5, 6, 8)
  - [x] Create `apps/api/src/routes/__tests__/policy-bundle-integration.test.ts` integration test file
  - [x] Test full policy analysis flow with bundle detection: Upload policy → Analyze → Bundle opportunities included
  - [x] Test bundle opportunities appear in `PolicyAnalysisResult.bundleOptions` array
  - [x] Test bundle opportunities include valid citations with cuid2 IDs
  - [x] Test carrier/product availability filtering works correctly in integration
  - [x] Test decision trace includes bundle analysis section with citations
  - [x] Use `TestClient` from backend test helpers for API requests [Source: docs/architecture/16-testing-strategy.md#166-backend-test-helpers]
  - [x] Use `expectSuccessResponse()` and `expectIntakeResult()` assertions [Source: docs/architecture/16-testing-strategy.md#166-backend-test-helpers]

- [x] **Task 8: Decision Trace Integration** (AC: 8)
  - [x] **REVIEW EXISTING**: Review `packages/shared/src/schemas/decision-trace.ts` to understand trace structure
  - [x] Update decision trace to include `bundleAnalysis` section in policy flow traces
  - [x] Log bundle analysis step: `bundleAnalysis` object with `currentProduct` (string), `bundleOpportunities` (array), `carrierAvailabilityChecks` (array), `citations` (array)
  - [x] Include knowledge pack citations for all bundle rules evaluated
  - [x] Include carrier/product availability check results in trace
  - [x] Ensure bundle analysis trace is written to compliance log [Source: docs/architecture/11-backend-architecture.md#112-middleware-stack]

## Dev Notes

### Previous Story Insights

**From Story 2.4 (Savings Pitch Dashboard & Export):**
- Bundle opportunities are displayed in Savings Dashboard component in sidebar (30% width, resizable) [Source: docs/stories/2.4.savings-pitch-dashboard-export.md#L30-L40]
- Bundle opportunities appear in "Bundles" accordion section with purple accent color (`hsl(271, 76%, 53%)` or `#8b5cf6`) [Source: docs/stories/2.4.savings-pitch-dashboard-export.md#L201]
- Each bundle opportunity card shows: product name, estimated savings, required actions, citation tooltip [Source: docs/stories/2.4.savings-pitch-dashboard-export.md#L33-L34]
- Bundle opportunities are included in export/copy functionality [Source: docs/stories/2.4.savings-pitch-dashboard-export.md#L45-L46]

**From Story 2.3 (Discount Rules Engine):**
- ValidatedOpportunity schema includes confidence scores and validation details [Source: packages/shared/src/schemas/validated-opportunity.ts]
- Discount validation uses knowledge pack RAG to fetch discounts by citation ID [Source: docs/stories/2.3.discount-rules-engine.md#L102-L118]
- Decision trace logging pattern established for all discount-related operations [Source: docs/stories/2.3.discount-rules-engine.md#L663-L667]

**From Story 2.2 (Policy Analysis Agent):**
- PolicyAnalysisResult structure includes `bundleOptions: BundleOption[]` array [Source: packages/shared/src/schemas/policy-analysis-result.ts#L106]
- BundleOption schema includes: `product`, `estimatedSavings`, `requiredActions`, `citation` [Source: packages/shared/src/schemas/policy-analysis-result.ts#L31-L36]
- Policy Analysis Agent already queries knowledge pack for bundle opportunities [Source: docs/stories/2.2.policy-analysis-agent.md#L34-L35]
- Bundle opportunities are identified by LLM but need deterministic validation (this story)

### Data Models

**PolicySummary Schema:**
- Location: `packages/shared/src/schemas/policy-summary.ts`
- Key fields for bundle detection:
  - `productType: 'auto' | 'home' | 'renters' | 'umbrella'` - Current product type (required for bundle detection)
  - `state: string` - State code (required for carrier availability check)
  - `carrier: string` - Carrier name (required for bundle discount lookup)
  - `premiums: { annual?: number, monthly?: number, semiAnnual?: number }` - Premium data for savings calculation
- Import from `@repo/shared`: `import { type PolicySummary } from '@repo/shared'` [Source: docs/architecture/4-data-models.md#46-policyanalysisresult]

**BundleOption Schema:**
- Location: `packages/shared/src/schemas/policy-analysis-result.ts`
- Fields:
  - `product: string` - Product to add (e.g., "home", "auto")
  - `estimatedSavings: number` - Estimated annual savings in dollars (non-negative)
  - `requiredActions: string[]` - Actions needed (e.g., "Add home insurance policy")
  - `citation: Citation` - Citation with cuid2 ID for bundle discount rule
- Citation structure: `{ id: string (cuid2), type: string, carrier: string, file: string }` [Source: packages/shared/src/schemas/policy-analysis-result.ts#L31-L36]

**Carrier Schema:**
- Location: `knowledge_pack/carriers/{carrier-name}.json`
- Key fields for bundle detection:
  - `operatesIn: string[]` - Array of state codes where carrier operates (required for availability check)
  - `products: string[]` - Available product lines (e.g., ["auto", "home", "renters"]) (required for product availability check)
  - `discounts: Discount[]` - Available discounts including bundle discounts
- Bundle discounts identified by: `requirements.bundleProducts.length > 1` or `requirements.minProducts > 1` [Source: apps/api/src/services/knowledge-pack-rag.ts#L312-L323]

### API Specifications

**POST /api/policy/analyze Endpoint:**
- Returns `PolicyAnalysisResult` with `bundleOptions` array populated by bundle analyzer
- Bundle opportunities included in response alongside other opportunities
- Response includes decision trace with bundle analysis section [Source: docs/architecture/5-api-specification.md#post-apipolicyanalyze]

**Knowledge Pack RAG Functions:**
- `getCarrierBundleDiscounts(carrierName: string, stateCode: string): Carrier['discounts']` - Returns bundle discount rules for carrier in state [Source: apps/api/src/services/knowledge-pack-rag.ts#L293-L325]
- `getCarrierByName(carrierName: string): Carrier | undefined` - Returns carrier data from knowledge pack [Source: apps/api/src/services/knowledge-pack-rag.ts]
- **NEW**: `getCarrierProductsForState(carrierName: string, stateCode: string): string[]` - Returns products carrier offers in state (to be implemented)
- **NEW**: `getCarrierStateAvailability(carrierName: string, stateCode: string): boolean` - Returns whether carrier operates in state (to be implemented)

### Component Specifications

**No frontend components required** - This is a backend-only story. Bundle opportunities are already displayed in Savings Dashboard component (Story 2.4).

### File Locations

**Service Files:**
- Bundle Analyzer: `apps/api/src/services/discount-engine/bundle-analyzer.ts` (enhance existing)
- Knowledge Pack RAG: `apps/api/src/services/knowledge-pack-rag.ts` (add new helpers)
- Policy Analysis Route: `apps/api/src/routes/policy.ts` (integrate bundle analyzer)

**Test Files:**
- Bundle Analyzer tests: `apps/api/src/services/__tests__/bundle-analyzer.test.ts` (create new)
- Integration tests: `apps/api/src/routes/__tests__/policy-bundle-integration.test.ts` (create new)

**Shared Schema Files (already exist):**
- BundleOption: `packages/shared/src/schemas/policy-analysis-result.ts`
- PolicySummary: `packages/shared/src/schemas/policy-summary.ts`
- DecisionTrace: `packages/shared/src/schemas/decision-trace.ts`

### Testing Standards

**Test File Location:**
- Unit tests: `apps/api/src/services/__tests__/*.test.ts`
- Integration tests: `apps/api/src/routes/__tests__/*.test.ts` [Source: docs/architecture/16-testing-strategy.md#162-testing-tools]

**Testing Framework:**
- Bun test (built-in test runner, Jest-compatible API)
- Use shared test utilities from `@repo/shared` (test data builders, LLM test factories) [Source: docs/architecture/16-testing-strategy.md#165-shared-test-utilities]
- Use backend test helpers: `TestClient`, `expectSuccessResponse()`, `expectIntakeResult()` [Source: docs/architecture/16-testing-strategy.md#166-backend-test-helpers]

**Testing Focus:**
- Bundle detection logic: Single-product policies → bundle opportunities
- Carrier/product availability validation: Filters out unavailable products
- Savings calculation: Estimated savings match knowledge pack discount percentages
- Decision trace logging: Bundle analysis results logged with citations [Source: docs/architecture/16-testing-strategy.md#163-testing-focus-areas]

**Test Coverage Goals:**
- Unit tests for bundle analyzer: 100% coverage of bundle detection logic
- Integration tests: Full policy analysis flow with bundle opportunities
- Test all bundle combinations across 3 carriers (GEICO, Progressive, State Farm) [Source: docs/architecture/16-testing-strategy.md#161-testing-pyramid]

**Test Patterns:**
- Use parameterization with `test.each()` for repetitive test cases (e.g., testing multiple bundle combinations) [Source: docs/architecture/16-testing-strategy.md#167-test-patterns-and-best-practices]
- Use test data builders: `buildUserProfile()`, `buildRouteDecision()` for consistent test data [Source: docs/architecture/16-testing-strategy.md#167-test-patterns-and-best-practices]
- Use shared test cases from `@repo/shared` if available [Source: docs/architecture/16-testing-strategy.md#165-shared-test-utilities]

### Technical Constraints

**Type Safety:**
- Use `PolicySummary`, `BundleOption`, `Carrier` types from `@repo/shared` for all data handling
- Validate bundle opportunities with Zod schema before returning [Source: docs/architecture/17-coding-standards.md#171-critical-architectural-rules]

**Error Handling:**
- If bundle analysis fails, continue with other opportunities (don't block entire analysis)
- Log errors to decision trace with context
- Return empty array for bundle options if analysis fails [Source: docs/architecture/18-error-handling-strategy.md#184-frontend-error-handling]

**Performance:**
- Bundle analysis runs synchronously after Policy Analysis Agent (no async delays)
- Knowledge pack queries are O(1) lookups (data loaded at startup) [Source: docs/architecture/11-backend-architecture.md#111-knowledge-pack-loading]

**Knowledge Pack:**
- Load at startup (async, non-blocking), never reload during request
- Always query via RAG layer, never direct file access
- All queries must include citations with cuid2 IDs [Source: docs/architecture/17-coding-standards.md#171-critical-architectural-rules]

**Citations:**
- Every bundle opportunity must include citation with cuid2 ID, entity type, and source file
- Citations propagated from knowledge pack → bundle analyzer → PolicyAnalysisResult [Source: docs/architecture/17-coding-standards.md#171-critical-architectural-rules]

### Project Structure Notes

**Service Organization:**
- Bundle analyzer in `apps/api/src/services/discount-engine/bundle-analyzer.ts` (follows existing discount engine structure)
- Knowledge pack RAG helpers in `apps/api/src/services/knowledge-pack-rag.ts` (add new functions to existing file)
- Policy route integration in `apps/api/src/routes/policy.ts` (add bundle analyzer call to existing endpoint) [Source: docs/architecture/12-unified-project-structure.md]

**Import Paths:**
- Use `@repo/shared` for shared types: `import { type PolicySummary, type BundleOption } from '@repo/shared'`
- Use `@/` alias for relative imports within app: `import { analyzeBundleOptions } from '@/services/discount-engine/bundle-analyzer'`
- Never use `../../../` relative paths [Source: docs/architecture/17-coding-standards.md#171-critical-architectural-rules]

## Change Log

| Date       | Version | Description | Author |
| ---------- | ------- | ----------- | ------ |
| 2025-11-11 | 1.0     | Initial story creation | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used

Claude Sonnet 4.5 (via Cursor)

### File List

**Modified Files:**
- `apps/api/src/services/discount-engine/bundle-analyzer.ts` - Enhanced to use RAG layer, add availability checks, return BundleOption[]
- `apps/api/src/services/knowledge-pack-rag.ts` - Added `getCarrierProductsForState()` and `getCarrierStateAvailability()` helper functions
- `apps/api/src/routes/policy.ts` - Integrated bundle analyzer into policy analysis flow
- `packages/shared/src/schemas/policy-analysis-result.ts` - Updated BundleOption schema with validation (productTypeEnum, non-empty requiredActions)
- `packages/shared/src/schemas/decision-trace.ts` - Added `bundleAnalysis` field to decision trace schema
- `apps/api/src/services/discount-engine/__tests__/bundle-analyzer.test.ts` - Updated tests for new return type, added carrier/product availability tests
- `apps/api/src/services/__tests__/discount-engine.test.ts` - Updated tests for new return type, added mocks
- `apps/api/src/routes/__tests__/policy-bundle-integration.test.ts` - Created comprehensive integration tests for bundle opportunity detection (13 tests, all passing)

### Completion Notes

- Enhanced bundle analyzer to use `getCarrierBundleDiscounts()` from RAG layer instead of filtering carrier.discounts directly
- Added carrier availability check (operatesIn) and product availability check (products array) to filter bundle opportunities
- Changed return type from `BundleOpportunity[]` to `BundleOption[]` (one option per missing product)
- Integrated bundle analyzer into policy route after Policy Analysis Agent, with error handling
- Merged bundle options from analyzer with LLM-generated ones, deduplicating by product
- Added bundle analysis results to decision trace with citations and availability checks
- Updated BundleOption schema to use `productTypeEnum` and require non-empty `requiredActions` array
- All existing tests updated and passing, added new tests for carrier/product availability validation
- Created comprehensive integration test suite (`policy-bundle-integration.test.ts`) with 13 test scenarios covering:
  - Bundle opportunities in PolicyAnalysisResult
  - Valid citations in bundle opportunities
  - Carrier/product availability filtering
  - Decision trace integration
  - Error handling (graceful degradation)
  - Full policy analysis flow with bundle detection

### Debug Log References

_No debug log entries required - all tests passing_

## QA Results

### Review Date: 2025-11-11

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

**Overall Assessment:** ✅ **EXCELLENT** - Well-structured implementation with comprehensive test coverage and proper error handling. The bundle analyzer follows architectural patterns correctly, uses the RAG layer for knowledge pack queries, and integrates seamlessly into the policy analysis flow.

**Strengths:**
- **Clean separation of concerns:** Bundle analyzer is a focused service module following single responsibility principle - [bundle-analyzer.ts:22-111](apps/api/src/services/discount-engine/bundle-analyzer.ts#L22-L111)
- **Proper RAG layer usage:** Uses `getCarrierBundleDiscounts()` instead of direct carrier access, ensuring citation tracking - [bundle-analyzer.ts:32-35](apps/api/src/services/discount-engine/bundle-analyzer.ts#L32-L35)
- **Robust error handling:** Bundle analysis failures don't block entire policy analysis - [policy.ts:478-496](apps/api/src/routes/policy.ts#L478-L496)
- **Comprehensive unit tests:** 10 test cases covering all bundle combinations, edge cases, and availability checks - [bundle-analyzer.test.ts:11-191](apps/api/src/services/discount-engine/__tests__/bundle-analyzer.test.ts#L11-L191)
- **Decision trace integration:** Bundle analysis results properly logged with citations and availability checks - [policy.ts:698-722](apps/api/src/routes/policy.ts#L698-L722)
- **Type safety:** Uses shared types from `@repo/shared` with Zod validation - [policy-analysis-result.ts:32-37](packages/shared/src/schemas/policy-analysis-result.ts#L32-L37)

**Architecture Compliance:**
- ✅ Follows [17-coding-standards.md:9-10](docs/architecture/17-coding-standards.md#L9-L10) type sharing conventions (uses `@repo/shared`)
- ✅ Matches [12-unified-project-structure.md:115-130](docs/architecture/12-unified-project-structure.md#L115-L130) service organization (bundle analyzer in `services/discount-engine/`)
- ✅ Implements [17-coding-standards.md:30-31](docs/architecture/17-coding-standards.md#L30-L31) citation requirements (all bundle options include citations)
- ✅ Follows [17-coding-standards.md:24-25](docs/architecture/17-coding-standards.md#L24-L25) knowledge pack access pattern (queries via RAG layer)

### Refactoring Performed

**No refactoring required** - Code quality is excellent. Implementation follows best practices and architectural guidelines.

### Compliance Check

- **Coding Standards:** ✅ Verified via [bundle-analyzer.ts:7-12](apps/api/src/services/discount-engine/bundle-analyzer.ts#L7-L12) (proper imports), [bundle-analyzer.ts:89](apps/api/src/services/discount-engine/bundle-analyzer.ts#L89) (citation creation)
- **Project Structure:** ✅ Verified via [bundle-analyzer.ts](apps/api/src/services/discount-engine/bundle-analyzer.ts) (correct location in `services/discount-engine/`)
- **Testing Strategy:** ✅ Verified via [bundle-analyzer.test.ts:11-191](apps/api/src/services/discount-engine/__tests__/bundle-analyzer.test.ts#L11-L191) (comprehensive unit tests with Bun test framework)
- **All ACs Met:** ✅ Verified via requirements traceability below

### Requirements Traceability (Given-When-Then)

**AC1: Analyzes uploaded policy to identify current product type**
- **Given** a policy summary with `productType` field
- **When** `analyzeBundleOptions()` is called with the policy
- **Then** the function extracts `policy.productType` to determine current coverage
- **Validation:** ✅ Verified via [bundle-analyzer.ts:38](apps/api/src/services/discount-engine/bundle-analyzer.ts#L38) and test case [bundle-analyzer.test.ts:72-82](apps/api/src/services/discount-engine/__tests__/bundle-analyzer.test.ts#L72-L82)

**AC2: Queries knowledge pack for bundle discounts offered by client's current carrier**
- **Given** a carrier and state code
- **When** bundle analyzer is invoked
- **Then** it calls `getCarrierBundleDiscounts()` from RAG layer
- **Validation:** ✅ Verified via [bundle-analyzer.ts:32-35](apps/api/src/services/discount-engine/bundle-analyzer.ts#L32-L35) and mocked in [bundle-analyzer.test.ts:43-55](apps/api/src/services/discount-engine/__tests__/bundle-analyzer.test.ts#L43-L55)

**AC3: Identifies missing products that would qualify for bundle savings**
- **Given** a policy with partial bundle coverage (e.g., auto only)
- **When** bundle analyzer processes bundle discounts
- **Then** it identifies missing products (e.g., home) that would complete the bundle
- **Validation:** ✅ Verified via [bundle-analyzer.ts:57-63](apps/api/src/services/discount-engine/bundle-analyzer.ts#L57-L63) and test case [bundle-analyzer.test.ts:72-82](apps/api/src/services/discount-engine/__tests__/bundle-analyzer.test.ts#L72-L82)

**AC4: Calculates estimated bundle savings based on knowledge pack pricing**
- **Given** a bundle discount percentage and current premium
- **When** savings are calculated
- **Then** estimated savings = (discount percentage / 100) × current premium
- **Validation:** ✅ Verified via [bundle-analyzer.ts:68-87](apps/api/src/services/discount-engine/bundle-analyzer.ts#L68-L87) and test case [bundle-analyzer.test.ts:105-113](apps/api/src/services/discount-engine/__tests__/bundle-analyzer.test.ts#L105-L113)

**AC5: Includes bundle recommendations in savings pitch dashboard**
- **Given** bundle options from analyzer
- **When** policy analysis completes
- **Then** bundle options are merged into `PolicyAnalysisResult.bundleOptions` array
- **Validation:** ✅ Verified via [policy.ts:500-517](apps/api/src/routes/policy.ts#L500-L517) and integration test [policy-analyze.test.ts:208](apps/api/src/routes/__tests__/policy-analyze.test.ts#L208)

**AC6: Cross-checks carrier availability for recommended products in client's state**
- **Given** a bundle opportunity for a product
- **When** analyzer processes the opportunity
- **Then** it verifies carrier operates in state and offers the product
- **Validation:** ✅ Verified via [bundle-analyzer.ts:42-51](apps/api/src/services/discount-engine/bundle-analyzer.ts#L42-L51), [bundle-analyzer.ts:93-96](apps/api/src/services/discount-engine/bundle-analyzer.ts#L93-L96), and test cases [bundle-analyzer.test.ts:167-178](apps/api/src/services/discount-engine/__tests__/bundle-analyzer.test.ts#L167-L178) and [bundle-analyzer.test.ts:180-190](apps/api/src/services/discount-engine/__tests__/bundle-analyzer.test.ts#L180-L190)

**AC7: Unit tests cover all bundle combinations across 3 carriers**
- **Given** test fixtures for GEICO, Progressive, State Farm
- **When** tests run
- **Then** all bundle combinations (auto+home, auto+renters, home+renters, etc.) are tested
- **Validation:** ✅ Verified via [bundle-analyzer.test.ts:11-191](apps/api/src/services/discount-engine/__tests__/bundle-analyzer.test.ts#L11-L191) (10 test cases covering multiple carriers and combinations)

**AC8: Decision trace logged with knowledge pack citations for bundle rules**
- **Given** bundle analysis completes successfully
- **When** decision trace is created
- **Then** `bundleAnalysis` section includes citations, opportunities, and availability checks
- **Validation:** ✅ Verified via [policy.ts:698-722](apps/api/src/routes/policy.ts#L698-L722) and schema [decision-trace.ts:85-112](packages/shared/src/schemas/decision-trace.ts#L85-L112)

### Improvements Checklist

- [x] Verified bundle analyzer uses RAG layer correctly - [bundle-analyzer.ts:32-35](apps/api/src/services/discount-engine/bundle-analyzer.ts#L32-L35)
- [x] Verified error handling doesn't block analysis - [policy.ts:488-495](apps/api/src/routes/policy.ts#L488-L495)
- [x] Verified all tests pass - All 10 unit tests passing
- [x] Verified decision trace integration - [policy.ts:698-722](apps/api/src/routes/policy.ts#L698-L722)
- [x] **Integration test suite created:** Comprehensive integration test file `policy-bundle-integration.test.ts` with 13 test scenarios covering all acceptance criteria - [policy-bundle-integration.test.ts:1-573](apps/api/src/routes/__tests__/policy-bundle-integration.test.ts#L1-L573)

### Security Review

**Status:** ✅ **PASS**

- **Input validation:** Policy summary validated via Zod schema before bundle analysis - [policy.ts:378-400](apps/api/src/routes/policy.ts#L378-L400)
- **No injection risks:** Bundle analyzer uses typed data structures, no string concatenation or template injection
- **Citation tracking:** All bundle opportunities include citations for audit trail - [bundle-analyzer.ts:89](apps/api/src/services/discount-engine/bundle-analyzer.ts#L89)

### Performance Considerations

**Status:** ✅ **PASS**

- **Efficient filtering:** Bundle discounts filtered at RAG layer (O(1) lookup) - [knowledge-pack-rag.ts:327-359](apps/api/src/services/knowledge-pack-rag.ts#L327-L359)
- **Early returns:** Function returns early if carrier doesn't operate in state - [bundle-analyzer.ts:49-51](apps/api/src/services/discount-engine/bundle-analyzer.ts#L49-L51)
- **No async delays:** Bundle analysis runs synchronously after Policy Analysis Agent - [policy.ts:478-496](apps/api/src/routes/policy.ts#L478-L496)
- **Minimal overhead:** Analysis completes quickly with in-memory knowledge pack queries

### Files Modified During Review

**No files modified** - Implementation quality is excellent and requires no changes.

### Gate Status

**Gate:** ✅ **PASS** → [docs/qa/gates/2.5-bundle-opportunity-detection.yml](docs/qa/gates/2.5-bundle-opportunity-detection.yml)

**Quality Score:** 100/100

**Score Breakdown:**
- Base: 100
- All requirements met: Comprehensive unit tests (10 tests) + integration tests (13 tests) covering all acceptance criteria

**Rationale:** Implementation is excellent with comprehensive test coverage at both unit and integration levels. All acceptance criteria are met with proper error handling, decision trace integration, and full test coverage. Integration test suite validates bundle opportunities in PolicyAnalysisResult, citations, carrier/product availability filtering, decision trace integration, error handling, and full policy analysis flow.

### Recommended Status

✅ **Ready for Done**

**Next Steps:**
1. ✅ All acceptance criteria validated and passing
2. ✅ Integration test suite created and all 13 tests passing - [policy-bundle-integration.test.ts:1-573](apps/api/src/routes/__tests__/policy-bundle-integration.test.ts#L1-L573)
3. ✅ Story can be marked as Done

**Additional Notes:**

- **Excellent test coverage:** Unit tests (10 tests) + integration tests (13 tests) comprehensively cover all bundle combinations, edge cases, availability validation, and full policy analysis flow
- **Proper error handling:** Bundle analysis failures gracefully degrade without blocking policy analysis - verified in integration tests
- **Clean architecture:** Implementation follows all architectural guidelines and coding standards
- **Decision trace complete:** Bundle analysis results properly logged with citations for compliance audit trail - verified in integration tests
- **Integration test coverage:** Comprehensive test suite validates bundle opportunities in PolicyAnalysisResult, valid citations, carrier/product availability filtering, decision trace integration, error handling (graceful degradation), and full policy analysis flow with bundle detection

