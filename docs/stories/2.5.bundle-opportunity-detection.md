# Story 2.5: Bundle Opportunity Detection

## Status

Ready to Implement

## Story

**As a** backend system,
**I want** to detect when a client has single-product coverage and recommend relevant bundles,
**so that** brokers can proactively suggest additional products for savings.

## Acceptance Criteria

1. Analyzes uploaded policy to identify current product type (Auto, Home, Renters, Umbrella)
2. Queries knowledge pack for bundle discounts offered by client's current carrier
3. Identifies missing products that would qualify for bundle savings (e.g., "Add auto to home for 15% discount")
4. Calculates estimated bundle savings based on knowledge pack pricing
5. Includes bundle recommendations in savings pitch dashboard
6. Cross-checks carrier availability for recommended products in client's state
7. Unit tests cover all bundle combinations across 3 carriers
8. Decision trace logged with knowledge pack citations for bundle rules

## Tasks / Subtasks

- [ ] **Task 1: Enhance Bundle Analyzer Service** (AC: 1, 2, 3, 4, 6, 8)
  - [ ] **EXPLORE FIRST**: Review existing `apps/api/src/services/discount-engine/bundle-analyzer.ts` to understand current implementation
  - [ ] Enhance `analyzeBundleOptions()` function to accept `policy: PolicySummary` and `carrier: Carrier`
  - [ ] Extract current product type from `policy.productType` field
  - [ ] Query knowledge pack for bundle discounts using `getCarrierBundleDiscounts(carrierName, stateCode)` from `knowledge-pack-rag.ts`
  - [ ] Filter bundle discounts to find those requiring the current product + additional products
  - [ ] For each bundle discount, identify missing products that would qualify (e.g., if client has home, suggest auto for multi-policy bundle)
  - [ ] **NEW: Carrier availability check**: For each recommended product, verify carrier operates in client's state using `carrier.operatesIn` array
  - [ ] **NEW: Product availability check**: Verify carrier offers the recommended product using `carrier.products` array
  - [ ] Calculate estimated savings using knowledge pack pricing data (use discount percentage × current premium estimate)
  - [ ] Return `BundleOpportunity[]` with product, estimatedSavings, requiredActions, and citation
  - [ ] Log bundle analysis results to decision trace with knowledge pack citations

- [ ] **Task 2: Integrate Bundle Analyzer into Policy Analysis Flow** (AC: 1, 2, 3, 4, 5, 8)
  - [ ] **EXPLORE FIRST**: Review `apps/api/src/routes/policy.ts` to understand current policy analysis flow
  - [ ] Update `POST /api/policy/analyze` endpoint to call bundle analyzer after Policy Analysis Agent
  - [ ] Pass `policySummary` and `carrier` to bundle analyzer
  - [ ] Merge bundle opportunities from analyzer into `PolicyAnalysisResult.bundleOptions` array
  - [ ] Ensure bundle opportunities appear in savings pitch dashboard (already handled by Story 2.4)
  - [ ] Update decision trace to include bundle analysis results with citations
  - [ ] Handle errors gracefully: If bundle analysis fails, continue with other opportunities (don't block entire analysis)

- [ ] **Task 3: Enhance Knowledge Pack RAG for Bundle Queries** (AC: 2, 6, 8)
  - [ ] **REVIEW EXISTING**: Verify `getCarrierBundleDiscounts()` function in `apps/api/src/services/knowledge-pack-rag.ts` correctly filters bundle discounts
  - [ ] **ENHANCE**: Add `getCarrierProductsForState(carrierName: string, stateCode: string)` helper function
  - [ ] Returns array of products carrier offers in specific state (filters `carrier.products` by `carrier.operatesIn`)
  - [ ] Use this helper in bundle analyzer to verify product availability
  - [ ] Add `getCarrierStateAvailability(carrierName: string, stateCode: string)` helper function
  - [ ] Returns boolean indicating if carrier operates in state
  - [ ] All functions return results with cuid2-based citations for audit trail
  - [ ] Handle missing carrier/state data gracefully (return empty arrays or false)

- [ ] **Task 4: Calculate Bundle Savings Estimates** (AC: 4, 8)
  - [ ] **REVIEW EXISTING**: Review `apps/api/src/services/discount-engine/utils/percentage.ts` for savings calculation patterns
  - [ ] For each bundle opportunity, extract discount percentage from knowledge pack discount rule
  - [ ] Use current policy premium (from `policy.premiums.annual`) as base for savings calculation
  - [ ] Calculate estimated savings: `(discountPercentage / 100) × currentPremium`
  - [ ] If current premium not available, use knowledge pack pricing examples or default estimates
  - [ ] Include savings calculation method in decision trace (e.g., "15% bundle discount × $1200 annual premium = $180 savings")
  - [ ] Log pricing data sources and citations used for calculation

- [ ] **Task 5: Update BundleOption Schema with Validation** (AC: 3, 4, 5)
  - [ ] **REVIEW EXISTING**: Verify `bundleOptionSchema` in `packages/shared/src/schemas/policy-analysis-result.ts` includes all required fields
  - [ ] Ensure schema includes: `product` (string), `estimatedSavings` (number), `requiredActions` (string[]), `citation` (Citation)
  - [ ] Add validation: `estimatedSavings` must be non-negative
  - [ ] Add validation: `product` must be one of valid product types (`'auto' | 'home' | 'renters' | 'umbrella'`)
  - [ ] Add validation: `requiredActions` must be non-empty array
  - [ ] Add validation: `citation` must include cuid2 ID and file path
  - [ ] Export TypeScript type via `z.infer<typeof bundleOptionSchema>`

- [ ] **Task 6: Comprehensive Unit Tests** (AC: 7, 8)
  - [ ] Create `apps/api/src/services/__tests__/bundle-analyzer.test.ts` test file
  - [ ] **REUSE EXISTING**: Review `apps/api/src/services/__tests__/discount-engine.test.ts` for test patterns and fixtures
  - [ ] Test bundle detection for single-product policies (auto only, home only, renters only)
  - [ ] Test bundle recommendations across 3 carriers (GEICO, Progressive, State Farm)
  - [ ] Test all bundle combinations: auto+home, auto+renters, home+renters, auto+home+umbrella
  - [ ] Test carrier availability validation: Verify bundle analyzer filters out products not available in client's state
  - [ ] Test product availability validation: Verify bundle analyzer filters out products carrier doesn't offer
  - [ ] Test savings calculation: Verify estimated savings match knowledge pack discount percentages
  - [ ] Test edge cases: Missing premium data, missing carrier data, invalid state codes
  - [ ] Test decision trace logging: Verify bundle analysis results logged with citations
  - [ ] Use Bun test framework (Jest-compatible API) [Source: docs/architecture/16-testing-strategy.md#162-testing-tools]
  - [ ] Use shared test utilities from `@repo/shared` (test data builders, LLM test factories) [Source: docs/architecture/16-testing-strategy.md#165-shared-test-utilities]

- [ ] **Task 7: Integration Tests** (AC: 1, 2, 3, 4, 5, 6, 8)
  - [ ] Create `apps/api/src/routes/__tests__/policy-bundle-integration.test.ts` integration test file
  - [ ] Test full policy analysis flow with bundle detection: Upload policy → Analyze → Bundle opportunities included
  - [ ] Test bundle opportunities appear in `PolicyAnalysisResult.bundleOptions` array
  - [ ] Test bundle opportunities include valid citations with cuid2 IDs
  - [ ] Test carrier/product availability filtering works correctly in integration
  - [ ] Test decision trace includes bundle analysis section with citations
  - [ ] Use `TestClient` from backend test helpers for API requests [Source: docs/architecture/16-testing-strategy.md#166-backend-test-helpers]
  - [ ] Use `expectSuccessResponse()` and `expectIntakeResult()` assertions [Source: docs/architecture/16-testing-strategy.md#166-backend-test-helpers]

- [ ] **Task 8: Decision Trace Integration** (AC: 8)
  - [ ] **REVIEW EXISTING**: Review `packages/shared/src/schemas/decision-trace.ts` to understand trace structure
  - [ ] Update decision trace to include `bundleAnalysis` section in policy flow traces
  - [ ] Log bundle analysis step: `bundleAnalysis` object with `currentProduct` (string), `bundleOpportunities` (array), `carrierAvailabilityChecks` (array), `citations` (array)
  - [ ] Include knowledge pack citations for all bundle rules evaluated
  - [ ] Include carrier/product availability check results in trace
  - [ ] Ensure bundle analysis trace is written to compliance log [Source: docs/architecture/11-backend-architecture.md#112-middleware-stack]

## Dev Notes

### Previous Story Insights

**From Story 2.4 (Savings Pitch Dashboard & Export):**
- Bundle opportunities are displayed in Savings Dashboard component in sidebar (30% width, resizable) [Source: docs/stories/2.4.savings-pitch-dashboard-export.md#L30-L40]
- Bundle opportunities appear in "Bundles" accordion section with purple accent color (`hsl(271, 76%, 53%)` or `#8b5cf6`) [Source: docs/stories/2.4.savings-pitch-dashboard-export.md#L201]
- Each bundle opportunity card shows: product name, estimated savings, required actions, citation tooltip [Source: docs/stories/2.4.savings-pitch-dashboard-export.md#L33-L34]
- Bundle opportunities are included in export/copy functionality [Source: docs/stories/2.4.savings-pitch-dashboard-export.md#L45-L46]

**From Story 2.3 (Discount Rules Engine):**
- ValidatedOpportunity schema includes confidence scores and validation details [Source: packages/shared/src/schemas/validated-opportunity.ts]
- Discount validation uses knowledge pack RAG to fetch discounts by citation ID [Source: docs/stories/2.3.discount-rules-engine.md#L102-L118]
- Decision trace logging pattern established for all discount-related operations [Source: docs/stories/2.3.discount-rules-engine.md#L663-L667]

**From Story 2.2 (Policy Analysis Agent):**
- PolicyAnalysisResult structure includes `bundleOptions: BundleOption[]` array [Source: packages/shared/src/schemas/policy-analysis-result.ts#L106]
- BundleOption schema includes: `product`, `estimatedSavings`, `requiredActions`, `citation` [Source: packages/shared/src/schemas/policy-analysis-result.ts#L31-L36]
- Policy Analysis Agent already queries knowledge pack for bundle opportunities [Source: docs/stories/2.2.policy-analysis-agent.md#L34-L35]
- Bundle opportunities are identified by LLM but need deterministic validation (this story)

### Data Models

**PolicySummary Schema:**
- Location: `packages/shared/src/schemas/policy-summary.ts`
- Key fields for bundle detection:
  - `productType: 'auto' | 'home' | 'renters' | 'umbrella'` - Current product type (required for bundle detection)
  - `state: string` - State code (required for carrier availability check)
  - `carrier: string` - Carrier name (required for bundle discount lookup)
  - `premiums: { annual?: number, monthly?: number, semiAnnual?: number }` - Premium data for savings calculation
- Import from `@repo/shared`: `import { type PolicySummary } from '@repo/shared'` [Source: docs/architecture/4-data-models.md#46-policyanalysisresult]

**BundleOption Schema:**
- Location: `packages/shared/src/schemas/policy-analysis-result.ts`
- Fields:
  - `product: string` - Product to add (e.g., "home", "auto")
  - `estimatedSavings: number` - Estimated annual savings in dollars (non-negative)
  - `requiredActions: string[]` - Actions needed (e.g., "Add home insurance policy")
  - `citation: Citation` - Citation with cuid2 ID for bundle discount rule
- Citation structure: `{ id: string (cuid2), type: string, carrier: string, file: string }` [Source: packages/shared/src/schemas/policy-analysis-result.ts#L31-L36]

**Carrier Schema:**
- Location: `knowledge_pack/carriers/{carrier-name}.json`
- Key fields for bundle detection:
  - `operatesIn: string[]` - Array of state codes where carrier operates (required for availability check)
  - `products: string[]` - Available product lines (e.g., ["auto", "home", "renters"]) (required for product availability check)
  - `discounts: Discount[]` - Available discounts including bundle discounts
- Bundle discounts identified by: `requirements.bundleProducts.length > 1` or `requirements.minProducts > 1` [Source: apps/api/src/services/knowledge-pack-rag.ts#L312-L323]

### API Specifications

**POST /api/policy/analyze Endpoint:**
- Returns `PolicyAnalysisResult` with `bundleOptions` array populated by bundle analyzer
- Bundle opportunities included in response alongside other opportunities
- Response includes decision trace with bundle analysis section [Source: docs/architecture/5-api-specification.md#post-apipolicyanalyze]

**Knowledge Pack RAG Functions:**
- `getCarrierBundleDiscounts(carrierName: string, stateCode: string): Carrier['discounts']` - Returns bundle discount rules for carrier in state [Source: apps/api/src/services/knowledge-pack-rag.ts#L293-L325]
- `getCarrierByName(carrierName: string): Carrier | undefined` - Returns carrier data from knowledge pack [Source: apps/api/src/services/knowledge-pack-rag.ts]
- **NEW**: `getCarrierProductsForState(carrierName: string, stateCode: string): string[]` - Returns products carrier offers in state (to be implemented)
- **NEW**: `getCarrierStateAvailability(carrierName: string, stateCode: string): boolean` - Returns whether carrier operates in state (to be implemented)

### Component Specifications

**No frontend components required** - This is a backend-only story. Bundle opportunities are already displayed in Savings Dashboard component (Story 2.4).

### File Locations

**Service Files:**
- Bundle Analyzer: `apps/api/src/services/discount-engine/bundle-analyzer.ts` (enhance existing)
- Knowledge Pack RAG: `apps/api/src/services/knowledge-pack-rag.ts` (add new helpers)
- Policy Analysis Route: `apps/api/src/routes/policy.ts` (integrate bundle analyzer)

**Test Files:**
- Bundle Analyzer tests: `apps/api/src/services/__tests__/bundle-analyzer.test.ts` (create new)
- Integration tests: `apps/api/src/routes/__tests__/policy-bundle-integration.test.ts` (create new)

**Shared Schema Files (already exist):**
- BundleOption: `packages/shared/src/schemas/policy-analysis-result.ts`
- PolicySummary: `packages/shared/src/schemas/policy-summary.ts`
- DecisionTrace: `packages/shared/src/schemas/decision-trace.ts`

### Testing Standards

**Test File Location:**
- Unit tests: `apps/api/src/services/__tests__/*.test.ts`
- Integration tests: `apps/api/src/routes/__tests__/*.test.ts` [Source: docs/architecture/16-testing-strategy.md#162-testing-tools]

**Testing Framework:**
- Bun test (built-in test runner, Jest-compatible API)
- Use shared test utilities from `@repo/shared` (test data builders, LLM test factories) [Source: docs/architecture/16-testing-strategy.md#165-shared-test-utilities]
- Use backend test helpers: `TestClient`, `expectSuccessResponse()`, `expectIntakeResult()` [Source: docs/architecture/16-testing-strategy.md#166-backend-test-helpers]

**Testing Focus:**
- Bundle detection logic: Single-product policies → bundle opportunities
- Carrier/product availability validation: Filters out unavailable products
- Savings calculation: Estimated savings match knowledge pack discount percentages
- Decision trace logging: Bundle analysis results logged with citations [Source: docs/architecture/16-testing-strategy.md#163-testing-focus-areas]

**Test Coverage Goals:**
- Unit tests for bundle analyzer: 100% coverage of bundle detection logic
- Integration tests: Full policy analysis flow with bundle opportunities
- Test all bundle combinations across 3 carriers (GEICO, Progressive, State Farm) [Source: docs/architecture/16-testing-strategy.md#161-testing-pyramid]

**Test Patterns:**
- Use parameterization with `test.each()` for repetitive test cases (e.g., testing multiple bundle combinations) [Source: docs/architecture/16-testing-strategy.md#167-test-patterns-and-best-practices]
- Use test data builders: `buildUserProfile()`, `buildRouteDecision()` for consistent test data [Source: docs/architecture/16-testing-strategy.md#167-test-patterns-and-best-practices]
- Use shared test cases from `@repo/shared` if available [Source: docs/architecture/16-testing-strategy.md#165-shared-test-utilities]

### Technical Constraints

**Type Safety:**
- Use `PolicySummary`, `BundleOption`, `Carrier` types from `@repo/shared` for all data handling
- Validate bundle opportunities with Zod schema before returning [Source: docs/architecture/17-coding-standards.md#171-critical-architectural-rules]

**Error Handling:**
- If bundle analysis fails, continue with other opportunities (don't block entire analysis)
- Log errors to decision trace with context
- Return empty array for bundle options if analysis fails [Source: docs/architecture/18-error-handling-strategy.md#184-frontend-error-handling]

**Performance:**
- Bundle analysis runs synchronously after Policy Analysis Agent (no async delays)
- Knowledge pack queries are O(1) lookups (data loaded at startup) [Source: docs/architecture/11-backend-architecture.md#111-knowledge-pack-loading]

**Knowledge Pack:**
- Load at startup (async, non-blocking), never reload during request
- Always query via RAG layer, never direct file access
- All queries must include citations with cuid2 IDs [Source: docs/architecture/17-coding-standards.md#171-critical-architectural-rules]

**Citations:**
- Every bundle opportunity must include citation with cuid2 ID, entity type, and source file
- Citations propagated from knowledge pack → bundle analyzer → PolicyAnalysisResult [Source: docs/architecture/17-coding-standards.md#171-critical-architectural-rules]

### Project Structure Notes

**Service Organization:**
- Bundle analyzer in `apps/api/src/services/discount-engine/bundle-analyzer.ts` (follows existing discount engine structure)
- Knowledge pack RAG helpers in `apps/api/src/services/knowledge-pack-rag.ts` (add new functions to existing file)
- Policy route integration in `apps/api/src/routes/policy.ts` (add bundle analyzer call to existing endpoint) [Source: docs/architecture/12-unified-project-structure.md]

**Import Paths:**
- Use `@repo/shared` for shared types: `import { type PolicySummary, type BundleOption } from '@repo/shared'`
- Use `@/` alias for relative imports within app: `import { analyzeBundleOptions } from '@/services/discount-engine/bundle-analyzer'`
- Never use `../../../` relative paths [Source: docs/architecture/17-coding-standards.md#171-critical-architectural-rules]

## Change Log

| Date       | Version | Description | Author |
| ---------- | ------- | ----------- | ------ |
| 2025-11-11 | 1.0     | Initial story creation | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used

_To be populated by Dev Agent_

### File List

_To be populated by Dev Agent_

### Completion Notes

_To be populated by Dev Agent_

### Debug Log References

_To be populated by Dev Agent_

## QA Results

_To be populated by QA Agent_

