# Story 4.5: Implement Pill Injection on "Save Known"

## Status

Ready for Review

## Story

**As a** broker,
**I want** clicking [Save Known] to inject a pill at the end of my notes,
**so that** the converted inferred field becomes part of my explicit notes and is treated as a known field going forward.

## Acceptance Criteria

1. Clicking [Save Known] injects pill at END of lexical text
2. Pill format: `{fieldKey}:{value}` (e.g., `ownsHome:false`)
3. Pill styled as green valid pill
4. Space added before pill if needed
5. Cursor positioned after pill
6. Space added after pill
7. Field removed from inferred section
8. Field updated in sidebar (normal style, no [✕])
9. All pill injection tests pass

## Tasks / Subtasks

- [x] **Task 1: Create usePillInjection hook** (AC: 1, 2, 3, 4, 5)
  - [x] Create `apps/web/src/hooks/usePillInjection.ts`
  - [x] Define hook interface:
    - [x] `injectPill(fieldKey: string, value: any): void` - Injects pill into lexical editor
    - [x] Requires lexical editor reference as parameter
  - [x] Implement pill injection logic:
    - [x] Use `editor.update()` to modify lexical document
    - [x] Get root node using `$getRoot()`
    - [x] Find last paragraph node or create new one
    - [x] Check if space needed before pill
    - [x] Create PillNode with key/value and validation="valid"
    - [x] Append pill to paragraph (pillNode)
    - [x] Append ' ' to paragraph (textNode)
    - [x] Set cursor position after pill
  - [x] Format field value correctly:
    - [x] Boolean: `true` → "true", `false` → "false"
    - [x] Number: convert to string
    - [x] String: use as-is
  - [x] Add comprehensive JSDoc comments

- [x] **Task 2: Integrate pill injection with "Save Known" button** (AC: 1, 6, 7)
  - [x] Open `apps/web/src/components/shortcuts/FieldModal.tsx`
  - [x] Import `usePillInjection` hook
  - [x] Get lexical editor reference from context or props
  - [x] Update `handleSaveKnown` callback:
    - [x] Call `injectPill(fieldName, value)` to add pill
    - [x] Call `onSaveKnown(fieldName, value)` to update state
    - [x] Close modal
  - [x] Ensure proper cleanup and error handling

- [x] **Task 3: Update state management for field conversion** (AC: 6, 7)
  - [x] Open `apps/web/src/components/notes/NotesPanel.tsx`
  - [x] Implement `handleConvertToKnown` callback:
    - [x] Remove field from inferred fields state
    - [x] Add field to known fields state
    - [x] Remove from suppression list (if present)
    - [x] Update captured fields sidebar to reflect change
  - [x] Pass `handleConvertToKnown` to InferredFieldsSection
  - [x] Ensure state updates trigger re-renders correctly

- [x] **Task 4: Update InferredFieldsSection integration** (AC: 6)
  - [x] Open `apps/web/src/components/notes/InferredFieldsSection.tsx`
  - [x] Verify `onConvertToKnown` callback is wired to [Click] button modal
  - [x] Ensure field is removed from inferred section after conversion
  - [x] Add visual feedback during conversion (optional loading state)

- [x] **Task 5: Get lexical editor reference** (AC: 1)
  - [x] Determine best approach to access lexical editor in modal:
    - [x] Option A: Pass editor ref as prop to FieldModal
    - [x] Option B: Create React context for lexical editor
    - [x] Option C: Use existing editor context if available
  - [x] Implement chosen approach
  - [x] Document decision in Dev Notes
  - [x] Ensure editor reference is available when modal opens

- [x] **Task 6: Format pill value correctly** (AC: 2)
  - [x] Create helper function `formatPillValue(value: any): string`
  - [x] Handle different value types:
    - [x] Boolean: `true` → "true", `false` → "false"
    - [x] Number: `42` → "42"
    - [x] String: use as-is
    - [x] Array: JSON.stringify (for multi-value fields)
    - [x] Object: JSON.stringify (for complex fields)
  - [x] Add unit tests for value formatting
  - [x] Handle edge cases: null, undefined, empty string

- [x] **Task 7: Create comprehensive pill injection tests** (AC: 8)
  - [x] Create or update test file: `apps/web/src/hooks/usePillInjection.test.ts`
  - [x] **Pill injection tests:**
    - [x] Test: Pill injected at end of existing text
    - [x] Test: Pill format is `{fieldKey}:{value}`
    - [x] Test: Space added before pill if needed
    - [x] Test: No space added if text already ends with space
    - [x] Test: Pill created in new paragraph if editor is empty
    - [x] Test: Cursor positioned after pill
  - [x] **Value formatting tests:**
    - [x] Test: Boolean true → "true"
    - [x] Test: Boolean false → "false"
    - [x] Test: Number → string conversion
    - [x] Test: String → unchanged
  - [x] **State update tests:**
    - [x] Test: Field removed from inferred section
    - [x] Test: Field added to known fields
    - [x] Test: Sidebar updated with normal styling
  - [x] **Integration tests:**
    - [x] Test: Full flow from [Save Known] click to pill injection
    - [x] Test: Modal closes after successful injection
  - [x] Run tests: `bun test apps/web/src/hooks/usePillInjection.test.ts`
  - [x] Verify >90% hook coverage

- [x] **Task 8: Verify TypeScript compilation** (AC: 1)
  - [x] Run `bun run type-check` in root directory
  - [x] Verify no compilation errors in web app
  - [x] Verify usePillInjection hook properly typed
  - [x] Fix any type errors

- [x] **Task 9: Test pill injection in browser** (AC: 1, 2, 3, 4, 5)
  - [x] Start development server: `bun run dev`
  - [x] Navigate to notes panel with lexical editor
  - [x] Create inferred field (e.g., type "FL renters" to infer ownsHome:false)
  - [x] Click [Click] on inferred field to open modal
  - [x] Click [Save Known] button
  - [x] Verify:
    - [x] Pill appears at end of notes text
    - [x] Pill shows correct format: `ownsHome:false`
    - [x] Pill is styled as green valid pill
    - [x] Space added before pill if needed
    - [x] Cursor positioned after pill
    - [x] Field removed from inferred section
    - [x] Field appears in sidebar with normal styling (no [✕])
  - [x] Test edge cases: empty editor, text ending with space, multiple conversions

## Dev Notes

This story implements **pill injection** for the **known vs inferred pills architecture** (Epic 4: Field Extraction Bulletproofing). When a broker converts an inferred field to known via [Save Known] button, the system injects a pill at the end of the notes textbox, making the field explicitly part of the broker's notes.

**Context from Previous Stories:**

- Story 4.1 created inference config files
- Story 4.2 implemented InferenceEngine
- Story 4.3 created InferredFieldsSection UI component
- Story 4.4 created 3-button modal with [Save Known] button
- This story implements the [Save Known] action (pill injection)

**Architecture References:**

[Source: docs/architecture/field-extraction-bulletproofing.md]

### Pill Injection Flow

**User Action Flow:** [Source: field-extraction-bulletproofing.md#480-523]

**Before conversion:**
```
Lexical textbox:
Client needs renters in FL. Age 28. Lives alone. [state:FL]
[productType:renters] [age:28]

Inferred Fields section:
└─ Owns Home: No (75%)  ℹ️ [✕] [Click]
└─ Household Size: 1 (82%)  ℹ️ [✕] [Click]

Captured Fields sidebar:
└─ Owns Home: No (75%)  ℹ️ [✕] [Click]  ← muted, inferred
```

**After clicking [Save Known] on Owns Home:**
```
Lexical textbox:
Client needs renters in FL. Age 28. Lives alone. [state:FL]
[productType:renters] [age:28] [ownsHome:false]  ← NEW PILL ' ' ← text node with space after new pill

Inferred Fields section:
└─ Household Size: 1 (82%)  ℹ️ [✕] [Click]  ← only one left

Captured Fields sidebar:
└─ Owns Home: No  ℹ️ [Click]  ← normal style, no [✕], known field
```

### Technical Implementation

**Pill Injection Logic:** [Source: field-extraction-bulletproofing.md#1040-1084]

```typescript
// In usePillInjection.ts hook
export function usePillInjection(editor: LexicalEditor | null) {
  const injectPill = useCallback((fieldKey: string, value: unknown) => {
    if (!editor) {
      console.error('Lexical editor not available')
      return
    }

    editor.update(() => {
      // Get root node
      const root = $getRoot()

      // Find last paragraph node (or create one)
      const lastChild = root.getLastChild()
      let paragraph: ParagraphNode

      if (lastChild && $isParagraphNode(lastChild)) {
        paragraph = lastChild
      } else {
        paragraph = $createParagraphNode()
        root.append(paragraph)
      }

      // Add space if last node is not whitespace
      const lastNode = paragraph.getLastChild()
      if (lastNode && !lastNode.getTextContent().endsWith(' ')) {
        paragraph.append($createTextNode(' '))
      }

      // Create pill node
      const pillNode = $createPillNode({
        key: fieldKey,
        value: formatPillValue(value),
        validation: 'valid' as ValidationResult,
        fieldName: fieldKey
      })

      // Append pill
      paragraph.append(pillNode)

      // Focus at end
      const selection = $createRangeSelection()
      selection.focus.set(paragraph.getKey(), paragraph.getChildrenSize(), 'element')
      $setSelection(selection)
    })
  }, [editor])

  return { injectPill }
}
```

**Value Formatting:**

```typescript
function formatPillValue(value: unknown): string {
  if (typeof value === 'boolean') {
    return value.toString() // "true" or "false"
  }
  if (typeof value === 'number') {
    return value.toString()
  }
  if (typeof value === 'string') {
    return value
  }
  if (Array.isArray(value)) {
    return JSON.stringify(value)
  }
  if (typeof value === 'object' && value !== null) {
    return JSON.stringify(value)
  }
  return String(value)
}
```

**Lexical Editor Reference:**

Based on existing codebase patterns, the lexical editor is likely available via:
- React context (preferred for global access)
- Ref passed down from NotesPanel
- Editor instance stored in component state

**Implementation Decision:** Use React context if available, otherwise pass editor ref as prop to FieldModal.

### PillNode Structure

[Source: apps/web/src/components/notes/nodes/PillNode.tsx]

**PillNode Interface:**

```typescript
export interface PillNodePayload {
  key: string         // Field key (e.g., "ownsHome", "k", "state")
  value: string       // Field value as string (e.g., "false", "3", "FL")
  validation: ValidationResult  // "valid" | "invalid_key" | "invalid_value"
  fieldName?: string  // Full field name (e.g., "ownsHome" for key "o")
}

export type ValidationResult = 'valid' | 'invalid_key' | 'invalid_value'
```

**Creating Pills:**

```typescript
import { $createPillNode } from '@/components/notes/nodes/PillNode'

const pillNode = $createPillNode({
  key: 'ownsHome',       // Field key
  value: 'false',         // Value as string
  validation: 'valid',    // Always 'valid' for converted fields
  fieldName: 'ownsHome'   // Full field name
})
```

**Pill Styling:**

Pills are styled based on validation result:
- `valid` → Green pill (text-green-700, bg-green-50, border-green-200)
- `invalid_key` → Red pill (unknown field key)
- `invalid_value` → Yellow pill (invalid value type)

Since we're converting known inferred fields, always use `validation: 'valid'`.

### State Management

**State Updates After Pill Injection:**

```typescript
// In NotesPanel.tsx
function handleConvertToKnown(fieldName: string, value: unknown) {
  // 1. Inject pill into lexical editor
  injectPill(fieldName, value)

  // 2. Update state: remove from inferred, add to known
  setInferredFields(prev => {
    const updated = { ...prev }
    delete updated[fieldName]
    return updated
  })

  setKnownFields(prev => ({
    ...prev,
    [fieldName]: value
  }))

  // 3. Remove from suppression list if present
  suppressionManager.removeSuppression(fieldName)

  // 4. State updates will trigger re-renders:
  //    - InferredFieldsSection will hide field
  //    - CapturedFields sidebar will update styling
}
```

### Integration Points

**FieldModal Integration:**

```typescript
// In FieldModal.tsx
import { useLexicalComposerContext } from '@lexical/react/LexicalComposerContext'
import { usePillInjection } from '@/hooks/usePillInjection'

export function FieldModal({ /* ...props */ }) {
  const [editor] = useLexicalComposerContext()
  const { injectPill } = usePillInjection(editor)

  function handleSaveKnown() {
    // Inject pill
    injectPill(fieldName, value)

    // Call parent callback to update state
    onSaveKnown?.(value)

    // Close modal
    onClose()
  }

  // ...rest of modal
}
```

**InferredFieldsSection Integration:**

Already wired in Story 4.3:
```typescript
<InferredFieldsSection
  inferredFields={inferredFields}
  inferenceReasons={inferenceReasons}
  confidence={confidence}
  onDismiss={handleDismiss}
  onEdit={handleEdit}
  onConvertToKnown={handleConvertToKnown}  // ← Calls pill injection
/>
```

### Lexical API Reference

**Key Lexical Functions:**

```typescript
import {
  $getRoot,
  $createParagraphNode,
  $createTextNode,
  $createRangeSelection,
  $setSelection,
  $isParagraphNode,
  ParagraphNode
} from 'lexical'

// Get document root
const root = $getRoot()

// Create nodes
const paragraph = $createParagraphNode()
const text = $createTextNode(' ')

// Check node type
if ($isParagraphNode(node)) { /* ... */ }

// Append nodes
paragraph.append(text)
paragraph.append(pillNode)
root.append(paragraph)

// Set cursor position
const selection = $createRangeSelection()
selection.focus.set(paragraphKey, childIndex, 'element')
$setSelection(selection)
```

**Important:** All Lexical mutations must happen inside `editor.update()` callback.

### Testing Strategy

[Source: architecture/16-testing-strategy.md]

**Test File Location:** `apps/web/src/hooks/usePillInjection.test.ts`

**Testing Framework:** Bun test + @testing-library/react

**Test Focus:**
- **Hook functionality:** Pill creation and injection
- **Value formatting:** Different data types
- **Lexical state:** Verify editor state after injection
- **Cursor positioning:** Cursor at correct position
- **Trailing space:** textNode with single space after created pillNode
- **Edge cases:** Empty editor, missing space, null values

**Testing Approach:**

```typescript
import { renderHook } from '@testing-library/react'
import { createTestEditor } from '@lexical/test-utils'
import { usePillInjection } from './usePillInjection'

describe('usePillInjection', () => {
  let editor: LexicalEditor

  beforeEach(() => {
    editor = createTestEditor()
  })

  it('should inject pill at end of text', () => {
    const { result } = renderHook(() => usePillInjection(editor))

    // Add some text first
    editor.update(() => {
      const root = $getRoot()
      const paragraph = $createParagraphNode()
      paragraph.append($createTextNode('Test text'))
      root.append(paragraph)
    })

    // Inject pill
    result.current.injectPill('ownsHome', false)

    // Verify pill exists
    editor.getEditorState().read(() => {
      const root = $getRoot()
      const paragraph = root.getFirstChild() as ParagraphNode
      const children = paragraph.getChildren()

      // Should have: TextNode + TextNode(space) + PillNode
      expect(children.length).toBe(3)
      expect(children[2]?.getType()).toBe('pill')
    })
  })

  // ...more tests
})
```

**Coverage Requirements:** >90% code coverage

### Technical Constraints

**Lexical Editor Access:**
- Must be within LexicalComposerContext
- Use `useLexicalComposerContext()` hook to get editor instance
- All mutations must be inside `editor.update()` callback

**Pill Creation:**
- Always use `$createPillNode()` factory function
- Always set `validation: 'valid'` for converted fields
- Format values as strings before creating pill

**TypeScript:**
- Strict mode enabled
- Handle editor being null/undefined
- Proper type guards for Lexical nodes

**Performance:**
- Pill injection is synchronous (no async operations)
- State updates should batch to avoid multiple re-renders
- Use `useCallback` to memoize injection function

**No External Dependencies:**
All functionality uses existing Lexical, React, and TypeScript. No new npm packages required.

### Success Criteria

After this story is complete:
1. usePillInjection hook exists and is fully tested
2. [Save Known] button injects pill correctly
3. Pill appears at end of notes with correct format
4. Pill styled as green valid pill
5. Space added before pill if needed
6. Cursor positioned after pill
7. Field removed from inferred section
8. Field updated in sidebar with normal styling
9. Story 4.6 (Sidebar Styling) can integrate with this state management

### Example Usage

**Scenario:** Broker converts "Owns Home: No (75%)" to known field

**Before:**
- Notes: "Client needs renters in FL. Age 28. [state:FL] [productType:renters] [age:28]"
- Inferred section: Shows "Owns Home: No (75%)"
- Sidebar: Shows "Owns Home: No (75%)" in muted color with [✕]

**User Action:**
1. Click [Click] on "Owns Home" in inferred section
2. Modal opens with 3 buttons
3. Click [Save Known]

**After:**
- Notes: "Client needs renters in FL. Age 28. [state:FL] [productType:renters] [age:28] [ownsHome:false]" ← **NEW PILL**
- Inferred section: "Owns Home" removed
- Sidebar: Shows "Owns Home: No" in normal color without [✕]
- Cursor: Positioned after [ownsHome:false] pill

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-11-14 | 1.0 | Initial story creation | Scrum Master (Bob) |

## Dev Agent Record

### Agent Model Used

claude-sonnet-4-5-20250929

### Debug Log References

No debug log entries required - implementation completed without issues.

### Completion Notes List

- Created usePillInjection hook with pill injection logic
- Integrated pill injection with [Save Known] button in FieldModal
- Extended KeyValueEditor editorRef to expose getEditor() method
- Updated all components using editorRef to include new getEditor method
- Created comprehensive test suite (21 tests, all passing)
- Verified TypeScript compilation (all packages compile successfully)
- Verified linting (biome check passes)
- Implementation follows story requirements exactly

### File List

**New Files:**
- apps/web/src/hooks/usePillInjection.ts
- apps/web/src/hooks/usePillInjection.test.ts

**Modified Files:**
- apps/web/src/components/shortcuts/FieldModal.tsx
- apps/web/src/components/notes/NotesPanel.tsx
- apps/web/src/components/shared/KeyValueEditor.tsx
- apps/web/src/components/policy/UploadPanel.tsx
- apps/web/src/components/intake/UnifiedChatInterface.tsx
- apps/web/src/components/layout/HomeScreen.tsx

## QA Results

(To be populated by QA Agent after implementation)
