# Story 1.3: Knowledge Pack Loader & In-Memory Cache

## Status
Ready for Review

## Story
**As a** backend system,  
**I want** to load all knowledge pack JSON files into memory at startup,  
**so that** I can quickly query carrier/state/product rules without filesystem I/O during runtime.

## Acceptance Criteria

1. Hono backend starts at `localhost:7070` with startup logging
2. On startup, asynchronously load all JSON files from `knowledge-pack/` directory into in-memory Map structures
3. Knowledge pack includes carriers (3), states (5), products (Auto/Home/Renters/Umbrella), discounts, eligibility rules, and compensation data
4. Startup completes successfully even if knowledge pack loading is still in progress (non-blocking)
5. Health check endpoint `/api/health` returns knowledge pack status (loaded/loading/error)
6. Logging includes count of loaded entities (e.g., "Loaded 3 carriers, 5 states, 12 products, 47 discounts")
7. Error handling for missing or malformed JSON files with graceful degradation
8. No runtime filesystem reads after initial load (validated via decision trace logs)

## Tasks / Subtasks

- [x] **Task 1: Setup Knowledge Pack Directory Structure** (AC: 3)
  - [x] Verify `knowledge_pack/` directory exists at project root
  - [x] Ensure directory structure matches architecture: `knowledge_pack/carriers/` and `knowledge_pack/states/`
  - [x] Verify carrier files exist: `geico.json`, `progressive.json`, `state-farm.json`
  - [x] Verify state files exist: `CA.json`, `TX.json`, `FL.json`, `NY.json`, `IL.json`
  - [x] Document expected file structure in code comments

- [x] **Task 2: Create Knowledge Pack Loader Service** (AC: 2, 4)
  - [x] Create `apps/api/src/services/knowledge-pack-loader.ts` service module
  - [x] Implement async file loading function that reads all JSON files from `knowledge_pack/` directory
  - [x] Use Node.js `fs/promises` for async file operations
  - [x] Load files concurrently using `Promise.all()` for performance
  - [x] Ensure loading is non-blocking (server can start before loading completes)
  - [x] Track loading state: `loading`, `loaded`, `error`

- [x] **Task 3: Implement In-Memory Map Storage** (AC: 2, 8)
  - [x] Create Map structures for carriers: `Map<string, Carrier>` keyed by carrier name
  - [x] Create Map structures for states: `Map<string, State>` keyed by state code
  - [x] Store loaded data in module-level variables (singleton pattern)
  - [x] Ensure Maps are typed using Carrier and State schemas from `@repo/shared`
  - [x] Document that Maps are read-only after initial load (no runtime writes)

- [x] **Task 4: Add Startup Logging** (AC: 1, 6)
  - [x] Log server startup with timestamp: "Starting Hono API server at localhost:7070"
  - [x] Log knowledge pack loading start: "Loading knowledge pack from knowledge_pack/..."
  - [x] Log successful load with entity counts: "Loaded 3 carriers, 5 states, 12 products, 47 discounts"
  - [x] Use structured logging format matching program log schema (JSON)
  - [x] Log to console (dev) and `logs/program.log` file

- [x] **Task 5: Implement Error Handling** (AC: 7)
  - [x] Handle missing files gracefully (log warning, continue with available data)
  - [x] Handle malformed JSON files (log error with filename, skip file, continue)
  - [x] Validate JSON structure against expected schemas (carrier-schema.json, state-schema.json)
  - [x] Track which files failed to load in loading state
  - [x] Ensure server still starts even if some files fail (graceful degradation)

- [x] **Task 6: Update Health Check Endpoint** (AC: 5)
  - [x] Modify `/api/health` endpoint to include knowledge pack status
  - [x] Return `knowledgePackLoaded: boolean` (true if loaded, false if loading/error)
  - [x] Return `knowledgePackStatus: 'loaded' | 'loading' | 'error'`
  - [x] Return `carriersCount: number` (count of successfully loaded carriers)
  - [x] Return `statesCount: number` (count of successfully loaded states)
  - [x] Include timestamp in health response

- [x] **Task 7: Create Knowledge Pack RAG Service Interface** (AC: 8)
  - [x] Create `apps/api/src/services/knowledge-pack-rag.ts` service module
  - [x] Implement query functions that read from in-memory Maps (no filesystem access)
  - [x] Create `getCarrier(name: string): Carrier | undefined` function
  - [x] Create `getState(code: string): State | undefined` function
  - [x] Ensure all query functions use Maps only (no `fs.readFile` calls)
  - [x] Document that RAG service is read-only (queries only, no writes)

- [x] **Task 8: Add Unit Tests** (AC: 2, 7, 8)
  - [x] Create `apps/api/src/services/__tests__/knowledge-pack-loader.test.ts`
  - [x] Test successful loading of all files
  - [x] Test graceful handling of missing files
  - [x] Test graceful handling of malformed JSON
  - [x] Test non-blocking startup (server responds before loading completes)
  - [x] Test that RAG service queries Maps only (no filesystem calls)
  - [x] Use Bun test framework with Jest-compatible API

- [x] **Task 9: Integration Test for Health Endpoint** (AC: 5)
  - [x] Create `apps/api/src/routes/__tests__/health.test.ts`
  - [x] Test `/api/health` returns correct knowledge pack status
  - [x] Test status changes from 'loading' to 'loaded' after initialization
  - [x] Test error status when files are missing
  - [x] Use Hono test utilities (no server required)

- [x] **Task 10: Update Backend Startup** (AC: 1, 4)
  - [x] Modify `apps/api/src/index.ts` to call knowledge pack loader on startup
  - [x] Ensure loader is called before routes are registered
  - [x] Ensure server starts even if loading is in progress (non-blocking)
  - [x] Add startup logging for server initialization
  - [x] Export AppType for Hono RPC client (already done in Story 1.2)

## Dev Notes

### Previous Story Insights
- Story 1.2 completed: React frontend initialized, TanStack Router configured, Hono RPC client prepared with AppType placeholder
- Backend currently has minimal `/api/health` endpoint that needs enhancement
- No knowledge pack loading infrastructure exists yet - this is the foundation for all routing/discount/compliance logic

### Data Models
- **Carrier Schema**: Defined in `knowledge_pack/carriers/{carrier-name}.json` with structure: `name`, `operatesIn` (array of state codes), `products` (array), `eligibility` (product-specific rules), `discounts` (array with requirements and percentages), `compensation` (optional broker commission) [Source: architecture/4-data-models.md#43-carrier]
- **State Schema**: Defined in `knowledge_pack/states/{state-code}.json` with minimum insurance requirements [Source: architecture/4-data-models.md]
- **cuid2-based IDs**: All entities use cuid2 IDs for citation tracking (see `docs/knowledge-pack/id-conventions.md`) [Source: architecture/4-data-models.md#43-carrier]
- **Type Definitions**: Carrier and State types should be imported from `@repo/shared` schemas (Zod schemas with inferred TypeScript types) [Source: architecture/4-data-models.md#41-core-data-models-overview]

### API Specifications
- **Health Endpoint**: GET `/api/health` must return `knowledgePackLoaded: boolean`, `knowledgePackStatus: 'loaded' | 'loading' | 'error'`, `carriersCount: number`, `statesCount: number`, `timestamp: string` [Source: architecture/5-api-specification.md#get-apihealth]
- **Base URL**: `http://localhost:7070/api` [Source: architecture/5-api-specification.md]
- **Response Format**: JSON with snake_case keys (auto-transformed from camelCase TypeScript types) [Source: architecture/5-api-specification.md]

### Component Specifications
- **Knowledge Pack RAG**: Component responsible for loading carrier/state JSON files at startup (async, non-blocking) into memory Maps, tracking cuid2 IDs for citation generation, providing exact key-based queries (carrier + state + product), returning results with file path + cuid2 ID [Source: architecture/6-components.md#66-knowledge-pack-rag-structured-query]
- **Startup Loading Pattern**: Knowledge pack loaded during initialization ensures data is immediately available for all queries, while async loading prevents blocking container startup [Source: architecture/6-components.md#66-knowledge-pack-rag-structured-query]
- **Structured Queries**: Known keys (carrier, state, product) make exact queries faster and more accurate than vector embeddings [Source: architecture/6-components.md#66-knowledge-pack-rag-structured-query]
- **Citation Tracking**: cuid2-based IDs attached to every entity, enabling audit trail without line number fragility [Source: architecture/6-components.md#66-knowledge-pack-rag-structured-query]

### File Locations
- **Knowledge Pack Directory**: `knowledge_pack/` at project root (not in apps/) [Source: architecture/12-unified-project-structure.md]
- **Service Layer**: Create services in `apps/api/src/services/` directory [Source: architecture/11-backend-architecture.md#111-service-layer-architecture]
- **Route Handlers**: Routes in `apps/api/src/index.ts` (thin layer, HTTP concerns only) [Source: architecture/11-backend-architecture.md#111-service-layer-architecture]
- **Test Files**: Unit tests in `apps/api/src/services/__tests__/`, integration tests in `apps/api/src/routes/__tests__/` [Source: architecture/16-testing-strategy.md]

### Testing Requirements
- **Testing Framework**: Use Bun test (built-in, Jest-compatible API) [Source: architecture/16-testing-strategy.md#162-testing-tools]
- **Unit Tests**: Test deterministic logic (loader, RAG queries) with 100% coverage goal [Source: architecture/16-testing-strategy.md#163-testing-focus-areas]
- **Integration Tests**: Test API routes with Hono test utilities (no server required) [Source: architecture/16-testing-strategy.md#162-testing-tools]
- **Test Focus**: Test successful loading, error handling, non-blocking startup, no runtime filesystem reads [Source: architecture/16-testing-strategy.md#163-testing-focus-areas]

### Technical Constraints
- **Backend Framework**: Hono 4.0 with TypeScript 5.6 [Source: architecture/3-tech-stack.md#31-technology-stack-table]
- **File Operations**: Use Node.js `fs/promises` for async file operations [Source: architecture/3-tech-stack.md]
- **Logging Strategy**: Two separate log streams: program log (`logs/program.log`) for API requests/debug info, compliance log (`logs/compliance.log`) for DecisionTrace objects [Source: architecture/3-tech-stack.md#32-critical-configuration]
- **Log Format**: Structured JSON logging with `level`, `timestamp`, `type`, and relevant fields [Source: architecture/3-tech-stack.md#32-critical-configuration]
- **No Database**: JSON files as knowledge pack (no database setup required) [Source: architecture/9-database-schema.md]
- **In-Memory Cache**: Map structures loaded at startup, no runtime filesystem reads [Source: architecture/3-tech-stack.md#31-technology-stack-table]

### Project Structure Notes
- Knowledge pack directory at root level (`knowledge_pack/`) aligns with architecture: "Data is separate from code, easy to update without touching application code" [Source: architecture/12-unified-project-structure.md]
- Service layer pattern: Business logic in `services/`, routes are thin HTTP layer [Source: architecture/11-backend-architecture.md#111-service-layer-architecture]
- Three-layer pattern: Routes (HTTP) → Services (business logic) → Data (knowledge pack RAG) [Source: architecture/11-backend-architecture.md#111-service-layer-architecture]

## Testing

### Test File Location
- Unit tests: `apps/api/src/services/__tests__/knowledge-pack-loader.test.ts`
- Integration tests: `apps/api/src/routes/__tests__/health.test.ts`

### Test Standards
- Use Bun test framework (Jest-compatible API: `describe`, `it`, `expect`) [Source: architecture/16-testing-strategy.md#162-testing-tools]
- Test deterministic logic with 100% coverage goal [Source: architecture/16-testing-strategy.md#163-testing-focus-areas]
- Use Hono test utilities for API route testing (no server required) [Source: architecture/16-testing-strategy.md#162-testing-tools]

### Testing Focus Areas
- Successful loading of all knowledge pack files
- Graceful error handling for missing/malformed files
- Non-blocking startup (server responds before loading completes)
- No runtime filesystem reads (RAG queries Maps only)
- Health endpoint returns correct knowledge pack status

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-27 | 1.0 | Initial story creation | Bob (Scrum Master) |
| 2025-11-10 | 1.1 | Story implementation complete - knowledge pack loader with in-memory cache, RAG service, health endpoint, and comprehensive tests | James (Developer) |

## Dev Agent Record

### Agent Model Used
Claude Sonnet 4.5 (via Cursor Composer)

### Debug Log References
N/A - All tests passing, no debugging required

### Completion Notes
**All 10 tasks completed successfully:**

1. **Task 1:** Generated mock knowledge pack files (3 carriers, 5 states) using `scripts/generate-mock-knowledge-pack.ts`. All files follow JSON schema structure with cuid2 IDs, source metadata, and field metadata.

2. **Task 2:** Created `knowledge-pack-loader.ts` service with async file loading, concurrent loading via `Promise.all()`, and non-blocking startup support.

3. **Task 3:** Implemented in-memory `Map<string, Carrier>` and `Map<string, State>` storage with singleton pattern. Maps are read-only after initial load.

4. **Task 4:** Added structured JSON logging to console and `logs/program.log` file. Logs server startup, loading start, and completion with entity counts.

5. **Task 5:** Implemented graceful error handling for missing/malformed files. Server starts even if some files fail. Errors tracked in loading status.

6. **Task 6:** Updated `/api/health` endpoint to return `knowledgePackLoaded`, `knowledgePackStatus`, `carriersCount`, `statesCount`, and `timestamp`.

7. **Task 7:** Created `knowledge-pack-rag.ts` service with read-only query functions (`getCarrierByName`, `getStateByCode`, `getCarriersForState`, etc.). All queries use in-memory Maps only.

8. **Task 8:** Added comprehensive unit tests (8 tests) covering successful loading, error handling, non-blocking startup, and RAG service Map-only queries. All tests passing.

9. **Task 9:** Added integration tests (4 tests) for health endpoint covering status responses, loading states, and error scenarios. All tests passing.

10. **Task 10:** Updated `index.ts` to initialize knowledge pack loading on startup (non-blocking). Added startup logging. Exported `AppType` for Hono RPC client.

**Implementation Details:**
- Created TypeScript types in `packages/shared/src/schemas/knowledge-pack.ts` for Carrier and State entities
- Path resolution handles both monorepo root and `apps/api` directory execution contexts
- All Node.js imports use `node:` protocol per Biome linting rules
- Tests use Bun test framework with Jest-compatible API
- Integration tests use Hono test utilities (no server required)

**Verification:**
- ✅ Server starts successfully at `localhost:7070`
- ✅ Knowledge pack loads: 3 carriers, 5 states, 12 products, 15 discounts
- ✅ Health endpoint returns correct status
- ✅ All 12 tests passing (8 unit + 4 integration)
- ✅ Type checking passes
- ✅ Linting and formatting pass

### File List
**Created:**
- `packages/shared/src/schemas/knowledge-pack.ts` - TypeScript type definitions for Carrier and State
- `apps/api/src/services/knowledge-pack-loader.ts` - Knowledge pack loader service
- `apps/api/src/services/knowledge-pack-rag.ts` - RAG service interface
- `apps/api/src/utils/logger.ts` - Structured logging utility
- `apps/api/src/services/__tests__/knowledge-pack-loader.test.ts` - Unit tests (8 tests)
- `apps/api/src/routes/__tests__/health.test.ts` - Integration tests (4 tests)
- `scripts/generate-mock-knowledge-pack.ts` - Script to generate mock knowledge pack files
- `knowledge_pack/carriers/geico.json` - Mock GEICO carrier data
- `knowledge_pack/carriers/progressive.json` - Mock Progressive carrier data
- `knowledge_pack/carriers/state-farm.json` - Mock State Farm carrier data
- `knowledge_pack/states/CA.json` - Mock California state data
- `knowledge_pack/states/TX.json` - Mock Texas state data
- `knowledge_pack/states/FL.json` - Mock Florida state data
- `knowledge_pack/states/NY.json` - Mock New York state data
- `knowledge_pack/states/IL.json` - Mock Illinois state data

**Modified:**
- `packages/shared/src/index.ts` - Exported knowledge pack types
- `apps/api/src/index.ts` - Added knowledge pack loading on startup, updated health endpoint
- `apps/api/package.json` - Added `test` script

## QA Results
_To be populated by QA Agent_

