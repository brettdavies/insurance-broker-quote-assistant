# Story 4.2: Implement Deterministic Inference Engine

## Status

Ready for Review

## Story

**As a** developer,
**I want** an InferenceEngine class that applies deterministic inference rules to known fields and text patterns,
**so that** the backend can derive inferred fields from known fields while respecting the suppression list.

## Acceptance Criteria

1. `packages/shared/src/services/inference-engine.ts` created
2. `InferenceEngine` class implemented with `applyInferences()` method
3. Field-to-field inferences work (productType → ownsHome)
4. Text pattern inferences work ("lives alone" → householdSize)
5. Suppression list respected (skips suppressed fields)
6. Returns inference reasons and confidence scores
7. All unit tests pass (>90% coverage)

## Tasks / Subtasks

- [x] **Task 1: Create InferenceEngine class structure** (AC: 1, 2)
  - [x] Create `packages/shared/src/services/` directory if it doesn't exist
  - [x] Create `inference-engine.ts` file
  - [x] Define `InferenceEngine` class with constructor accepting:
    - [x] `fieldInferences: Record<string, InferenceRule[]>` - Field-to-field inference rules from metadata
    - [x] `textPatternInferences: TextPatternInference[]` - Text pattern inferences from config
    - [x] `suppressedFields: string[]` - Fields user has explicitly dismissed
  - [x] Define `InferenceResult` interface with:
    - [x] `inferred: Partial<UserProfile>` - Inferred field values
    - [x] `reasons: Record<string, string>` - Inference reasoning for each field
    - [x] `confidence: Record<string, number>` - Confidence scores (0-1 scale)
  - [x] Add comprehensive JSDoc comments explaining inference engine purpose and usage

- [x] **Task 2: Implement applyInferences() method** (AC: 2, 3, 4, 5, 6)
  - [x] Define method signature: `applyInferences(knownFields: Partial<UserProfile>, inputText: string): InferenceResult`
  - [x] Initialize result objects: `inferred = {}`, `reasons = {}`, `confidence = {}`
  - [x] Implement Step 1: Field-to-field inferences
    - [x] Loop through each known field
    - [x] Check if field has inference rules in metadata
    - [x] For each rule, check if targetField is already known or suppressed
    - [x] Apply inferValue function to source field value
    - [x] Store inferred value, reason, and confidence
  - [x] Implement Step 2: Text pattern inferences
    - [x] Loop through each text pattern
    - [x] Match pattern against inputText
    - [x] For each match, check if field is already known/inferred/suppressed
    - [x] Handle capture group references ("$1", "$2", etc.)
    - [x] Store inferred value, reason, and confidence
  - [x] Return InferenceResult with all inferred fields

- [x] **Task 3: Implement confidence level conversion** (AC: 6)
  - [x] Create private method `confidenceToNumber(level: 'high' | 'medium' | 'low'): number`
  - [x] Map 'high' → 0.85
  - [x] Map 'medium' → 0.70
  - [x] Map 'low' → 0.50
  - [x] Add JSDoc explaining confidence scale alignment with LLM upgrade threshold (≥85%)

- [x] **Task 4: Implement capture group replacement** (AC: 4)
  - [x] Create private method `replaceCaptureGroups(value: any, match: RegExpMatchArray): any`
  - [x] Handle string values starting with "$N" (e.g., "$1")
  - [x] Extract capture group index from string
  - [x] Replace with actual matched text from capture group
  - [x] Handle edge cases: invalid capture group index, missing capture group
  - [x] Return processed value

- [x] **Task 5: Add comprehensive unit tests** (AC: 7)
  - [x] Create `packages/shared/src/services/inference-engine.test.ts`
  - [x] **Field-to-field inference tests:**
    - [x] Test: productType="renters" → infers ownsHome=false
    - [x] Test: productType="home" → infers ownsHome=true
    - [x] Test: productType="auto" → does not infer ownsHome
    - [x] Test: ownsHome already known → does not infer
    - [x] Test: ownsHome suppressed → does not infer
  - [x] **Text pattern inference tests:**
    - [x] Test: "lives alone" → infers householdSize=1
    - [x] Test: "family of 4" → infers householdSize=4 (capture group)
    - [x] Test: "clean record" → infers cleanRecord3Yr=true
    - [x] Test: Pattern match but field already known → does not infer
    - [x] Test: Pattern match but field suppressed → does not infer
  - [x] **Confidence score tests:**
    - [x] Test: High confidence → 0.85
    - [x] Test: Medium confidence → 0.70
    - [x] Test: Low confidence → 0.50
  - [x] **Reasoning tests:**
    - [x] Test: Inference includes reasoning from config
    - [x] Test: Reasoning matches expected text
  - [x] **Edge case tests:**
    - [x] Test: Empty known fields → no field-to-field inferences
    - [x] Test: Empty input text → no text pattern inferences
    - [x] Test: All fields suppressed → no inferences
    - [x] Test: Invalid capture group reference → handles gracefully
  - [x] Run tests: `bun test packages/shared/src/services/inference-engine.test.ts`
  - [x] Verify >90% code coverage using Bun's built-in coverage tool

- [x] **Task 6: Verify TypeScript compilation** (AC: 2)
  - [x] Run `bun run type-check` in root directory
  - [x] Verify no compilation errors in shared package
  - [x] Verify `InferenceEngine` is properly exported and importable
  - [x] Verify `InferenceResult` interface is correctly exported
  - [x] Fix any type errors

- [x] **Task 7: Create integration test with actual config** (AC: 3, 4)
  - [x] Add integration test to `inference-engine.test.ts`
  - [x] Import `TEXT_PATTERN_INFERENCES` from config
  - [x] Import field metadata and extract inference rules
  - [x] Create InferenceEngine with real config
  - [x] Test realistic scenario: "FL renters. Age 28. Lives alone."
    - [x] Known: state="FL", productType="renters", age=28
    - [x] Expected inferred: ownsHome=false, householdSize=1
    - [x] Verify both field-to-field and text pattern inferences work together
  - [x] Verify inference reasons and confidence scores are populated

## Dev Notes

This story implements the core inference engine for the **known vs inferred pills architecture** (Epic 4: Field Extraction Bulletproofing). The InferenceEngine applies deterministic rules to derive additional fields from known fields and text patterns, enabling the backend to distinguish between explicit extractions and inferred values.

**Context from Previous Story:**

Story 4.1 created the config infrastructure:
- `TEXT_PATTERN_INFERENCES` array with 6 POC patterns (lives alone, family of N, clean record variants, own home)
- `InferenceRule` interface for field-to-field inferences
- `productType` field has inference rule: renters → ownsHome=false, home → ownsHome=true

This story consumes those config files to implement the actual inference logic.

**Architecture References:**

[Source: docs/architecture/field-extraction-bulletproofing.md]

### Inference Engine Architecture

**Location:** `packages/shared/src/services/inference-engine.ts` (new file)

**Purpose:** Apply deterministic inference rules to known fields [Source: field-extraction-bulletproofing.md#5.2]

**Class Structure:**

```typescript
export class InferenceEngine {
  constructor(
    private fieldInferences: Record<string, InferenceRule[]>, // from unified-field-metadata
    private textPatternInferences: TextPatternInference[], // from config
    private suppressedFields: string[] // from request
  ) {}

  /**
   * Apply all inference rules to known fields and text
   * Returns: { inferred, reasons, confidence }
   */
  applyInferences(
    knownFields: Partial<UserProfile>,
    inputText: string
  ): InferenceResult {
    const inferred: Partial<UserProfile> = {}
    const reasons: Record<string, string> = {}
    const confidence: Record<string, number> = {}

    // Step 1: Field-to-field inferences (from known fields)
    // Step 2: Text pattern inferences (from input text)

    return { inferred, reasons, confidence }
  }

  private confidenceToNumber(level: 'high' | 'medium' | 'low'): number {
    // Maps confidence levels to numeric scores
  }
}
```

[Source: field-extraction-bulletproofing.md#577-656]

### Inference Flow Implementation

**Step 1: Field-to-Field Inferences** [Source: field-extraction-bulletproofing.md#603-620]

```typescript
// Loop through known fields
for (const [fieldName, fieldValue] of Object.entries(knownFields)) {
  const metadata = this.fieldInferences[fieldName]
  if (!metadata?.infers) continue

  for (const rule of metadata.infers) {
    // Skip if target field already known or suppressed
    if (knownFields[rule.targetField] !== undefined) continue
    if (this.suppressedFields.includes(rule.targetField)) continue

    const inferredValue = rule.inferValue(fieldValue)
    if (inferredValue !== undefined) {
      inferred[rule.targetField] = inferredValue
      reasons[rule.targetField] = rule.reasoning
      confidence[rule.targetField] = this.confidenceToNumber(rule.confidence)
    }
  }
}
```

**Step 2: Text Pattern Inferences** [Source: field-extraction-bulletproofing.md#622-644]

```typescript
// Loop through text patterns
for (const pattern of this.textPatternInferences) {
  const match = inputText.match(pattern.pattern)
  if (!match) continue

  for (const inference of pattern.infers) {
    // Skip if field already known or suppressed
    if (knownFields[inference.field] !== undefined) continue
    if (inferred[inference.field] !== undefined) continue // Already inferred from field-to-field
    if (this.suppressedFields.includes(inference.field)) continue

    // Handle capture group references (e.g., "$2" means capture group 2)
    let value = inference.value
    if (typeof value === 'string' && value.startsWith('$')) {
      const captureGroupIndex = parseInt(value.substring(1))
      value = match[captureGroupIndex]
    }

    inferred[inference.field] = value
    reasons[inference.field] = inference.reasoning
    confidence[inference.field] = this.confidenceToNumber(inference.confidence)
  }
}
```

**Confidence Level Mapping** [Source: field-extraction-bulletproofing.md#649-655]

Maps string levels to numeric scores for API response:
- `'high'` → 0.85 (≥85% threshold allows LLM to upgrade inferred → known)
- `'medium'` → 0.70
- `'low'` → 0.50

### Key Design Decisions

**Suppression List Priority:** [Source: field-extraction-bulletproofing.md#722-779]

The suppression list takes precedence over all inferences:
1. User dismisses inferred field → added to suppression list
2. Next API call includes suppressedFields array
3. InferenceEngine skips generating that inference
4. User can override by explicitly providing value (converts to known field)

**Inference Priority:** [Source: field-extraction-bulletproofing.md#603-644]

1. Field-to-field inferences run first (from known fields)
2. Text pattern inferences run second (from input text)
3. Already-inferred fields from step 1 are not overwritten by step 2

This ensures field-to-field inferences (higher confidence, based on structured data) take precedence over text patterns (lower confidence, based on natural language).

**Capture Group Handling:** [Source: field-extraction-bulletproofing.md#633-638]

- Value "$N" references capture group N from regex match
- Example: pattern `/family of (\d+)/i` with value "$1" → extracts "4" from "family of 4"
- Invalid capture group index → returns undefined (no inference)

### Project Structure Notes

[Source: architecture/12-unified-project-structure.md]

**Shared Package Structure:**
```
packages/shared/src/
├── services/                # NEW: Service layer for business logic
│   └── inference-engine.ts
├── config/
│   └── text-pattern-inferences.ts  # IMPORT: Pattern config (Story 4.1)
└── schemas/
    └── unified-field-metadata.ts   # IMPORT: Field inference rules (Story 4.1)
```

**Why services/ directory:**
- InferenceEngine is business logic, not a utility
- Service classes encapsulate complex operations with state
- Follows standard layered architecture pattern
- Backend will import from `@repo/shared` (Story 4.8)

### Testing

[Source: architecture/16-testing-strategy.md]

**Test File Location:** `packages/shared/src/services/inference-engine.test.ts`

**Testing Framework:** Bun test (Jest-compatible API)

**Test Focus:** [Source: architecture/16-testing-strategy.md#16.3]
- **Deterministic engines are critical**: 100% coverage goal
- **Pure functions, predictable outputs**: Easy to test
- Focus on edge cases: empty inputs, suppression, already-known fields

**Test Organization:**
```typescript
describe('InferenceEngine', () => {
  describe('Field-to-field inferences', () => {
    // productType → ownsHome tests
  })

  describe('Text pattern inferences', () => {
    // Pattern matching tests with capture groups
  })

  describe('Suppression list', () => {
    // Verify suppressed fields are skipped
  })

  describe('Confidence levels', () => {
    // Verify confidence score mapping
  })

  describe('Integration with real config', () => {
    // End-to-end test with actual config files
  })
})
```

**Coverage Requirements:** >90% code coverage [Source: architecture/16-testing-strategy.md#16.3]

Use Bun's built-in coverage tool:
```bash
bun test --coverage packages/shared/src/services/inference-engine.test.ts
```

### Technical Constraints

**TypeScript Strict Mode:** [Source: Story 4.1 Dev Notes]
- Handle `noUncheckedIndexedAccess: true` with type guards
- Use optional chaining for capture group access: `match[captureGroupIndex]`
- Validate array bounds before accessing

**Regex Match Handling:**
```typescript
const match = inputText.match(pattern.pattern)
if (!match) continue // No match

// Access capture groups safely
const captureGroupIndex = parseInt(value.substring(1))
if (captureGroupIndex >= match.length) {
  // Invalid capture group - skip inference
  continue
}
value = match[captureGroupIndex]
```

**Intentional `any` Types:** [Source: Story 4.1 Dev Notes]
- `inferValue: (sourceValue: any) => any` is intentional (generic inference function)
- Add `// biome-ignore lint/suspicious/noExplicitAny: Generic inference function accepts any source value type` comment

**No External Dependencies:**
All functionality uses existing TypeScript and shared package utilities. No new npm packages required.

### Integration Points

**Backend Integration (Story 4.8):** [Source: field-extraction-bulletproofing.md#1087-1155]

Backend will use InferenceEngine like this:
```typescript
import { InferenceEngine } from '@repo/shared'

// Load config (Story 4.8)
const { fieldInferences, textPatternInferences } = loadInferenceConfig()

// Create engine with suppression list from request
const engine = new InferenceEngine(
  fieldInferences,
  textPatternInferences,
  request.suppressedFields || []
)

// Apply inferences
const { inferred, reasons, confidence } = engine.applyInferences(
  request.knownFields,
  request.message
)
```

**Frontend Integration (Story 4.7):** [Source: field-extraction-bulletproofing.md#992-1085]

Frontend pill parser will also use InferenceEngine for client-side inference preview (future optimization).

### Success Criteria

After this story is complete:
1. InferenceEngine class exists and is fully tested
2. Field-to-field inferences work (productType → ownsHome)
3. Text pattern inferences work (all 6 patterns from Story 4.1)
4. Suppression list correctly prevents unwanted inferences
5. Confidence scores correctly mapped to numeric values
6. >90% test coverage achieved
7. Story 4.8 (Backend Integration) can import and use InferenceEngine

### Example Usage

**Scenario:** User types "FL renters. Age 28. Lives alone."

**Input:**
```typescript
const knownFields = {
  state: 'FL',
  productType: 'renters',
  age: 28
}
const inputText = 'FL renters. Age 28. Lives alone.'
const suppressedFields = []

const engine = new InferenceEngine(fieldInferences, textPatternInferences, suppressedFields)
const result = engine.applyInferences(knownFields, inputText)
```

**Expected Output:**
```typescript
{
  inferred: {
    ownsHome: false,      // From productType="renters" field-to-field inference
    householdSize: 1      // From "lives alone" text pattern inference
  },
  reasons: {
    ownsHome: 'Renters insurance implies tenant status; home insurance implies ownership',
    householdSize: 'Lives alone implies household size of 1 (inferred from text pattern)'
  },
  confidence: {
    ownsHome: 0.85,       // High confidence (field-to-field)
    householdSize: 0.70   // Medium confidence (text pattern)
  }
}
```

**With Suppression:**
```typescript
const suppressedFields = ['householdSize']
const result = engine.applyInferences(knownFields, inputText)

// Output: Only ownsHome inferred, householdSize skipped
{
  inferred: {
    ownsHome: false
  },
  reasons: {
    ownsHome: 'Renters insurance implies tenant status; home insurance implies ownership'
  },
  confidence: {
    ownsHome: 0.85
  }
}
```

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-11-13 | 1.0 | Initial story creation | Scrum Master (Bob) |
| 2025-11-14 | 1.1 | Implementation complete - All tasks finished, 100% test coverage, Ready for Review | Dev Agent (James) |

## Dev Agent Record

### Agent Model Used

claude-sonnet-4-5-20250929

### Debug Log References

None - No blockers encountered during implementation.

### Completion Notes List

- Successfully implemented InferenceEngine class with full support for field-to-field and text pattern inferences
- Achieved 100% test coverage (27 tests, 70 assertions, all passing)
- All TypeScript compilation checks pass with no errors
- InferenceEngine, InferenceResult, and related types exported from packages/shared/src/index.ts
- Integration tests verify real-world scenarios with actual config from Story 4.1
- Field-to-field inferences correctly take precedence over text pattern inferences
- Suppression list functionality working as designed
- Capture group replacement handles edge cases (invalid indices, numeric conversion)
- Confidence level mapping aligns with LLM upgrade threshold (≥85% = high)

### File List

**New Files:**
- [packages/shared/src/services/inference-engine.ts](../../packages/shared/src/services/inference-engine.ts) - InferenceEngine class implementation
- [packages/shared/src/services/inference-engine.test.ts](../../packages/shared/src/services/inference-engine.test.ts) - Comprehensive unit tests (27 tests, 100% coverage)

**Modified Files:**
- [packages/shared/src/index.ts](../../packages/shared/src/index.ts) - Added exports for InferenceEngine, InferenceResult, InferenceRule, TEXT_PATTERN_INFERENCES, TextPatternInference

## QA Results

(To be populated by QA agent after implementation)
