name: Protect Main Branch

on:
  push:
    branches:
      - main

jobs:
  check-direct-commit:
    runs-on: ubuntu-latest
    steps:
      - name: Check if push is from PR merge
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            const sha = context.sha;

            console.log(`Checking commit ${sha} on ${owner}/${repo}`);

            // Get the commit details
            const commit = await github.rest.repos.getCommit({
              owner,
              repo,
              ref: sha
            });

            console.log(`Commit message: ${commit.data.commit.message}`);
            console.log(`Number of parents: ${commit.data.parents.length}`);

            // Check if this is a merge commit (has multiple parents)
            const isMergeCommit = commit.data.parents.length > 1;

            // Check if commit message indicates a PR merge
            const commitMessage = commit.data.commit.message;
            const isPRMerge = commitMessage.includes('Merge pull request') ||
                             commitMessage.match(/^Merge branch .* into main/) ||
                             commitMessage.includes('(#') && commitMessage.includes(')');

            // Try to find associated PR
            let associatedPR = null;
            try {
              const prs = await github.rest.repos.listPullRequestsAssociatedWithCommit({
                owner,
                repo,
                commit_sha: sha
              });

              associatedPR = prs.data.find(pr => pr.merged_at !== null);
              console.log(`Associated merged PR: ${associatedPR ? `#${associatedPR.number}` : 'none'}`);
            } catch (error) {
              console.log('Could not fetch associated PRs:', error.message);
            }

            // Determine if this is a valid push
            const isValid = isMergeCommit || isPRMerge || associatedPR;

            if (!isValid) {
              core.setFailed(
                '❌ Direct commits to main branch are not allowed!\n\n' +
                'Please follow these steps:\n' +
                '1. Create a feature branch: git checkout -b feature/your-feature\n' +
                '2. Make your changes and commit them\n' +
                '3. Push your branch: git push -u origin feature/your-feature\n' +
                '4. Create a Pull Request on GitHub\n' +
                '5. Merge the PR once approved\n\n' +
                'To fix this:\n' +
                '1. Revert this commit: git revert HEAD\n' +
                '2. Push the revert: git push origin main\n' +
                '3. Follow the proper PR workflow above'
              );
            } else {
              console.log('✅ Push is from a PR merge or valid merge commit');
            }
